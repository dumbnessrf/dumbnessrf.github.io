[{"content":"âœ… ä¼˜åŠ¿ æ’ä»¶ä¸ä¾èµ– MEF æˆ– DI å®¹å™¨ç»†èŠ‚ï¼› ä¸»ç¨‹åºå®Œå…¨æ§åˆ¶ä¼ å…¥çš„æœåŠ¡ï¼› æ˜“äºå•å…ƒæµ‹è¯•ï¼ˆå¯ mock IAnalyzerContextï¼‰ï¼› æ— æœåŠ¡å®šä½ï¼ˆService Locatorï¼‰åæ¨¡å¼ã€‚ ğŸ“ é¡¹ç›®ç»“æ„ï¼ˆå»¶ç»­ä¹‹å‰çš„æ¨¡æ¿ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 SharpBoxes.Host/ â”œâ”€â”€ Services/ â”‚ â”œâ”€â”€ Core/ â”‚ â”‚ â”œâ”€â”€ IHostLogger.cs â”‚ â”‚ â””â”€â”€ ConsoleLogger.cs â”‚ â””â”€â”€ Extensibility/ â”‚ â”œâ”€â”€ IAnalyzer.cs â”‚ â”œâ”€â”€ IAnalyzerContext.cs â† æ–°å¢ â”‚ â”œâ”€â”€ AnalyzerContext.cs â† æ–°å¢ â”‚ â””â”€â”€ PluginManager.cs â””â”€â”€ Plugins/ â””â”€â”€ ExamplePlugin.dll 1. å®šä¹‰ä¸Šä¸‹æ–‡æ¥å£ï¼ˆIAnalyzerContextï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // Services/Extensibility/IAnalyzerContext.cs using SharpBoxes.Host.Services.Core; namespace SharpBoxes.Host.Services.Extensibility { /// \u0026lt;summary\u0026gt; /// åˆ†æå™¨æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œç”±ä¸»ç¨‹åºæä¾›ï¼ŒåŒ…å«æ‰€éœ€æœåŠ¡ /// \u0026lt;/summary\u0026gt; public interface IAnalyzerContext { IHostLogger Logger { get; } string WorkingDirectory { get; } // å¯æ‰©å±•ï¼šIConfiguration, IFileService ç­‰ } } 2. å®ç°ä¸Šä¸‹æ–‡ï¼ˆAnalyzerContextï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // Services/Extensibility/AnalyzerContext.cs using SharpBoxes.Host.Services.Core; namespace SharpBoxes.Host.Services.Extensibility { /// \u0026lt;summary\u0026gt; /// ä¸Šä¸‹æ–‡å®ç°ï¼ˆç”±ä¸»ç¨‹åºåˆ›å»ºï¼‰ /// \u0026lt;/summary\u0026gt; public class AnalyzerContext : IAnalyzerContext { public IHostLoader Logger { get; } public string WorkingDirectory { get; } public AnalyzerContext(IHostLogger logger, string workingDirectory = null) { Logger = logger ?? throw new ArgumentNullException(nameof(logger)); WorkingDirectory = workingDirectory ?? Environment.CurrentDirectory; } } } 3. æ›´æ–°åˆ†æå™¨å¥‘çº¦ï¼ˆIAnalyzerï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 // Services/Extensibility/IAnalyzer.cs namespace SharpBoxes.Host.Services.Extensibility { public interface IAnalyzer { string Name { get; } /// \u0026lt;summary\u0026gt; /// åˆ†æä»£ç ï¼Œé€šè¿‡ä¸Šä¸‹æ–‡è·å–æœåŠ¡ /// \u0026lt;/summary\u0026gt; string Analyze(string code, IAnalyzerContext context); } } 4. æ’ä»¶å®ç°ï¼ˆæ— éœ€ä»»ä½• DI/MEF æœåŠ¡æ³¨å…¥ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // ExamplePlugin/MyAnalyzer.cs using System.ComponentModel.Composition; using SharpBoxes.Host.Services.Extensibility; namespace ExamplePlugin { [Export(typeof(IAnalyzer))] [ExportMetadata(\u0026#34;Name\u0026#34;, \u0026#34;Context-Based Analyzer\u0026#34;)] [ExportMetadata(\u0026#34;Version\u0026#34;, \u0026#34;1.0.0\u0026#34;)] [ExportMetadata(\u0026#34;Author\u0026#34;, \u0026#34;Zheng\u0026#34;)] [ExportMetadata(\u0026#34;Priority\u0026#34;, 80)] public class MyAnalyzer : IAnalyzer { public string Name =\u0026gt; \u0026#34;Context-Based Analyzer\u0026#34;; // âœ… ä¸éœ€è¦ [Import]ï¼Œä¸ä¾èµ– MEF æˆ– DI public string Analyze(string code, IAnalyzerContext context) { // ä½¿ç”¨ä¸Šä¸‹æ–‡ä¸­çš„æœåŠ¡ context.Logger.Info($\u0026#34;[MyAnalyzer] Starting analysis of {code.Length} chars\u0026#34;); // å¯è®¿é—®å·¥ä½œç›®å½•ç­‰ä¸Šä¸‹æ–‡ä¿¡æ¯ context.Logger.Info($\u0026#34;Working directory: {context.WorkingDirectory}\u0026#34;); return $\u0026#34;Analyzed by {Name}: \u0026#39;{code}\u0026#39; has {code.Length} characters.\u0026#34;; } } } âœ… æ’ä»¶å®Œå…¨è§£è€¦ï¼šåªéœ€å¼•ç”¨ IAnalyzer å’Œ IAnalyzerContextï¼ˆå¯æ”¾åœ¨å…±äº«å¥‘çº¦åº“ä¸­ï¼‰ã€‚\n5. PluginManagerï¼ˆæ— éœ€æ”¹åŠ¨ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // PluginManager.csï¼ˆä¿æŒä¹‹å‰å®ç°ï¼Œä¸å†éœ€è¦ä¼ å…¥ IServiceProviderï¼‰ using System.ComponentModel.Composition; using System.ComponentModel.Composition.Hosting; using System.Reflection; namespace SharpBoxes.Host.Services.Extensibility { public class PluginManager { private readonly CompositionContainer _container; public PluginManager(string pluginsDirectory = @\u0026#34;.\\Plugins\u0026#34;) { if (!Directory.Exists(pluginsDirectory)) Directory.CreateDirectory(pluginsDirectory); var catalog = new AggregateCatalog(); catalog.Catalogs.Add(new AssemblyCatalog(Assembly.GetExecutingAssembly())); catalog.Catalogs.Add(new DirectoryCatalog(pluginsDirectory, \u0026#34;*.dll\u0026#34;)); _container = new CompositionContainer(catalog); } public IEnumerable\u0026lt;Lazy\u0026lt;IAnalyzer, IAnalyzerMetadata\u0026gt;\u0026gt; GetAnalyzers() { return _container.GetExports\u0026lt;IAnalyzer, IAnalyzerMetadata\u0026gt;(); } } } 6. ä¸»ç¨‹åºï¼ˆåˆ›å»ºä¸Šä¸‹æ–‡å¹¶è°ƒç”¨ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 // Program.cs using Microsoft.Extensions.DependencyInjection; using SharpBoxes.Host.Services.Core; using SharpBoxes.Host.Services.Extensibility; class Program { static void Main(string[] args) { // 1. è®¾ç½® DI var services = new ServiceCollection(); services.AddSingleton\u0026lt;IHostLogger, ConsoleLogger\u0026gt;(); var serviceProvider = services.BuildServiceProvider(); // 2. è®¾ç½® MEF æ’ä»¶ç®¡ç† var pluginManager = new PluginManager(); var analyzers = pluginManager.GetAnalyzersByPriority().ToList(); // 3. åˆ›å»ºä¸Šä¸‹æ–‡ï¼ˆä» DI è·å–æœåŠ¡ï¼‰ var logger = serviceProvider.GetRequiredService\u0026lt;IHostLogger\u0026gt;(); var context = new AnalyzerContext(logger, Environment.CurrentDirectory); // 4. è°ƒç”¨æ’ä»¶ logger.Info(\u0026#34;Running analyzers with context...\u0026#34;); foreach (var lazyAnalyzer in analyzers) { try { var analyzer = lazyAnalyzer.Value; var result = analyzer.Analyze(\u0026#34;var x = 42;\u0026#34;, context); logger.Info($\u0026#34;[RESULT] {result}\u0026#34;); } catch (Exception ex) { logger.Info($\u0026#34;[ERROR] Analyzer \u0026#39;{lazyAnalyzer.Metadata.Name}\u0026#39; failed: {ex.Message}\u0026#34;); } } Console.ReadKey(); } } ğŸ–¨ï¸ è¾“å‡ºç¤ºä¾‹ 1 2 3 4 [INFO] Running analyzers with context... [INFO] [MyAnalyzer] Starting analysis of 12 chars [INFO] Working directory: C:\\SharpBoxes.Host\\bin\\Debug [INFO] [RESULT] Analyzed by Context-Based Analyzer: \u0026#39;var x = 42;\u0026#39; has 12 characters. ğŸ§ª å•å…ƒæµ‹è¯•ç¤ºä¾‹ï¼ˆæ’ä»¶ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // MyAnalyzerTests.cs [TestClass] public class MyAnalyzerTests { [TestMethod] public void Analyze_ShouldReturnCodeLength() { // Arrange var mockLogger = new Mock\u0026lt;IHostLogger\u0026gt;(); var context = new AnalyzerContext(mockLogger.Object); var analyzer = new MyAnalyzer(); // Act var result = analyzer.Analyze(\u0026#34;hello\u0026#34;, context); // Assert Assert.IsTrue(result.Contains(\u0026#34;5\u0026#34;)); mockLogger.Verify(x =\u0026gt; x.Info(It.IsAny\u0026lt;string\u0026gt;()), Times.Exactly(2)); } } âœ… æ— éœ€å¯åŠ¨ MEF æˆ– DIï¼Œçº¯ C# æµ‹è¯•ã€‚\nâœ… æ€»ç»“ ç‰¹æ€§ å®ç° æ’ä»¶æ— å®¹å™¨ä¾èµ– âœ… ä»…ä¾èµ– IAnalyzerContext æœåŠ¡å®‰å…¨ä¼ é€’ âœ… ç”±ä¸»ç¨‹åºæ§åˆ¶ æ˜“äºæµ‹è¯• âœ… å¯ mock ä¸Šä¸‹æ–‡ å…¼å®¹ .NET Framework 4.8 âœ… ä½¿ç”¨ MEF 1 + Microsoft DI æ”¯æŒå…ƒæ•°æ® + å»¶è¿ŸåŠ è½½ âœ… Lazy\u0026lt;IAnalyzer, IAnalyzerMetadata\u0026gt; ä¸ºä»€ä¹ˆæˆ‘è¦ä½¿ç”¨ä¸Šä¸‹æ–‡çš„æ–¹å¼è€Œä¸æ˜¯æŠŠServiceProviderä½œä¸ºå‚æ•°ä¼ å…¥ï¼Ÿ è¿™ç§æ–¹å¼ é¿å…æ’ä»¶æŒæœ‰ IServiceProviderï¼Œæ›´å®‰å…¨ã€æ›´æ¸…æ™°ã€æ›´æ˜“æµ‹è¯•ã€‚\nâœ… ä¼˜åŠ¿\næ’ä»¶ä¸ä¾èµ– MEF æˆ– DI å®¹å™¨ç»†èŠ‚ï¼› ä¸»ç¨‹åºå®Œå…¨æ§åˆ¶ä¼ å…¥çš„æœåŠ¡ï¼› æ˜“äºå•å…ƒæµ‹è¯•ï¼ˆå¯ mock IAnalyzerContextï¼‰ï¼› æ— æœåŠ¡å®šä½ï¼ˆService Locatorï¼‰åæ¨¡å¼ã€‚ ","date":"2025-12-07T12:23:29+08:00","image":"https://www.notion.so/images/page-cover/met_klimt_1912.jpg","permalink":"https://dumbnessrf.github.io/p/mef_with_di_to_plugin/","title":"MEF å¯¼å‡ºçš„æ’ä»¶ï¼ˆ[Export]ï¼‰å¦‚ä½•ä½¿ç”¨ç”± Microsoft DI å®¹å™¨ï¼ˆIServiceProviderï¼‰ç®¡ç†çš„æœåŠ¡ï¼ˆå¦‚ ILoggerã€IConfiguration ç­‰ï¼‰ï¼Ÿ"},{"content":"æ·±å…¥ç†è§£MEFï¼šæ„å»ºå¯æ‰©å±•.NETåº”ç”¨ç¨‹åºçš„å¼ºå¤§æ¡†æ¶ åœ¨ç°ä»£è½¯ä»¶å¼€å‘ä¸­ï¼Œå¯æ‰©å±•æ€§æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„ç‰¹æ€§ã€‚æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿè½»æ¾æ·»åŠ æ–°åŠŸèƒ½è€Œä¸ä¿®æ”¹ç°æœ‰ä»£ç ï¼Œå®ç°çœŸæ­£çš„æ’ä»¶å¼æ¶æ„ã€‚Microsoftçš„Managed Extensibility Framework (MEF) æ­£æ˜¯ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜è€Œè®¾è®¡çš„å¼ºå¤§æ¡†æ¶ã€‚\næœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªå…·ä½“çš„ä»£ç ç¤ºä¾‹æ¥æ·±å…¥æ¢è®¨MEFçš„å·¥ä½œåŸç†å’Œåº”ç”¨æ–¹æ³•ã€‚\nâœ… ä»€ä¹ˆæ˜¯MEFï¼Ÿ MEFæ˜¯å¾®è½¯æä¾›çš„ä¸€ä¸ªç”¨äºåˆ›å»ºè½»é‡çº§ã€å¯æ‰©å±•åº”ç”¨ç¨‹åºçš„.NETåº“ã€‚å®ƒå…è®¸åº”ç”¨ç¨‹åºå¼€å‘è€…å‘ç°å’Œä½¿ç”¨å¤–éƒ¨æ‰©å±•ç»„ä»¶ï¼Œè€Œæ— éœ€è¿›è¡Œå¤æ‚çš„é…ç½®ã€‚MEFçš„æ ¸å¿ƒç†å¿µæ˜¯è®©åº”ç”¨ç¨‹åºèƒ½å¤Ÿ\u0026quot;ç»„åˆ\u0026quot;å…¶å„ä¸ªéƒ¨åˆ†ï¼Œä»è€Œå®ç°æ¾è€¦åˆçš„æ¶æ„ã€‚\nç¤ºä¾‹é¡¹ç›®æ¦‚è¿° æˆ‘ä»¬çš„ç¤ºä¾‹åŒ…å«ä»¥ä¸‹ä¸»è¦ç»„ä»¶ï¼š\nä¸€ä¸ªæ§åˆ¶å°åº”ç”¨ç¨‹åºï¼ˆå®¿ä¸»ï¼‰ ä¸€ä¸ªå…±äº«ç±»åº“ï¼ˆå®šä¹‰æ¥å£å’Œå…ƒæ•°æ®ï¼‰ ä¸€ä¸ªæ’ä»¶ç±»åº“ï¼ˆå®ç°å…·ä½“åŠŸèƒ½ï¼‰ è®©æˆ‘ä»¬é€æ­¥åˆ†ææ¯ä¸ªç»„ä»¶çš„ä½œç”¨å’Œå®ç°æ–¹å¼ã€‚\nğŸ’¡å®šä¹‰å¥‘çº¦æ¥å£ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰æ’ä»¶çš„å¥‘çº¦æ¥å£ã€‚åœ¨Shared/IAnalyzer.csä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†IAnalyzeræ¥å£ï¼š\n1 2 3 4 5 6 7 8 namespace Shared { public interface IAnalyzer { string Name { get; } string Analyze(string code); } } è¿™ä¸ªæ¥å£å®šä¹‰äº†æ‰€æœ‰åˆ†æå™¨æ’ä»¶å¿…é¡»å®ç°çš„åŸºæœ¬åŠŸèƒ½ï¼šè·å–åç§°å’Œæ‰§è¡Œåˆ†æã€‚\nå®šä¹‰å…ƒæ•°æ®æ¥å£ ä¸ºäº†æ›´å¥½åœ°ç®¡ç†å’Œæè¿°æ’ä»¶ï¼Œæˆ‘ä»¬è¿˜å®šä¹‰äº†ä¸€ä¸ªå…ƒæ•°æ®æ¥å£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 using System.ComponentModel; namespace Shared { /// \u0026lt;summary\u0026gt; /// æ’ä»¶å…ƒæ•°æ®å¥‘çº¦ï¼ˆå¿…é¡»æ˜¯æ¥å£ï¼Œä¸”æ‰€æœ‰å±æ€§ä¸ºåªè¯»ï¼‰ /// MEF 1 è¦æ±‚ï¼šå±æ€§åå¿…é¡»ä¸ ExportMetadata çš„ key ä¸€è‡´ /// \u0026lt;/summary\u0026gt; public interface IAnalyzerMetadata { [DefaultValue(\u0026#34;Unknown\u0026#34;)] string Name { get; } [DefaultValue(\u0026#34;0.0.0\u0026#34;)] string Version { get; } [DefaultValue(\u0026#34;Anonymous\u0026#34;)] string Author { get; } [DefaultValue(0)] int Priority { get; } } } å…ƒæ•°æ®æ¥å£å…è®¸æˆ‘ä»¬åœ¨ä¸åˆ›å»ºå®é™…æ’ä»¶å®ä¾‹çš„æƒ…å†µä¸‹è·å–æ’ä»¶ä¿¡æ¯ï¼Œè¿™å¤§å¤§æé«˜äº†æ€§èƒ½ã€‚\nå®ç°æ’ä»¶ æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå…·ä½“çš„åˆ†æå™¨æ’ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 [Export(typeof(IAnalyzer))] [ExportMetadata(\u0026#34;Name\u0026#34;, \u0026#34;My Custom Analyzer\u0026#34;)] [ExportMetadata(\u0026#34;Version\u0026#34;, \u0026#34;1.2.0\u0026#34;)] [ExportMetadata(\u0026#34;Author\u0026#34;, \u0026#34;Zheng\u0026#34;)] [ExportMetadata(\u0026#34;Priority\u0026#34;, 100)] public class MyAnalyzer : IAnalyzer { public string Name =\u0026gt; \u0026#34;My Custom Analyzer\u0026#34;; public string Analyze(string code) { // æ¨¡æ‹Ÿè€—æ—¶åˆå§‹åŒ–ï¼ˆä»…åœ¨è°ƒç”¨æ—¶è§¦å‘ï¼‰ System.Threading.Thread.Sleep(100); return $\u0026#34;Analyzed by {Name}, code length: {code.Length}\u0026#34;; } } è¿™é‡Œçš„å…³é”®æ˜¯ä½¿ç”¨äº†MEFçš„ç‰¹æ€§ï¼š\n[Export(typeof(IAnalyzer))] æ ‡è®°è¯¥ç±»æ˜¯ä¸€ä¸ªIAnalyzerç±»å‹çš„å¯¼å‡ºç»„ä»¶ [ExportMetadata(...)] æä¾›æ’ä»¶çš„å…ƒæ•°æ®ä¿¡æ¯ æ„å»ºæ’ä»¶ç®¡ç†å™¨ åœ¨PluginManager.csä¸­ï¼Œæˆ‘ä»¬å®ç°äº†æ’ä»¶ç®¡ç†å™¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 public class PluginManager { private readonly CompositionContainer _container; public PluginManager(string pluginsDirectory = @\u0026#34;.\\Plugins\u0026#34;) { if (!Directory.Exists(pluginsDirectory)) { Directory.CreateDirectory(pluginsDirectory); } var catalog = new AggregateCatalog(); catalog.Catalogs.Add(new AssemblyCatalog(Assembly.GetExecutingAssembly())); catalog.Catalogs.Add(new DirectoryCatalog(pluginsDirectory, \u0026#34;*.dll\u0026#34;)); _container = new CompositionContainer(catalog); } /// \u0026lt;summary\u0026gt; /// è·å–æ‰€æœ‰æ’ä»¶ï¼ˆå»¶è¿ŸåŠ è½½ + å…ƒæ•°æ®ï¼‰ /// \u0026lt;/summary\u0026gt; public IEnumerable\u0026lt;Lazy\u0026lt;IAnalyzer, IAnalyzerMetadata\u0026gt;\u0026gt; GetAnalyzers() { try { return _container.GetExports\u0026lt;IAnalyzer, IAnalyzerMetadata\u0026gt;(); } catch (CompositionException ex) { System.Diagnostics.Debug.WriteLine($\u0026#34;MEF Composition Error: {ex}\u0026#34;); return Enumerable.Empty\u0026lt;Lazy\u0026lt;IAnalyzer, IAnalyzerMetadata\u0026gt;\u0026gt;(); } } /// \u0026lt;summary\u0026gt; /// æŒ‰ä¼˜å…ˆçº§æ’åºå¹¶è·å–æ’ä»¶ /// \u0026lt;/summary\u0026gt; public IEnumerable\u0026lt;Lazy\u0026lt;IAnalyzer, IAnalyzerMetadata\u0026gt;\u0026gt; GetAnalyzersByPriority() { return GetAnalyzers().OrderByDescending(x =\u0026gt; x.Metadata.Priority); } } å…³é”®ç‚¹åŒ…æ‹¬ï¼š\nä½¿ç”¨AggregateCatalogç»„åˆå¤šä¸ªç›®å½•ä¸­çš„ç»„ä»¶ AssemblyCatalogæ·»åŠ å½“å‰ç¨‹åºé›†ä¸­çš„ç»„ä»¶ DirectoryCatalogä»æŒ‡å®šç›®å½•åŠ¨æ€åŠ è½½æ’ä»¶DLL ä½¿ç”¨Lazy\u0026lt;IAnalyzer, IAnalyzerMetadata\u0026gt;å®ç°å»¶è¿ŸåŠ è½½ï¼Œåªæœ‰åœ¨çœŸæ­£è®¿é—®æ’ä»¶æ—¶æ‰åˆ›å»ºå®ä¾‹ ä¸»ç¨‹åºæ¼”ç¤º åœ¨Program.csä¸­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨æ’ä»¶ç³»ç»Ÿï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 static void Main(string[] args) { var services = new ServiceCollection(); services.AddSingleton\u0026lt;IHostLogger, ConsoleLogger\u0026gt;(); services.AddSingleton\u0026lt;PluginManager\u0026gt;(); var serviceProvider = services.BuildServiceProvider(); var logger = serviceProvider.GetRequiredService\u0026lt;IHostLogger\u0026gt;(); var pluginManager = serviceProvider.GetRequiredService\u0026lt;PluginManager\u0026gt;(); logger.Info(\u0026#34;Loading plugins (metadata only, no instance created)...\u0026#34;); var analyzers = pluginManager.GetAnalyzersByPriority().ToList(); logger.Info($\u0026#34;Found {analyzers.Count} analyzers (lazy-loaded):\u0026#34;); foreach (var lazyAnalyzer in analyzers) { var meta = lazyAnalyzer.Metadata; logger.Info( $\u0026#34; - {meta.Name} v{meta.Version} by {meta.Author} (Priority: {meta.Priority})\u0026#34; ); } // ä»…å½“éœ€è¦æ—¶æ‰å®ä¾‹åŒ–å¹¶è°ƒç”¨ logger.Info(\u0026#34;\\nRunning analysis...\u0026#34;); foreach (var lazyAnalyzer in analyzers) { // â±ï¸ æ­¤æ—¶æ‰åˆ›å»º MyAnalyzer å®ä¾‹ var result = lazyAnalyzer.Value.Analyze(\u0026#34;var x = 42;\u0026#34;); logger.Info($\u0026#34;[Result] {result}\u0026#34;); } Console.ReadKey(); } æ³¨æ„è¿™é‡Œçš„å…³é”®ç‰¹æ€§ï¼š\né¦–å…ˆåªåŠ è½½æ’ä»¶å…ƒæ•°æ®ï¼Œä¸åˆ›å»ºæ’ä»¶å®ä¾‹ æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨æ’ä»¶çš„ä¿¡æ¯ åªæœ‰åœ¨å®é™…è°ƒç”¨lazyAnalyzer.Valueæ—¶æ‰åˆ›å»ºæ’ä»¶å®ä¾‹ MEFçš„ä¼˜åŠ¿ é€šè¿‡ä¸Šè¿°ç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°MEFçš„å‡ ä¸ªé‡è¦ä¼˜åŠ¿ï¼š\n1. å»¶è¿ŸåŠ è½½ MEFæ”¯æŒå»¶è¿ŸåŠ è½½ï¼Œè¿™æ„å‘³ç€æ’ä»¶åªåœ¨çœŸæ­£éœ€è¦æ—¶æ‰ä¼šè¢«å®ä¾‹åŒ–ã€‚è¿™æ˜¾è‘—æå‡äº†åº”ç”¨ç¨‹åºçš„å¯åŠ¨æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨æ’ä»¶è¾ƒå¤šæˆ–æ’ä»¶åˆå§‹åŒ–æˆæœ¬è¾ƒé«˜çš„æƒ…å†µä¸‹ã€‚\n2. æ¾è€¦åˆ å®¿ä¸»åº”ç”¨ç¨‹åºåªéœ€è¦ä¾èµ–äºå¥‘çº¦æ¥å£ï¼Œä¸éœ€è¦çŸ¥é“æ’ä»¶çš„å…·ä½“å®ç°ã€‚è¿™ç§è§£è€¦ä½¿å¾—ç³»ç»Ÿæ›´åŠ çµæ´»å’Œæ˜“äºç»´æŠ¤ã€‚\n3. å…ƒæ•°æ®æ”¯æŒ é€šè¿‡å…ƒæ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸åˆ›å»ºå®ä¾‹çš„æƒ…å†µä¸‹è·å–æ’ä»¶ä¿¡æ¯ï¼Œè¿™å¯¹äºæ’ä»¶ç®¡ç†UIéå¸¸æœ‰ç”¨ã€‚\n4. è‡ªåŠ¨å‘ç° MEFå¯ä»¥è‡ªåŠ¨æ‰«æç›®å½•ä¸­çš„ç¨‹åºé›†ï¼Œå¹¶æ ¹æ®ç‰¹æ€§è‡ªåŠ¨è¯†åˆ«å’ŒåŠ è½½æ’ä»¶ã€‚\nå®é™…åº”ç”¨åœºæ™¯ MEFç‰¹åˆ«é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š\næ’ä»¶ç³»ç»Ÿï¼ˆå¦‚Visual Studioæ‰©å±•ï¼‰ æ¨¡å—åŒ–åº”ç”¨ç¨‹åº åŠŸèƒ½å¯æ‰©å±•çš„ä¼ä¸šçº§åº”ç”¨ éœ€è¦çƒ­æ’æ‹”åŠŸèƒ½çš„ç³»ç»Ÿ æ€»ç»“ MEFæä¾›äº†ä¸€ç§ä¼˜é›…çš„æ–¹å¼æ¥æ„å»ºå¯æ‰©å±•çš„åº”ç”¨ç¨‹åºã€‚é€šè¿‡ç®€å•çš„ç‰¹æ€§æ ‡è®°å’Œå®¹å™¨ç®¡ç†ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å®ç°æ’ä»¶æ¶æ„ã€‚æœ¬ç¤ºä¾‹å±•ç¤ºäº†MEFçš„æ ¸å¿ƒæ¦‚å¿µï¼ŒåŒ…æ‹¬å¯¼å‡º/å¯¼å…¥ã€å…ƒæ•°æ®ã€å»¶è¿ŸåŠ è½½ç­‰ç‰¹æ€§ã€‚\nè™½ç„¶åœ¨.NET Coreå’Œ.NET 5+æ—¶ä»£ï¼ŒMEFçš„ä½¿ç”¨æœ‰æ‰€å‡å°‘ï¼Œä½†å®ƒä»ç„¶æ˜¯ç†è§£å’Œå­¦ä¹ ä¾èµ–æ³¨å…¥ã€æ’ä»¶æ¶æ„çš„é‡è¦å·¥å…·ã€‚å¯¹äºéœ€è¦æ„å»ºé«˜åº¦å¯æ‰©å±•åº”ç”¨ç¨‹åºçš„å¼€å‘è€…æ¥è¯´ï¼ŒæŒæ¡MEFçš„æ€æƒ³å’Œå®è·µä»ç„¶å…·æœ‰é‡è¦æ„ä¹‰ã€‚\né€šè¿‡åˆç†è¿ç”¨MEFï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºå‡ºæ›´åŠ æ¨¡å—åŒ–ã€å¯ç»´æŠ¤å’Œå¯æ‰©å±•çš„åº”ç”¨ç¨‹åºæ¶æ„ã€‚\nç°ä»£ .NET 5+ æ—¶ä»£çš„ MEF ç°çŠ¶ ç¡®å®ï¼Œåœ¨ .NET Core å’Œ .NET 5+ï¼ˆç»Ÿç§°â€œ.NET 5+â€ï¼‰æ—¶ä»£ï¼ŒMEFï¼ˆManaged Extensibility Frameworkï¼‰çš„ä½¿ç”¨æ˜¾è‘—å‡å°‘ï¼Œå³ä½¿å®ƒåœ¨ .NET Framework æ—¶ä»£æ›¾æ˜¯å®˜æ–¹æ¨èçš„æ’ä»¶æ¨¡å‹ã€‚åŸå› æ¶‰åŠæ¶æ„æ¼”è¿›ã€ç”Ÿæ€å˜åŒ–ã€æ€§èƒ½è€ƒé‡å’Œæ›¿ä»£æ–¹æ¡ˆæˆç†Ÿç­‰å¤šä¸ªå±‚é¢ã€‚\nâœ… æ ¸å¿ƒåŸå› æ€»ç»“ åŸå›  è¯´æ˜ 1. å®˜æ–¹é‡å¿ƒè½¬å‘è½»é‡ DI .NET Core å†…ç½®äº† Microsoft.Extensions.DependencyInjectionï¼ˆè½»é‡ã€é«˜æ€§èƒ½ã€æ ‡å‡†ï¼‰ 2. MEF 1 ä¸å¯ç”¨ï¼ŒMEF 2 åŠŸèƒ½å—é™ MEF 1 ä¾èµ– AppDomainï¼ˆ.NET Core ä¸­ç§»é™¤ï¼‰ï¼ŒMEF 2 è¢«æ‹†åˆ†ä¸º System.Compositionï¼ŒåŠŸèƒ½ç²¾ç®€ 3. æ€§èƒ½ä¸å¯åŠ¨é€Ÿåº¦è¦æ±‚æé«˜ MEF åŸºäºåå°„ + å…ƒæ•°æ®ç¼“å­˜ï¼Œå†·å¯åŠ¨æ…¢ï¼Œä¸ç¬¦åˆäº‘åŸç”Ÿ/å¾®æœåŠ¡éœ€æ±‚ 4. æ’ä»¶åœºæ™¯å‡å°‘ï¼Œå¾®æœåŠ¡/æ¨¡å—åŒ–æ›¿ä»£ ç°ä»£åº”ç”¨æ›´å€¾å‘ è¿›ç¨‹éš”ç¦»ï¼ˆå¾®æœåŠ¡ï¼‰ è€Œé DLL æ’ä»¶ï¼ˆå†…å­˜å…±äº«ï¼‰ 5. ç¤¾åŒºå’Œå·¥å…·é“¾æ”¯æŒå¼±åŒ– VS 2022ã€.NET SDKã€ASP.NET Core é»˜è®¤é›†æˆ DIï¼Œå‡ ä¹ä¸æ MEF 1. .NET Core ç§»é™¤äº† MEF 1 çš„åº•å±‚æ”¯æŒ MEF 1ï¼ˆSystem.ComponentModel.Compositionï¼‰ ä¸¥é‡ä¾èµ–ï¼š AppDomainï¼ˆç”¨äºæ’ä»¶éš”ç¦»å’Œå¸è½½ï¼‰ï¼› GACï¼ˆå…¨å±€ç¨‹åºé›†ç¼“å­˜ï¼‰ï¼› Full Trust å®‰å…¨æ¨¡å‹ã€‚ è¿™äº›åœ¨ .NET Core / .NET 5+ ä¸­å…¨éƒ¨è¢«ç§»é™¤ï¼ˆå‡ºäºè·¨å¹³å°ã€å®‰å…¨ã€ç®€åŒ–ç›®çš„ï¼‰ã€‚ è™½ç„¶ MEF 2ï¼ˆSystem.Compositionï¼‰è¢«ç§»æ¤ï¼Œä½†ï¼š ä¸æ”¯æŒ DirectoryCatalogï¼ˆéœ€æ‰‹åŠ¨åŠ è½½ç¨‹åºé›†ï¼‰ï¼› ä¸æ”¯æŒ [ImportMany] çš„æŸäº›é«˜çº§åœºæ™¯ï¼› ä¸æ”¯æŒæ’ä»¶çƒ­å¸è½½ï¼ˆå› æ—  AppDomainï¼‰ã€‚ ğŸ“Œ MEF åœ¨ .NET 5+ ä¸­â€œèƒ½ç”¨ï¼Œä½†ä¸å¥½ç”¨â€ã€‚\n2. Microsoft æ¨å‡ºäº†æ›´è½»é‡ã€æ ‡å‡†åŒ–çš„ DI .NET Core ä»ç¬¬ä¸€å¤©å°±å†…ç½®äº† IServiceCollection / IServiceProviderï¼› å®ƒï¼š å¯åŠ¨æ›´å¿«ï¼ˆæ”¯æŒç¼–è¯‘æ—¶ AOT ä¼˜åŒ–ï¼Œå¦‚ Native AOTï¼‰ï¼› å†…å­˜å ç”¨æ›´ä½ï¼› ä¸ ASP.NET Coreã€WPFã€MAUI ç­‰æ·±åº¦é›†æˆï¼› ç¤¾åŒºå¹¿æ³›é‡‡ç”¨ï¼ˆAutofacã€DryIoc ç­‰ä¹Ÿå›´ç»•å®ƒæ‰©å±•ï¼‰ã€‚ å¯¹äºå¤§å¤šæ•°â€œè§£è€¦â€éœ€æ±‚ï¼Œæ ‡å‡† DI å·²è¶³å¤Ÿï¼Œæ— éœ€ MEF çš„â€œå‘ç°â€èƒ½åŠ›ã€‚ ğŸ’¡ 90% çš„åº”ç”¨ä¸éœ€è¦â€œåŠ¨æ€å‘ç°æœªçŸ¥æ’ä»¶â€ï¼Œåªéœ€è¦â€œé…ç½®å·²çŸ¥å®ç°â€â€”â€”DI å®Œç¾èƒœä»»ã€‚\n3. ç°ä»£æ¶æ„åå¥½â€œè¿›ç¨‹éš”ç¦»â€è€Œéâ€œDLL æ’ä»¶â€ æ¶æ„ .NET Framework æ—¶ä»£ .NET 5+ æ—¶ä»£ æ‰©å±•æ–¹å¼ æ’ä»¶ DLLï¼ˆ./Plugins/*.dllï¼‰ å¾®æœåŠ¡ / gRPC / HTTP API éš”ç¦»æ€§ åŒè¿›ç¨‹ï¼Œå…±äº«å†…å­˜ï¼ˆå´©æºƒå½±å“ä¸»ç¨‹åºï¼‰ ç‹¬ç«‹è¿›ç¨‹ï¼Œå´©æºƒéš”ç¦» éƒ¨ç½² å¤åˆ¶ DLL å®¹å™¨åŒ–ï¼ˆDockerï¼‰ã€ç‹¬ç«‹éƒ¨ç½² è¯­è¨€æ”¯æŒ ä»… .NET ä»»æ„è¯­è¨€ï¼ˆPython/Go/JSï¼‰ ğŸ”§ æ’ä»¶æ¨¡å‹ï¼ˆMEFï¼‰é€‚åˆå•æœºå¯Œå®¢æˆ·ç«¯ï¼ˆå¦‚ VSã€AutoCADï¼‰ï¼›\nâ˜ï¸ å¾®æœåŠ¡æ¨¡å‹é€‚åˆäº‘åŸç”Ÿã€Webã€è·¨å›¢é˜Ÿåä½œã€‚\nå³ä½¿åœ¨æ¡Œé¢ç«¯ï¼ˆå¦‚ VS Codeï¼‰ï¼Œæ‰©å±•ä¹Ÿæ˜¯é€šè¿‡ç‹¬ç«‹è¿›ç¨‹ï¼ˆExtension Hostï¼‰è¿è¡Œï¼Œè€Œéç›´æ¥åŠ è½½ DLLã€‚\n4. MEF çš„å¤æ‚æ€§ vs æ”¶ç›Šä¸åŒ¹é… MEF çš„å­¦ä¹ æ›²çº¿é™¡å³­ï¼š Import/Exportã€PartCreationPolicyã€Catalogã€Recompositionï¼› å…ƒæ•°æ®ã€å»¶è¿ŸåŠ è½½ã€å¥‘çº¦ç‰ˆæœ¬æ§åˆ¶ã€‚ è€Œç°ä»£éœ€æ±‚å¾€å¾€æ˜¯ï¼š â€œæˆ‘æœ‰å‡ ä¸ªå®ç°ï¼Œå¯åŠ¨æ—¶é€‰ä¸€ä¸ªâ€ â†’ ç”¨ DI + é…ç½®ï¼› â€œæˆ‘éœ€è¦åŠ è½½ç¬¬ä¸‰æ–¹æ¨¡å—â€ â†’ ç”¨ è„šæœ¬ï¼ˆRoslynï¼‰ã€è§„åˆ™å¼•æ“ï¼ˆNRulesï¼‰ã€æˆ–ç‹¬ç«‹è¿›ç¨‹ã€‚ ğŸ“‰ MEF çš„â€œå¼ºå¤§â€å˜æˆäº†â€œè¿‡åº¦è®¾è®¡â€ã€‚\n5. å®˜æ–¹æ€åº¦ï¼šMEF æœªè¢«åºŸå¼ƒï¼Œä½†ä¸å†æ¨å¹¿ MEF 2ï¼ˆSystem.Compositionï¼‰ä»å­˜åœ¨äº .NET 5+ï¼Œä½†ï¼š æ— æ–°åŠŸèƒ½ï¼ˆè‡ª .NET Core 2.0 åå‡ ä¹æ— æ›´æ–°ï¼‰ï¼› æ–‡æ¡£ç¨€å°‘ï¼ˆMSDN é‡ç‚¹åœ¨ DIï¼‰ï¼› VS æ¨¡æ¿ä¸åŒ…å«ã€‚ Microsoft è‡ªèº«äº§å“ä¹Ÿè½¬å‘ DIï¼š Visual Studioï¼šä»ç”¨ MEFï¼ˆå› æ˜¯ .NET Framework åº”ç”¨ï¼‰ï¼› VS Codeï¼šåŸºäº Electron + ç‹¬ç«‹è¿›ç¨‹ï¼Œä¸ç”¨ MEFï¼› .NET CLI / SDKï¼šå…¨ç”¨ Microsoft.Extensions.DependencyInjectionã€‚ âœ… ä»€ä¹ˆæ—¶å€™è¿˜è¯¥ç”¨ MEFï¼Ÿ åœºæ™¯ è¯´æ˜ ä¼ ç»Ÿ WPF/WinForms æ’ä»¶ç³»ç»Ÿ éœ€è¦ [ImportMany] + å…ƒæ•°æ®åŠ¨æ€ç»„åˆ å¦‚â€œåŠ è½½æ‰€æœ‰æ—¥å¿—å¤„ç†å™¨ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºâ€ æ— æ³•ä½¿ç”¨å¤–éƒ¨è¿›ç¨‹ åµŒå…¥å¼ç³»ç»Ÿã€æ€§èƒ½æ•æ„Ÿåœºæ™¯ ğŸ”¸ ç»“è®ºï¼šMEF æ²¡æ­»ï¼Œåªæ˜¯â€œå°ä¼—åŒ–â€äº† â€”â€” å®ƒä»æ˜¯ .NET æ¡Œé¢æ’ä»¶ç³»ç»Ÿçš„æœ€ä½³é€‰æ‹©ä¹‹ä¸€ã€‚\nğŸ”® æœªæ¥è¶‹åŠ¿ .NET 9+ï¼šç»§ç»­å¼ºåŒ– DI å’Œ AOTï¼ŒMEF ä¿æŒâ€œèƒ½ç”¨â€çŠ¶æ€ï¼› æ’ä»¶æ›¿ä»£æ–¹æ¡ˆï¼š Roslyn è„šæœ¬ï¼šCSharpScript.EvaluateAsync\u0026lt;T\u0026gt;ï¼ˆåŠ¨æ€ä»£ç ï¼‰ï¼› System.AddInï¼ˆMAFï¼‰ï¼šæ›´é‡ï¼Œä½†æ”¯æŒè¿›ç¨‹éš”ç¦»ï¼ˆå·²å½’æ¡£ï¼‰ï¼› è‡ªå®šä¹‰åŠ è½½å™¨ + AssemblyLoadContextï¼šæ‰‹åŠ¨å®ç°æ’ä»¶åŠ è½½ï¼ˆ.NET Core å”¯ä¸€æ”¯æŒå¸è½½çš„æ–¹å¼ï¼‰ã€‚ æ­£å¦‚ Visual Studio è‡³ä»Šä»é‡åº¦ä¾èµ– MEF â€”â€” å› ä¸ºå®ƒè§£å†³äº† VS çš„æ ¸å¿ƒé—®é¢˜ï¼šæ‰©å±•æ€§ã€‚\nå¦‚æœä½ åœ¨æ„å»ºä¸€ä¸ª ç°ä»£ã€å¯æ‰©å±•çš„ .NET æ¡Œé¢å·¥å…·ï¼ŒMEF ä¾ç„¶æ˜¯åˆç†ç”šè‡³æœ€ä½³çš„é€‰æ‹©ã€‚\n","date":"2025-12-07T12:18:55+08:00","image":"https://www.notion.so/images/page-cover/met_camille_pissarro_1896.jpg","permalink":"https://dumbnessrf.github.io/p/mef_in_csharp/","title":"æ·±å…¥ç†è§£MEFï¼šæ„å»ºå¯æ‰©å±•.NETåº”ç”¨ç¨‹åºçš„å¼ºå¤§æ¡†æ¶"},{"content":"TOML æ–‡ä»¶åœ¨ C# ä¸­çš„å…¨é¢æŒ‡å— é€‚ç”¨äº .NET å¼€å‘è€…ï¼šä»åŸºç¡€æ¦‚å¿µåˆ°å®æˆ˜åº”ç”¨ï¼ŒæŒæ¡ç°ä»£é…ç½®æ–‡ä»¶æ ¼å¼ TOML åœ¨ C# é¡¹ç›®ä¸­çš„ä½¿ç”¨æ–¹æ³•ã€‚\nä¸€ã€ä»€ä¹ˆæ˜¯ TOMLï¼Ÿ TOMLï¼ˆTom\u0026rsquo;s Obvious, Minimal Languageï¼‰æ˜¯ä¸€ç§è¯­ä¹‰æ˜ç¡®ã€æ˜“äºé˜…è¯»å’Œç¼–å†™çš„é…ç½®æ–‡ä»¶æ ¼å¼ï¼Œç”± GitHub è”åˆåˆ›å§‹äºº Tom Preston-Werner æå‡ºã€‚å…¶è®¾è®¡ç›®æ ‡æ˜¯æˆä¸ºæ¯” JSONã€YAMLã€INI æ›´ç›´è§‚ã€æ— æ­§ä¹‰çš„é…ç½®è¯­è¨€ã€‚\næ ¸å¿ƒç‰¹ç‚¹ âœ… äººç±»å¯è¯»ï¼šè¯­æ³•ç®€æ´ï¼Œç»“æ„æ¸…æ™° âœ… å¼ºç±»å‹æ”¯æŒï¼šåŸç”Ÿæ”¯æŒå­—ç¬¦ä¸²ã€æ•´æ•°ã€å¸ƒå°”ã€æ—¥æœŸã€æ•°ç»„ã€åµŒå¥—è¡¨ç­‰ âœ… æ ‡å‡†åŒ–ï¼šæœ‰æ˜ç¡®è§„èŒƒï¼ˆtoml.ioï¼‰ï¼Œè·¨è¯­è¨€å…¼å®¹ âœ… æ”¯æŒæ³¨é‡Šï¼šä½¿ç”¨ # æ·»åŠ è¯´æ˜ âœ… å±‚çº§ç»“æ„ï¼šé€šè¿‡ [section] å’Œ [section.subsection] å®ç°åµŒå¥— ç¤ºä¾‹ TOML æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # åº”ç”¨åŸºæœ¬ä¿¡æ¯ title = \u0026#34;My C# Application\u0026#34; version = \u0026#34;1.0.0\u0026#34; [server] host = \u0026#34;localhost\u0026#34; port = 8080 ssl_enabled = true [database] server = \u0026#34;192.168.1.10\u0026#34; port = 5432 [database.credentials] username = \u0026#34;admin\u0026#34; password = \u0026#34;s3cr3t\u0026#34; äºŒã€TOML ä¸å…¶ä»–é…ç½®æ ¼å¼å¯¹æ¯” ç‰¹æ€§ TOML INI JSON YAML äººç±»å¯è¯»æ€§ â­â­â­â­ â­â­â­ â­â­ â­â­â­â­ æ”¯æŒæ³¨é‡Š âœ…ï¼ˆ#ï¼‰ âœ…ï¼ˆ# æˆ– ;ï¼Œä¸æ ‡å‡†ï¼‰ âŒ âœ…ï¼ˆ#ï¼‰ æ•°æ®ç±»å‹ åŸç”Ÿæ”¯æŒå¤šç§ç±»å‹ ä»…å­—ç¬¦ä¸² æ”¯æŒåŸºæœ¬ç±»å‹ æ”¯æŒä½†æ˜“å‡ºé”™ åµŒå¥—ç»“æ„ âœ…ï¼ˆé€šè¿‡è¡¨ï¼‰ âŒï¼ˆéœ€å‘½åçº¦å®šï¼‰ âœ…ï¼ˆå¯¹è±¡ï¼‰ âœ…ï¼ˆç¼©è¿›ï¼‰ æ ‡å‡†è§„èŒƒ âœ…ï¼ˆä¸¥æ ¼ï¼‰ âŒï¼ˆå„å®ç°ä¸ä¸€ï¼‰ âœ… âœ…ï¼ˆä½†å¤æ‚ï¼‰ ç¼©è¿›æ•æ„Ÿ âŒ âŒ âŒ âœ…ï¼ˆæ˜“é”™ï¼‰ é€‚åˆæ‰‹å†™ âœ…âœ…âœ… âœ…âœ… âŒ âœ…ï¼ˆä½†éœ€å°å¿ƒç¼©è¿›ï¼‰ ğŸ’¡ ç»“è®ºï¼šTOML æ˜¯ INI çš„ç°ä»£åŒ–å‡çº§ç‰ˆï¼Œå…¼å…·å¯è¯»æ€§ä¸ç»“æ„è¡¨è¾¾èƒ½åŠ›ï¼Œç‰¹åˆ«é€‚åˆåº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶ã€‚\nä¸‰ã€ä¸ºä»€ä¹ˆåœ¨ C# é¡¹ç›®ä¸­ä½¿ç”¨ TOMLï¼Ÿ ç°ä»£é¡¹ç›®è¶‹åŠ¿ï¼šRustï¼ˆCargo.tomlï¼‰ã€Pythonï¼ˆpyproject.tomlï¼‰ã€Deno ç­‰å¹¿æ³›é‡‡ç”¨ ä¼˜äºä¼ ç»Ÿ appsettings.jsonï¼šæ”¯æŒæ³¨é‡Šï¼Œç»“æ„æ›´æ¸…æ™°ï¼Œé¿å… JSON çš„â€œæ— æ³¨é‡Šâ€ç—›ç‚¹ æ¯” XML ç®€æ´ï¼šæ— éœ€é—­åˆæ ‡ç­¾ï¼Œæ— å‘½åç©ºé—´å¤æ‚æ€§ æ¯” YAML å®‰å…¨ï¼šæ— ç¼©è¿›é™·é˜±ï¼Œæ— ç±»å‹è‡ªåŠ¨æ¨æ–­é£é™© ğŸ“Œ å…¸å‹åº”ç”¨åœºæ™¯ï¼š\nåº”ç”¨ç¨‹åºä¸»é…ç½®æ–‡ä»¶ï¼ˆæ›¿ä»£ appsettings.jsonï¼‰ æ’ä»¶/æ¨¡å—é…ç½® æ„å»ºè„šæœ¬å‚æ•°ï¼ˆå¦‚è‡ªå®šä¹‰æ„å»ºå·¥å…·ï¼‰ æ¸¸æˆæˆ–æ¡Œé¢åº”ç”¨çš„ç”¨æˆ·è®¾ç½® å››ã€C# ä¸­è¯»å†™ TOMLï¼šä½¿ç”¨ Tomlyn åº“ .NET å®˜æ–¹æœªå†…ç½® TOML æ”¯æŒï¼Œä½†ç¤¾åŒºåº“ Tomlyn æ˜¯ç›®å‰æœ€æˆç†Ÿã€è½»é‡ã€é«˜æ€§èƒ½çš„é€‰æ‹©ã€‚\n1. å®‰è£… é€šè¿‡ NuGet å®‰è£…ï¼š\n1 dotnet add package Tomlyn æˆ–åœ¨ .csproj ä¸­æ·»åŠ ï¼š\n1 \u0026lt;PackageReference Include=\u0026#34;Tomlyn\u0026#34; Version=\u0026#34;0.15.0\u0026#34; /\u0026gt; âœ… æ”¯æŒ .NET Standard 2.0+ï¼Œå…¼å®¹ .NET Coreã€.NET 5/6/7/8 åŠ .NET Frameworkã€‚\n2. åŠ è½½ TOML æ–‡ä»¶ æ–¹å¼ä¸€ï¼šå¼ºç±»å‹ååºåˆ—åŒ–ï¼ˆæ¨èï¼‰ é€‚ç”¨äºç»“æ„å›ºå®šçš„é…ç½®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 using Tomlyn; public class AppConfig { public string Title { get; set; } = \u0026#34;\u0026#34;; public ServerConfig Server { get; set; } = new(); public DatabaseConfig Database { get; set; } = new(); } public class ServerConfig { public string Host { get; set; } = \u0026#34;localhost\u0026#34;; public int Port { get; set; } = 8080; public bool SslEnabled { get; set; } } public class DatabaseConfig { public string Server { get; set; } = \u0026#34;\u0026#34;; public int Port { get; set; } public DbCredentials Credentials { get; set; } = new(); } public class DbCredentials { public string Username { get; set; } = \u0026#34;\u0026#34;; public string Password { get; set; } = \u0026#34;\u0026#34;; } åŠ è½½ä»£ç ï¼š\n1 2 3 4 string toml = File.ReadAllText(\u0026#34;app.toml\u0026#34;); var config = Toml.ToModel\u0026lt;AppConfig\u0026gt;(toml); Console.WriteLine($\u0026#34;Server: {config.Server.Host}:{config.Server.Port}\u0026#34;); âœ… è‡ªåŠ¨ç±»å‹è½¬æ¢ï¼šintã€boolã€åµŒå¥—å¯¹è±¡ç­‰æ— éœ€æ‰‹åŠ¨è§£æã€‚\næ–¹å¼äºŒï¼šåŠ¨æ€è§£æï¼ˆçµæ´»ä½†éœ€æ‰‹åŠ¨å¤„ç†ï¼‰ é€‚ç”¨äºç»“æ„æœªçŸ¥æˆ–ä¸´æ—¶è§£æã€‚\n1 2 3 4 5 6 using Tomlyn.Model; var model = Toml.ToModel(File.ReadAllText(\u0026#34;config.toml\u0026#34;)); var server = (TomlTable)model[\u0026#34;server\u0026#34;]; string host = (string)server[\u0026#34;host\u0026#34;]; int port = (int)server[\u0026#34;port\u0026#34;]; âš ï¸ æ³¨æ„ï¼šéœ€æ˜¾å¼ç±»å‹è½¬æ¢ï¼ŒåµŒå¥—éœ€é€’å½’å¤„ç†ã€‚\n3. ä¿å­˜ TOML æ–‡ä»¶ å°† C# å¯¹è±¡åºåˆ—åŒ–ä¸º TOML æ–‡æœ¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 var config = new AppConfig { Title = \u0026#34;My App\u0026#34;, Server = new() { Host = \u0026#34;0.0.0.0\u0026#34;, Port = 9000, SslEnabled = false }, Database = new() { Server = \u0026#34;db.example.com\u0026#34;, Port = 5432, Credentials = new() { Username = \u0026#34;user\u0026#34;, Password = \u0026#34;pass\u0026#34; } } }; string tomlText = Toml.FromModel(config); File.WriteAllText(\u0026#34;app.toml\u0026#34;, tomlText); è¾“å‡ºç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 title = \u0026#34;My App\u0026#34; [server] host = \u0026#34;0.0.0.0\u0026#34; port = 9000 ssl_enabled = false [database] server = \u0026#34;db.example.com\u0026#34; port = 5432 [database.credentials] username = \u0026#34;user\u0026#34; password = \u0026#34;pass\u0026#34; 4. é«˜çº§ç‰¹æ€§ è‡ªå®šä¹‰å­—æ®µåæ˜ å°„ å½“ TOML é”®åä¸ C# å±æ€§åä¸ä¸€è‡´æ—¶ï¼Œä½¿ç”¨ [TomlProperty]ï¼š\n1 2 3 4 5 6 7 8 public class ServerConfig { [TomlProperty(\u0026#34;bind_address\u0026#34;)] public string Host { get; set; } = \u0026#34;\u0026#34;; [TomlProperty(\u0026#34;use_tls\u0026#34;)] public bool SslEnabled { get; set; } } å¯¹åº” TOMLï¼š\n1 2 3 [server] bind_address = \u0026#34;127.0.0.1\u0026#34; use_tls = true æ•°ç»„æ”¯æŒ TOMLï¼š\n1 2 allowed_ips = [\u0026#34;192.168.1.1\u0026#34;, \u0026#34;10.0.0.5\u0026#34;] ports = [8080, 8081, 8082] C#ï¼š\n1 2 public List\u0026lt;string\u0026gt; AllowedIps { get; set; } = new(); public int[] Ports { get; set; } = Array.Empty\u0026lt;int\u0026gt;(); æ—¥æœŸæ—¶é—´ TOML æ”¯æŒ RFC 3339 æ—¥æœŸï¼š\n1 created_at = 2025-10-30T14:30:00Z C#ï¼š\n1 public DateTime CreatedAt { get; set; } äº”ã€å®Œæ•´å·¥å…·ç±»å°è£…ï¼ˆæ¨èå¤ç”¨ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 using Tomlyn; using System.IO; /// \u0026lt;summary\u0026gt; /// TOML é…ç½®æ–‡ä»¶è¯»å†™å·¥å…·ç±» /// \u0026lt;/summary\u0026gt; public static class TomlConfigHelper { /// \u0026lt;summary\u0026gt; /// ä»æ–‡ä»¶åŠ è½½ TOML é…ç½®ï¼ˆå¼ºç±»å‹ï¼‰ /// \u0026lt;/summary\u0026gt; public static T Load\u0026lt;T\u0026gt;(string filePath) where T : new() { if (!File.Exists(filePath)) throw new FileNotFoundException($\u0026#34;TOML é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {filePath}\u0026#34;); var content = File.ReadAllText(filePath); return Toml.ToModel\u0026lt;T\u0026gt;(content); } /// \u0026lt;summary\u0026gt; /// ä¿å­˜é…ç½®å¯¹è±¡åˆ° TOML æ–‡ä»¶ /// \u0026lt;/summary\u0026gt; public static void Save\u0026lt;T\u0026gt;(string filePath, T config) { var content = Toml.FromModel(config); Directory.CreateDirectory(Path.GetDirectoryName(filePath) ?? \u0026#34;.\u0026#34;); File.WriteAllText(filePath, content); } } ä½¿ç”¨ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 // é¦–æ¬¡è¿è¡Œï¼šåˆ›å»ºé»˜è®¤é…ç½® if (!File.Exists(\u0026#34;config.toml\u0026#34;)) { var defaultConfig = new AppConfig { Title = \u0026#34;My App\u0026#34; }; TomlConfigHelper.Save(\u0026#34;config.toml\u0026#34;, defaultConfig); } // åŠ è½½é…ç½® var config = TomlConfigHelper.Load\u0026lt;AppConfig\u0026gt;(\u0026#34;config.toml\u0026#34;); å…­ã€å¸¸è§é—®é¢˜ä¸æ³¨æ„äº‹é¡¹ é—®é¢˜ è§£å†³æ–¹æ¡ˆ å±æ€§æœªèµ‹å€¼ ç¡®ä¿å±æ€§ä¸º public ä¸”æœ‰ set è®¿é—®å™¨ ç±»å‹è½¬æ¢å¼‚å¸¸ æ£€æŸ¥ TOML å€¼ç±»å‹æ˜¯å¦åŒ¹é…ï¼ˆå¦‚ \u0026quot;8080\u0026quot; æ˜¯å­—ç¬¦ä¸²ï¼Œåº”å†™ä¸º 8080ï¼‰ åµŒå¥—ç»“æ„ä¸åŒ¹é… C# ç±»çš„åµŒå¥—å±‚çº§å¿…é¡»ä¸ TOML è¡¨ç»“æ„ä¸€è‡´ ä¸­æ–‡ä¹±ç  ä¿å­˜ TOML æ–‡ä»¶æ—¶ä½¿ç”¨ UTF-8 ç¼–ç ï¼ˆFile.WriteAllText é»˜è®¤ UTF-8ï¼‰ æ³¨é‡Šä¸¢å¤± Tomlyn ä¸ä¿ç•™æ³¨é‡Šï¼ˆç¬¦åˆ TOML è§„èŒƒï¼‰ï¼Œå¦‚éœ€ä¿ç•™æ³¨é‡Šéœ€ç”¨å…¶ä»–æ–¹æ¡ˆ âš ï¸ TOML è§„èŒƒè¦æ±‚ï¼šé”®ååŒºåˆ†å¤§å°å†™ï¼Œå­—ç¬¦ä¸²å»ºè®®ç”¨åŒå¼•å·ï¼ˆè™½ç„¶éƒ¨åˆ†å€¼å¯æ— å¼•å·ï¼Œä½†ä¸ºå®‰å…¨èµ·è§æ¨èæ˜¾å¼ä½¿ç”¨ï¼‰ã€‚\nä¸ƒã€ä¸å…¶ä»– .NET é…ç½®ç³»ç»Ÿçš„é›†æˆï¼ˆå¯é€‰ï¼‰ è™½ç„¶ TOML ä¸èƒ½ç›´æ¥ç”¨äº Microsoft.Extensions.Configurationï¼ˆå¦‚ ASP.NET Core çš„ IConfigurationï¼‰ï¼Œä½†å¯é€šè¿‡è‡ªå®šä¹‰ ConfigurationProvider å®ç°é›†æˆã€‚\nğŸ”§ å¦‚æœ‰éœ€è¦ï¼Œå¯åŸºäº Tomlyn å®ç° TomlConfigurationProviderï¼Œå°† TOML æ–‡ä»¶çº³å…¥æ ‡å‡†é…ç½®ç®¡é“ã€‚\nå…«ã€æ€»ç»“ ä¼˜åŠ¿ è¯´æ˜ ç®€æ´ç›´è§‚ æ¯” JSON æ›´æ˜“è¯»ï¼Œæ¯” YAML æ›´å®‰å…¨ ç±»å‹å®‰å…¨ åŸç”Ÿæ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼Œå‡å°‘è§£æé”™è¯¯ ç°ä»£æ ‡å‡† è¢« Rustã€Python ç­‰ä¸»æµç”Ÿæ€å¹¿æ³›é‡‡ç”¨ C# æ”¯æŒå®Œå–„ Tomlyn åº“æˆç†Ÿã€è½»é‡ã€é«˜æ€§èƒ½ âœ… æ¨èåœ¨ä»¥ä¸‹åœºæ™¯ä½¿ç”¨ TOMLï¼š\næ¡Œé¢åº”ç”¨ã€æ§åˆ¶å°å·¥å…·ã€æ¸¸æˆç­‰éœ€è¦ç”¨æˆ·å¯ç¼–è¾‘é…ç½®çš„é¡¹ç›® æ›¿ä»£ appsettings.json ä»¥æ”¯æŒæ³¨é‡Šå’Œæ›´æ¸…æ™°ç»“æ„ æ„å»ºç³»ç»Ÿã€CI/CD è„šæœ¬ä¸­çš„å‚æ•°é…ç½® é™„å½•ï¼šå‚è€ƒèµ„æ–™ TOML å®˜æ–¹è§„èŒƒ Tomlyn GitHub ä»“åº“ NuGet: Tomlyn ğŸ“ ä½œè€…å»ºè®®ï¼šå¯¹äºæ–°é¡¹ç›®ï¼Œä¼˜å…ˆè€ƒè™‘ TOML ä½œä¸ºé…ç½®æ ¼å¼ï¼›å¯¹äºç°æœ‰é¡¹ç›®ï¼Œå¯åœ¨éæ ¸å¿ƒæ¨¡å—ä¸­é€æ­¥å¼•å…¥ï¼Œä½“éªŒå…¶ç®€æ´ä¸å¼ºå¤§ã€‚\n","date":"2025-10-30T09:49:41+08:00","image":"https://images.unsplash.com/photo-1563387852576-964bc31b73af?ixlib=rb-4.1.0\u0026q=85\u0026fm=jpg\u0026crop=entropy\u0026cs=srgb\u0026w=6000","permalink":"https://dumbnessrf.github.io/p/what_is_toml/","title":"ä»€ä¹ˆæ˜¯Toml"},{"content":"ğŸš€ ç”¨ Channel æ›¿ä»£ BlockingCollection â€”â€” .NET 6+ ç°ä»£å¹¶å‘æ•°æ®æµ æ›´è½»é‡ã€æ›´é«˜æ•ˆã€æ›´å‡½æ•°å¼ã€æ›´ç°ä»£åŒ–çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹\nğŸ“Œ ä¸ºä»€ä¹ˆéœ€è¦ Channelï¼Ÿ è™½ç„¶ BlockingCollection\u0026lt;T\u0026gt; åŠŸèƒ½å¼ºå¤§ï¼Œä½†åœ¨ .NET 6+ æ—¶ä»£ï¼Œå¾®è½¯æ¨èä½¿ç”¨ System.Threading.Channels ä¸­çš„ Channel\u0026lt;T\u0026gt; æ¥æ„å»ºé«˜æ€§èƒ½ã€å¼‚æ­¥ä¼˜å…ˆçš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…ç®¡é“ã€‚\nâ— BlockingCollection\u0026lt;T\u0026gt; çš„å±€é™ï¼š åŸºäº Task + é˜»å¡ APIï¼ˆå¦‚ Take()ï¼‰ï¼Œåœ¨é«˜å¹¶å‘ä¸‹å¯èƒ½é˜»å¡çº¿ç¨‹ ä¸åŸç”Ÿæ”¯æŒ async/await æµå¼æ¶ˆè´¹ æ— æ³•ä¸ IAsyncEnumerable\u0026lt;T\u0026gt; æ— ç¼é›†æˆ æ— èƒŒå‹ï¼ˆbackpressureï¼‰æ§åˆ¶ï¼ˆé™¤éæ‰‹åŠ¨é…åˆä¿¡å·é‡ï¼‰ âœ… Channel\u0026lt;T\u0026gt; çš„ä¼˜åŠ¿ï¼š âœ”ï¸ åŸç”Ÿå¼‚æ­¥æ”¯æŒï¼ˆReadAsync / WaitToReadAsyncï¼‰ âœ”ï¸ æ”¯æŒ IAsyncEnumerable\u0026lt;T\u0026gt;ï¼ˆchannel.Reader.ReadAllAsync()ï¼‰ âœ”ï¸ æ›´ç»†ç²’åº¦çš„è¯»å†™åˆ†ç¦»ï¼ˆChannelReader\u0026lt;T\u0026gt; / ChannelWriter\u0026lt;T\u0026gt;ï¼‰ âœ”ï¸ å†…ç½®èƒŒå‹æ”¯æŒï¼ˆBounded Channel è‡ªåŠ¨é˜»å¡å†™å…¥ï¼‰ âœ”ï¸ é›¶åˆ†é…ä¼˜åŒ–ã€é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿ âœ”ï¸ ä¸ç°ä»£ .NET ç”Ÿæ€ï¼ˆå¦‚ ASP.NET Coreã€Minimal APIã€BackgroundServiceï¼‰å®Œç¾é›†æˆ ğŸ§© ä¸€ã€Channel åŸºç¡€ç”¨æ³• 1. åˆ›å»º Channel 1 2 3 4 5 6 7 8 // æ— ç•Œé€šé“ï¼ˆç±»ä¼¼ BlockingCollection æ— å®¹é‡é™åˆ¶ï¼‰ var channel = Channel.CreateUnbounded\u0026lt;int\u0026gt;(); // æœ‰ç•Œé€šé“ï¼ˆå®¹é‡=10ï¼Œå†™æ»¡è‡ªåŠ¨é˜»å¡/ä¸¢å¼ƒ/è¦†ç›– â€” å¯é…ç½®ï¼‰ var boundedChannel = Channel.CreateBounded\u0026lt;int\u0026gt;(new BoundedChannelOptions(10) { FullMode = BoundedChannelFullMode.Wait // é»˜è®¤è¡Œä¸ºï¼šå†™æ»¡æ—¶ç­‰å¾… }); 2. ç”Ÿäº§è€…å†™å…¥ 1 2 3 4 5 6 var writer = channel.Writer; await writer.WriteAsync(1); await writer.WriteAsync(2); writer.Complete(); // æ ‡è®°å®Œæˆå†™å…¥ 3. æ¶ˆè´¹è€…è¯»å– 1 2 3 4 5 6 7 8 9 var reader = channel.Reader; while (await reader.WaitToReadAsync()) { while (reader.TryRead(out var item)) { Console.WriteLine($\u0026#34;æ¶ˆè´¹: {item}\u0026#34;); } } æˆ–ä½¿ç”¨ IAsyncEnumerable\u0026lt;T\u0026gt;ï¼š\n1 2 3 4 await foreach (var item in channel.Reader.ReadAllAsync()) { Console.WriteLine($\u0026#34;æ¶ˆè´¹: {item}\u0026#34;); } âœ… å®Œæ•´ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 using System.Threading.Channels; var channel = Channel.CreateBounded\u0026lt;int\u0026gt;(10); // ç”Ÿäº§è€… _ = Task.Run(async () =\u0026gt; { for (int i = 1; i \u0026lt;= 20; i++) { await channel.Writer.WriteAsync(i); Console.WriteLine($\u0026#34;ç”Ÿäº§: {i}\u0026#34;); await Task.Delay(100); } channel.Writer.Complete(); }); // æ¶ˆè´¹è€… await foreach (var item in channel.Reader.ReadAllAsync()) { Console.WriteLine($\u0026#34;æ¶ˆè´¹: {item}\u0026#34;); await Task.Delay(200); } ğŸ”„ äºŒã€Channel vs BlockingCollection å¯¹æ¯” ç‰¹æ€§ BlockingCollection\u0026lt;T\u0026gt; Channel\u0026lt;T\u0026gt; å¼‚æ­¥æ”¯æŒ âŒï¼ˆéœ€åŒ…è£… Task.Runï¼‰ âœ… åŸç”Ÿå¼‚æ­¥ æµå¼æ¶ˆè´¹ âŒï¼ˆforeach é˜»å¡ï¼‰ âœ… IAsyncEnumerable\u0026lt;T\u0026gt; èƒŒå‹æ§åˆ¶ âš ï¸ éœ€æ‰‹åŠ¨é…åˆä¿¡å·é‡ âœ… å†…ç½®ï¼ˆBoundedChannelï¼‰ æ€§èƒ½ âš ï¸ ä¸­ç­‰ï¼ˆæœ‰é”å¼€é”€ï¼‰ âœ… æ›´é«˜ï¼ˆä¼˜åŒ–æ— é”ç»“æ„ï¼‰ è¯»å†™åˆ†ç¦» âŒ âœ… ChannelReader/Writer å–æ¶ˆæ”¯æŒ âš ï¸ æœ‰é™ âœ… åŸç”Ÿæ”¯æŒ CancellationToken .NET ç°ä»£ç”Ÿæ€é›†æˆ âš ï¸ æ—§å¼ âœ… æ¨èï¼ˆ.NET 6+ï¼‰ ğŸ¯ ä¸‰ã€å®æˆ˜ï¼šç”¨ Channel æ”¹å†™ä»»åŠ¡è°ƒåº¦å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 public class ChannelTaskScheduler\u0026lt;T\u0026gt; { private readonly Channel\u0026lt;Func\u0026lt;Task\u0026lt;T\u0026gt;\u0026gt;\u0026gt; _channel; private readonly SemaphoreSlim _semaphore; private readonly ILogger _logger; public ChannelTaskScheduler(int maxConcurrency, int? boundedCapacity = null, ILogger logger = null) { _channel = boundedCapacity.HasValue ? Channel.CreateBounded\u0026lt;Func\u0026lt;Task\u0026lt;T\u0026gt;\u0026gt;\u0026gt;(boundedCapacity.Value) : Channel.CreateUnbounded\u0026lt;Func\u0026lt;Task\u0026lt;T\u0026gt;\u0026gt;\u0026gt;(); _semaphore = new SemaphoreSlim(maxConcurrency, maxConcurrency); _logger = logger; } public async ValueTask\u0026lt;bool\u0026gt; QueueTaskAsync(Func\u0026lt;Task\u0026lt;T\u0026gt;\u0026gt; task, CancellationToken ct = default) { return await _channel.Writer.WriteAsync(task, ct); } public async Task StartAsync(CancellationToken ct = default) { await foreach (var workItem in _channel.Reader.ReadAllAsync(ct)) { _ = ExecuteWithLimit(workItem, ct); // å¹¶å‘æ‰§è¡Œï¼Œä¸ç­‰å¾… } } private async Task ExecuteWithLimit(Func\u0026lt;Task\u0026lt;T\u0026gt;\u0026gt; workItem, CancellationToken ct) { await _semaphore.WaitAsync(ct); try { await workItem(); } catch (Exception ex) { _logger?.LogError(ex, \u0026#34;ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸\u0026#34;); } finally { _semaphore.Release(); } } public async Task CompleteAsync(CancellationToken ct = default) { _channel.Writer.Complete(); // å¯é€‰ï¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ // await foreach (var _ in _channel.Reader.ReadAllAsync(ct)) { } } } ä½¿ç”¨ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 var scheduler = new ChannelTaskScheduler\u0026lt;string\u0026gt;(maxConcurrency: 3, boundedCapacity: 10, logger); for (int i = 1; i \u0026lt;= 20; i++) { var taskId = i; await scheduler.QueueTaskAsync(() =\u0026gt; Task.Run(async () =\u0026gt; { await Task.Delay(500); return $\u0026#34;ä»»åŠ¡ {taskId} å®Œæˆ\u0026#34;; })); } await scheduler.StartAsync(); âš™ï¸ å››ã€é«˜çº§ç‰¹æ€§ 1. èƒŒå‹ç­–ç•¥ï¼ˆBoundedChannelFullModeï¼‰ 1 2 3 4 5 6 7 8 9 10 var options = new BoundedChannelOptions(10) { FullMode = BoundedChannelFullMode.Wait, // é»˜è®¤ï¼šå†™æ»¡ç­‰å¾… // FullMode = BoundedChannelFullMode.DropWrite, // ä¸¢å¼ƒæœ€æ–°å†™å…¥ // FullMode = BoundedChannelFullMode.DropOldest, // ä¸¢å¼ƒæœ€æ—§æ•°æ® // FullMode = BoundedChannelFullMode.DropNewest, // ä¸¢å¼ƒæœ€æ–°æ•°æ® AllowSynchronousContinuations = false, // é¿å…åŒæ­¥å»¶ç»­ï¼ˆæ¨è falseï¼‰ SingleReader = false, // æ˜¯å¦å•æ¶ˆè´¹è€… SingleWriter = false // æ˜¯å¦å•ç”Ÿäº§è€… }; 2. å•ç”Ÿäº§è€…/å•æ¶ˆè´¹è€…ä¼˜åŒ– å¦‚æœä½ èƒ½ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å†™å…¥æˆ–è¯»å–ï¼Œå¯ç”¨ SingleWriter = true æˆ– SingleReader = trueï¼Œæ€§èƒ½æ›´ä½³ï¼\n3. å–æ¶ˆæ”¯æŒ 1 2 3 4 5 6 CancellationTokenSource cts = new(TimeSpan.FromSeconds(5)); await foreach (var item in channel.Reader.ReadAllAsync(cts.Token)) { // ... } ğŸ“ äº”ã€æœ€ä½³å®è·µ åœºæ™¯ æ¨èæ–¹æ¡ˆ æ–°é¡¹ç›® / .NET 6+ âœ… ä¼˜å…ˆä½¿ç”¨ Channel\u0026lt;T\u0026gt; éœ€è¦å¼‚æ­¥æµ / IAsyncEnumerable âœ… Channel\u0026lt;T\u0026gt; éœ€è¦èƒŒå‹æ§åˆ¶ âœ… BoundedChannel\u0026lt;T\u0026gt; é—ç•™ç³»ç»Ÿå…¼å®¹ âš ï¸ å¯ç»§ç»­ä½¿ç”¨ BlockingCollection\u0026lt;T\u0026gt; é«˜æ€§èƒ½ä½å»¶è¿Ÿåœºæ™¯ âœ… Channel\u0026lt;T\u0026gt; + SingleWriter/Reader âœ… ç»“è¯­ Channel\u0026lt;T\u0026gt; æ˜¯ .NET ç°ä»£å¹¶å‘ç¼–ç¨‹çš„â€œæ ‡å‡†ç­”æ¡ˆâ€ï¼Œå®ƒï¼š\næ›´ç¬¦åˆå¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ æ€§èƒ½æ›´ä¼˜ åŠŸèƒ½æ›´ä¸°å¯Œ ç”Ÿæ€æ›´ç°ä»£ æ˜¯æ—¶å€™ç”¨ Channel\u0026lt;T\u0026gt; æ›¿ä»£ BlockingCollection\u0026lt;T\u0026gt; äº†ï¼\n","date":"2025-09-15T21:08:09+08:00","image":"https://www.notion.so/images/page-cover/rijksmuseum_rembrandt_1642.jpg","permalink":"https://dumbnessrf.github.io/p/parallel_programing_modern/","title":"Parallel Programing Modern"},{"content":" ğŸ§  æ·±åº¦å­¦ä¹ æ¨¡å‹è¶…å‚æ•°é…ç½®æŒ‡å—ï¼ˆåˆ†ç±»ï¼šç›®æ ‡æ£€æµ‹ã€è¯­ä¹‰åˆ†å‰²ã€å¼‚å¸¸æ£€æµ‹ã€Deep OCRï¼‰ æœ¬æŒ‡å—å¯¹ä¸»æµæ·±åº¦å­¦ä¹ ä»»åŠ¡ä¸­çš„å…³é”®è¶…å‚æ•°è¿›è¡Œç³»ç»Ÿæ€§æ€»ç»“ä¸åˆ†æï¼Œæ¶µç›–ç›®æ ‡æ£€æµ‹ã€è¯­ä¹‰åˆ†å‰²ã€é€šç”¨å¼‚å¸¸æ£€æµ‹ï¼ˆGC-ADï¼‰å’Œ Deep OCR å››å¤§ç±»åˆ«ï¼Œæ—¨åœ¨å¸®åŠ©ç”¨æˆ·åˆç†é…ç½®æ¨¡å‹ä»¥å¹³è¡¡æ€§èƒ½ã€é€Ÿåº¦ä¸èµ„æºæ¶ˆè€—ã€‚\n1ï¸âƒ£ ç›®æ ‡æ£€æµ‹ï¼ˆObject Detectionï¼‰ ç›®æ ‡æ£€æµ‹æ¨¡å‹é€šå¸¸åŸºäºç‰¹å¾é‡‘å­—å¡”ç½‘ç»œï¼ˆFPNï¼‰ï¼Œé€šè¿‡å¤šå°ºåº¦ç‰¹å¾å›¾æ£€æµ‹ä¸åŒå°ºå¯¸ç‰©ä½“ã€‚å…³é”®å‚æ•°å¦‚ä¸‹ï¼š\nå‚æ•° æè¿° å»ºè®®ä¸å½±å“ å®¹é‡\nï¼ˆCapacityï¼‰ ç½‘ç»œæ·±å±‚éƒ¨åˆ†çš„å‚æ•°æ•°é‡ - é«˜ï¼šæ›´å¼ºè¡¨è¾¾åŠ›ï¼Œé€‚åˆå¤æ‚åœºæ™¯\n- ä¸­/ä½ï¼šæå‡æ¨ç†é€Ÿåº¦ï¼Œé€‚åˆè½»é‡éƒ¨ç½²\n- æ³¨æ„ï¼šç®€å•ä»»åŠ¡ä¸­â€œä½å®¹é‡â€å¯èƒ½è¾¾åˆ°ä¸â€œé«˜å®¹é‡â€ç›¸å½“çš„ç²¾åº¦ æœ€å°çº§åˆ«\nï¼ˆMin Levelï¼‰ ç‰¹å¾é‡‘å­—å¡”æœ€ä½å±‚çº§ï¼ˆæœ€å°ä¸‹é‡‡æ ·å€æ•°ï¼‰ - 0 = åŸå›¾å¤§å°ç‰¹å¾å›¾\n- è¶Šå°è¶Šèƒ½æ£€æµ‹å°ç‰©ä½“\n- å¢åŠ ä½çº§åˆ«ä¼šæ˜¾è‘—â†‘å†…å­˜ä¸è®¡ç®—å¼€é”€ æœ€å¤§çº§åˆ«\nï¼ˆMax Levelï¼‰ ç‰¹å¾é‡‘å­—å¡”æœ€é«˜å±‚çº§ï¼ˆæœ€å¤§ä¸‹é‡‡æ ·å€æ•°ï¼‰ - è¶Šå¤§è¶Šèƒ½æ£€æµ‹å¤§ç‰©ä½“\n- é€šå¸¸ä¸æœ€å°çº§åˆ«å…±åŒå†³å®šç‰¹å¾é‡‘å­—å¡”å®½åº¦ï¼š\nå±‚æ•° = MaxLevel - MinLevel + 1 å­å°ºåº¦é”šæ•°é‡ æ¯ä¸ªç‰¹å¾çº§åˆ«ä¸Šä½¿ç”¨çš„é”šæ¡†å°ºå¯¸ç§ç±»æ•° - æ›´å¤šå°ºå¯¸ â†’ æ›´å¥½é€‚é…ç‰©ä½“å½¢çŠ¶\n- â†‘é”šæ•°é‡ â†’ â†‘è®­ç»ƒæ—¶é—´ã€å†…å­˜ã€è®¡ç®—è´Ÿè½½ é”šé•¿å®½æ¯”\nï¼ˆAspect Ratioï¼‰ é”šæ¡†é«˜åº¦:å®½åº¦æ¯”ä¾‹ï¼ˆå¦‚ 1:1, 1:2, 2:1ï¼‰ - å¤šç§æ¯”ä¾‹æå‡å®šä½ç²¾åº¦ï¼ˆå°¤å…¶éæ­£æ–¹å½¢ç‰©ä½“ï¼‰\n- æ¯”ä¾‹è¶Šå¤š â†’ é”šæ€»æ•°â†‘ â†’ è®­ç»ƒæ›´æ…¢ é”šè§’åº¦ [Â°]\nï¼ˆä»…è‡ªç”±çŸ©å½¢ï¼‰ é”šæ¡†ç›¸å¯¹äºæ°´å¹³è½´çš„æ—‹è½¬è§’åº¦ - æ”¯æŒå€¾æ–œ/æ—‹è½¬ç‰©ä½“æ£€æµ‹ï¼ˆå¦‚æ–‡å­—ã€è½¦è¾†ï¼‰\n- è§’åº¦èŒƒå›´ï¼š(-90Â°, 90Â°]\n- å¢åŠ è§’åº¦å¤šæ ·æ€§ â†’ â†‘é”šæ•°é‡ \u0026amp; â†‘è®¡ç®—è´Ÿæ‹… å¿½ç•¥æ–¹å‘ æ˜¯å¦å°†ä¸åŒæœå‘çš„çŸ©å½¢è§†ä¸ºåŒä¸€ç±» - âœ…é€‰ä¸­ï¼šä»…è€ƒè™‘ä½ç½®ï¼Œå¿½ç•¥æ—‹è½¬\n- âŒä¸é€‰ï¼šåŒºåˆ†ä¸åŒæœå‘ï¼ˆéœ€é…åˆé”šè§’åº¦ï¼‰ æƒé‡å…ˆéªŒ (Î±)\nï¼ˆWeight Priorï¼‰ L2 æ­£åˆ™åŒ–å¼ºåº¦ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ - åˆå§‹å€¼å»ºè®®ï¼š0.00001\n- è‹¥å‡ºç°è¿‡æ‹Ÿåˆï¼ˆéªŒè¯é›†æ€§èƒ½ä¸‹é™ï¼‰â†’ é€æ­¥å¢å¤§ï¼ˆå¦‚ 0.0001, 0.001ï¼‰ è¾¹ç•Œæ¡†å¤´éƒ¨æƒé‡ BBox å›å½’æŸå¤±åœ¨æ€»æŸå¤±ä¸­çš„æƒé‡ç³»æ•° - æ§åˆ¶å®šä½ç²¾åº¦ vs åˆ†ç±»ç²¾åº¦çš„å¹³è¡¡\n- è‹¥å®šä½ä¸å‡† â†’ å¢å¤§æ­¤å€¼ ç±»åˆ«å¤´éƒ¨æƒé‡ åˆ†ç±»æŸå¤±åœ¨æ€»æŸå¤±ä¸­çš„æƒé‡ç³»æ•° - ç±»åˆ«ä¸å¹³è¡¡æ—¶å¯è°ƒé«˜\n- é»˜è®¤å¸¸è®¾ä¸º 1.0ï¼Œæ ¹æ®è®­ç»ƒè¡¨ç°å¾®è°ƒ å†»ç»“éª¨å¹²çº§åˆ« è®­ç»ƒæ—¶å†»ç»“éª¨å¹²ç½‘ç»œçš„æœ€é«˜å±‚çº§ - 0ï¼šä¸å†»ç»“ä»»ä½•å±‚ï¼ˆå…¨è®­ç»ƒï¼‰\n- nï¼šå†»ç»“ç¬¬ n å±‚åŠä»¥ä¸Šï¼ˆä»è¾“å…¥ç«¯ç®—èµ·ï¼‰\n- âœ…é€‚ç”¨åœºæ™¯ï¼š\nâ€¢ éª¨å¹²æœªé¢„è®­ç»ƒ\nâ€¢ è¾“å…¥é€šé“å˜åŒ–ï¼ˆå¦‚çº¢å¤–å›¾åƒï¼‰\nâ€¢ æ•°æ®é‡å°‘ï¼Œé¿å…è¿‡æ‹Ÿåˆ ğŸ’¡ æç¤ºï¼šç‰¹å¾é‡‘å­—å¡”çº§åˆ«é€‰æ‹©åº”åŒ¹é…ç›®æ ‡å°ºå¯¸åˆ†å¸ƒã€‚ä¾‹å¦‚ï¼š\nå°ç‰©ä½“ä¸ºä¸» â†’ è®¾ MinLevel=0, MaxLevel=4 å¤§ç‰©ä½“ä¸ºä¸» â†’ è®¾ MinLevel=2, MaxLevel=5 2ï¸âƒ£ è¯­ä¹‰åˆ†å‰²ï¼ˆSemantic Segmentationï¼‰ è¯­ä¹‰åˆ†å‰²æ¨¡å‹é€šå¸¸ä½¿ç”¨ U-Netã€DeepLab ç­‰æ¶æ„ï¼Œè¾“å‡ºåƒç´ çº§ç±»åˆ«æ©ç ã€‚\nå‚æ•° æè¿° å»ºè®®ä¸å½±å“ é®ç½©å¤´éƒ¨æƒé‡\nï¼ˆMask Head Weightï¼‰ æ©ç é¢„æµ‹æŸå¤±åœ¨æ€»æŸå¤±ä¸­çš„æƒé‡ç³»æ•° - æ§åˆ¶åˆ†å‰²ç²¾åº¦ vs åˆ†ç±»ç²¾åº¦çš„æƒè¡¡\n- è‹¥è¾¹ç¼˜æ¨¡ç³Šæˆ–åˆ†å‰²ä¸å‡†ç¡® â†’ å¢å¤§è¯¥å€¼\n- é€šå¸¸ä¸åˆ†ç±»å¤´æƒé‡ååŒè°ƒæ•´ âš ï¸ æ³¨æ„ï¼šæ­¤å¤„â€œåˆ†ç±»å¤´éƒ¨æƒé‡â€åº”ä¸ºç¬”è¯¯ï¼Œè¯­ä¹‰åˆ†å‰²ä¸­åº”ä¸ºâ€œé®ç½©å¤´éƒ¨æƒé‡â€ã€‚\n3ï¸âƒ£ é€šç”¨å¼‚å¸¸æ£€æµ‹ï¼ˆGC-AD, Generalized Anomaly Detectionï¼‰ GC-AD æ˜¯ä¸€ç§åŒåˆ†æ”¯å¼‚å¸¸æ£€æµ‹æ¡†æ¶ï¼ŒåŒ…å«å…¨å±€å­ç½‘ä¸å±€éƒ¨å­ç½‘ï¼Œæ”¯æŒä¸‰ç§æ¨¡å¼ã€‚\næ¨¡å¼ æè¿° åº”ç”¨åœºæ™¯ å»ºè®® GC-AD å…¨å±€ ä»…ä½¿ç”¨å…¨å±€å­ç½‘ æ£€æµ‹å¤§é¢ç§¯ã€æ•´ä½“æ€§å¼‚å¸¸ï¼ˆå¦‚æ±¡æ¸ã€è¤ªè‰²ã€æ•´ä½“å˜å½¢ï¼‰\næ“…é•¿è¯†åˆ«é€»è¾‘å¼‚å¸¸ï¼ˆå¦‚ç¼ºå¤±éƒ¨ä»¶ã€é”™è¯¯å¸ƒå±€ï¼‰ âœ… å»ºè®®å¯ç”¨å›¾åƒå¢å¼ºï¼ˆå¦‚äº®åº¦ã€å¯¹æ¯”åº¦æ‰°åŠ¨ï¼‰ GC-AD æœ¬åœ° ä»…ä½¿ç”¨å±€éƒ¨å­ç½‘ æ£€æµ‹å±€éƒ¨ç¼ºé™·ï¼ˆå¦‚åˆ’ç—•ã€å­”æ´ã€è£‚çº¹ï¼‰\næ“…é•¿ç»“æ„å¼‚å¸¸ï¼ˆçº¹ç†/å½¢çŠ¶å˜åŒ–ï¼‰ è¡¥ä¸å¤§å°éœ€è¦†ç›–å…¸å‹ç¼ºé™·åŒºåŸŸ GC-AD ç»“åˆ åŒæ—¶ä½¿ç”¨å…¨å±€ + æœ¬åœ°å­ç½‘ æœ€å…¨é¢æ–¹æ¡ˆï¼Œå…¼é¡¾å…¨å±€é€»è¾‘å¼‚å¸¸ä¸å±€éƒ¨ç»“æ„å¼‚å¸¸ âœ… å¼ºçƒˆæ¨èç”¨äºå·¥ä¸šè´¨æ£€\nâœ… å¯¹å…¨å±€å­ç½‘å¯ç”¨å¢å¼º ğŸ” å…³é”®å‚æ•°ï¼šè¡¥ä¸å¤§å°ï¼ˆPatch Sizeï¼‰ å‚æ•° æè¿° å»ºè®® è¡¥ä¸å¤§å° å±€éƒ¨å­ç½‘å¤„ç†çš„å›¾åƒå—å°ºå¯¸ï¼ˆWÃ—Hï¼‰ - å¿…é¡» â‰¤ å›¾åƒå®½é«˜\n- åº”ç¡®ä¿ï¼šæœ‰ç¼ºé™·è¡¥ä¸ ä¸ æ— ç¼ºé™·è¡¥ä¸ åœ¨ç‰¹å¾ç©ºé—´æ˜æ˜¾å¯åˆ†\n- ä¸éœ€è¦å®Œå…¨è¦†ç›–ç¼ºé™·ï¼Œåªéœ€åŒ…å«è¶³å¤Ÿåˆ¤åˆ«ä¿¡æ¯\n- è‹¥å›¾åƒå°ºå¯¸å˜åŒ–ï¼Œå¿…é¡»åŒæ­¥è°ƒæ•´è¡¥ä¸å¤§å° ğŸ’¡ ç¤ºä¾‹ï¼šæ£€æµ‹ PCB ä¸Š 5Ã—5mm çš„ç„Šç‚¹ç¼ºå¤± â†’ è¡¥ä¸å¤§å°è®¾ä¸º 64Ã—64 åƒç´ ï¼ˆå‡è®¾åŸå›¾ 1024Ã—1024ï¼‰\n4ï¸âƒ£ Deep OCRï¼ˆå…‰å­¦å­—ç¬¦è¯†åˆ«ï¼‰ Deep OCR ç”±ä¸¤ä¸ªç‹¬ç«‹æ¨¡å‹ç»„æˆï¼Œéœ€åˆ†åˆ«è®­ç»ƒä¸è¯„ä¼°ï¼š\nç»„ä»¶ è¯´æ˜ æ£€æµ‹æ¨¡å‹ å®šä½å›¾åƒä¸­æ–‡æœ¬åŒºåŸŸï¼ˆBounding Box / Polygonï¼‰\nå¯è‡ªå®šä¹‰è®­ç»ƒï¼ˆå¦‚ä½¿ç”¨ DBNetã€EASTï¼‰ è¯†åˆ«æ¨¡å‹ å°†æ£€æµ‹åˆ°çš„æ–‡æœ¬åŒºåŸŸè½¬ä¸ºå­—ç¬¦åºåˆ—\nâš ï¸ ä»…æä¾›é¢„è®­ç»ƒæ¨¡å‹ï¼Œä¸å¯è‡ªå®šä¹‰è®­ç»ƒç»“æ„ ğŸ“Œ è®­ç»ƒé™åˆ¶ä¸æ³¨æ„äº‹é¡¹ é¡¹ç›® è¯´æ˜ è¯†åˆ«æ¨¡å‹è®­ç»ƒ âŒ ä»…æ”¯æŒä½¿ç”¨å®˜æ–¹é¢„è®­ç»ƒæ¨¡å‹\nâœ… ä¸æ”¯æŒä»å¤´è®­ç»ƒæˆ–å¾®è°ƒç»“æ„ è®­ç»ƒè®¾å¤‡ è¯†åˆ«æ¨¡å‹å¿…é¡»åœ¨ GPU ä¸Šè¿è¡Œï¼ŒCPU ä¸æ”¯æŒ è®­ç»ƒæµç¨‹ 1. è®­ç»ƒæ£€æµ‹æ¨¡å‹ â†’ 2. ä½¿ç”¨æ£€æµ‹ç»“æœç”Ÿæˆè£å‰ªæ–‡æœ¬å›¾åƒ â†’ 3. ä½¿ç”¨é¢„è®­ç»ƒè¯†åˆ«æ¨¡å‹è¿›è¡Œæ¨ç† æ•°æ®è¦æ±‚ é«˜è´¨é‡æ ‡æ³¨æ–‡æœ¬æ¡† + å­—ç¬¦æ ‡ç­¾ï¼Œå»ºè®®å¤šæ ·åŒ–å­—ä½“ã€èƒŒæ™¯ã€å…‰ç…§æ¡ä»¶ âœ… æ¨èæµç¨‹ï¼š\nåŸå§‹å›¾åƒ â†’ æ£€æµ‹æ¨¡å‹ â†’ æ–‡æœ¬è£å‰ª â†’ é¢„è®­ç»ƒè¯†åˆ«æ¨¡å‹ â†’ è¾“å‡ºæ–‡æœ¬\nğŸ“Š é€šç”¨å»ºè®®ï¼šç±»åˆ«æƒé‡ï¼ˆClass Weightsï¼‰ åœºæ™¯ å»ºè®® ç±»åˆ«åˆ†å¸ƒä¸å‡\nï¼ˆå¦‚ 95% ä¸ºæ­£å¸¸ï¼Œ5% ä¸ºç¼ºé™·ï¼‰ âŒ ä¸æ¨èç›´æ¥ä½¿ç”¨ è‡ªå®šä¹‰ç±»åˆ«æƒé‡ å¹³è¡¡æ ·æœ¬æ¯”ä¾‹ âœ… æ›´ä¼˜æ–¹æ¡ˆ â¤ å¢åŠ å°‘æ•°ç±»æ ·æœ¬é‡‡é›†\nâ¤ æ•°æ®å¢å¼ºï¼ˆç¿»è½¬ã€ç¼©æ”¾ã€å™ªå£°æ³¨å…¥ï¼‰\nâ¤ ä½¿ç”¨ Focal Loss æˆ– OHEMï¼ˆåœ¨çº¿éš¾ä¾‹æŒ–æ˜ï¼‰ ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨ç±»åˆ«æƒé‡ å¦‚æ— æ³•å¢åŠ æ•°æ®é‡ï¼Œä¸”æ¨¡å‹ä¸¥é‡åå‘å¤šæ•°ç±» â†’ å¯å°è¯•è®¾ç½® weight = 1 / class_freq âœ… æ€»ç»“ï¼šå‚æ•°è°ƒä¼˜ç­–ç•¥é€ŸæŸ¥è¡¨ ç›®æ ‡ æ¨èæ“ä½œ æå‡å°ç‰©ä½“æ£€æµ‹èƒ½åŠ› â†“ MinLevelï¼Œâ†‘ å­å°ºåº¦é”šæ•°é‡ï¼Œâ†‘ é”šé•¿å®½æ¯” åŠ é€Ÿæ¨ç† â†“ å®¹é‡ï¼Œâ†‘ MinLevelï¼Œâ†“ é”šè§’åº¦æ•°é‡ï¼Œâ†“ ç‰¹å¾çº§åˆ«æ•° å‡å°‘è¿‡æ‹Ÿåˆ â†‘ æƒé‡å…ˆéªŒ Î±ï¼Œå†»ç»“éª¨å¹²å±‚ï¼Œæ•°æ®å¢å¼º æ”¹å–„åˆ†å‰²è¾¹ç¼˜ â†‘ é®ç½©å¤´éƒ¨æƒé‡ï¼Œä½¿ç”¨ Dice Loss æˆ– IoU Loss æ£€æµ‹å±€éƒ¨ç¼ºé™· ä½¿ç”¨ GC-AD æœ¬åœ°æ¨¡å¼ï¼Œä¼˜åŒ–è¡¥ä¸å¤§å° æ£€æµ‹å…¨å±€å¼‚å¸¸ ä½¿ç”¨ GC-AD å…¨å±€ + å¢å¼º OCR é¡¹ç›® åˆ†ç¦»è®­ç»ƒæ£€æµ‹ä¸è¯†åˆ«ï¼›è¯†åˆ«ä»…ç”¨é¢„è®­ç»ƒæ¨¡å‹ï¼›GPU å¿…é¡» ğŸ“˜ å‚è€ƒèµ„æ–™ HALCON ç®—å­å‚è€ƒï¼šget_dl_model_param ç›¸å…³è®ºæ–‡ï¼šFPN (Lin et al., CVPR 2017), RetinaNet (Lin et al., ICCV 2017), DeepLabv3+, DBNet å®è·µå»ºè®®ï¼šä¼˜å…ˆé€šè¿‡æ•°æ®å¢å¼ºä¸æ ·æœ¬æ‰©å……è§£å†³ä¸å¹³è¡¡ï¼Œè€Œéä¾èµ–æƒé‡è°ƒæ•´ ğŸ” ç›®æ ‡æ£€æµ‹è¶…å‚æ•°æ·±åº¦è§£æï¼ˆé€é¡¹è¯¦è§£ï¼‰ æœ¬èŠ‚åŸºäºç‰¹å¾é‡‘å­—å¡”ç½‘ç»œï¼ˆFPNï¼‰æ¶æ„ï¼Œé€‚ç”¨äºå¦‚ RetinaNetã€Faster R-CNN + FPNã€YOLO-FPN ç­‰å¤šå°ºåº¦æ£€æµ‹æ¨¡å‹ã€‚æ‰€æœ‰å‚æ•°å‡å›´ç»•â€œé”šæ¡†ï¼ˆAnchorï¼‰+ å¤šçº§ç‰¹å¾å›¾â€æœºåˆ¶å±•å¼€ã€‚\n1. å®¹é‡ï¼ˆCapacityï¼‰ âœ… å®šä¹‰ï¼š ç½‘ç»œæ·±å±‚éƒ¨åˆ†ï¼ˆé€šå¸¸æŒ‡ç‰¹å¾æå–å™¨åç«¯ã€åˆ†ç±»/å›å½’å¤´ï¼‰çš„å‚æ•°æ€»é‡ï¼Œåæ˜ æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ã€‚\nğŸ“Œ æœ¬è´¨ï¼š å¹¶éç›´æ¥è®¾ç½®å±‚æ•°ï¼Œè€Œæ˜¯æ§åˆ¶â€œç½‘ç»œå®½åº¦â€æˆ–â€œé€šé“æ•°â€ã€‚ åœ¨ HALCON æˆ–ç±»ä¼¼å·¥å…·ä¸­ï¼Œå¯èƒ½å¯¹åº”ï¼š backbone_type = \u0026quot;resnet50\u0026quot; vs \u0026quot;resnet101\u0026quot; head_channels = 256 vs 512 æ˜¯å¦å¯ç”¨ dilated convã€SE blockã€CBAM ç­‰å¢å¼ºæ¨¡å— âš™ï¸ å·¥ä½œæœºåˆ¶ï¼š å®¹é‡ç­‰çº§ å‚æ•°é‡ä¼°ç®—ï¼ˆå…¸å‹ï¼‰ ç‰¹å¾ ä½ ~1Mâ€“3M è½»é‡åŒ–å¤´ï¼ˆå¦‚ 64~128 é€šé“ï¼‰ï¼Œé€‚åˆåµŒå…¥å¼è®¾å¤‡ ä¸­ ~5Mâ€“10M å¹³è¡¡æ–¹æ¡ˆï¼Œå·¥ä¸šå¸¸ç”¨ï¼ˆå¦‚ YOLOv5sï¼‰ é«˜ \u0026gt;15M é«˜åˆ†è¾¨ç‡ç‰¹å¾ã€å®½å·ç§¯æ ¸ã€å¯†é›†è¿æ¥ï¼Œé€‚åˆå¤æ‚èƒŒæ™¯ ğŸ’¡ å®é™…å½±å“ï¼š åœºæ™¯ æ¨èå®¹é‡ åŸå›  å·¥ä¸šè´¨æ£€ï¼ˆå°ç›®æ ‡ã€é«˜ç²¾åº¦ï¼‰ ä¸­ â†’ é«˜ éœ€è¦å¼ºç‰¹å¾æå–èƒ½åŠ›åŒºåˆ†ç»†å¾®ç¼ºé™· å®æ—¶è§†è§‰å¼•å¯¼ï¼ˆæœºå™¨äººï¼‰ ä½ â†’ ä¸­ é™åˆ¶æ¨ç†å»¶è¿Ÿï¼ˆ\u0026lt;50msï¼‰ é¥æ„Ÿå›¾åƒï¼ˆå¤§åœºæ™¯ã€å¤šç±»ï¼‰ é«˜ å¯¹è±¡å°ºå¯¸å·®å¼‚æå¤§ï¼Œéœ€å¼ºå¤§è¡¨å¾åŠ› æ•°æ®é‡å°‘ï¼ˆ\u0026lt;1k å›¾åƒï¼‰ ä½ é˜²æ­¢è¿‡æ‹Ÿåˆ ğŸ”§ è°ƒä¼˜å»ºè®®ï¼š ä»â€œä¸­â€å¼€å§‹ï¼Œè§‚å¯ŸéªŒè¯é›† mAPï¼› è‹¥ mAP è¾¾åˆ°å¹³å°ä¸Šé™ä½†é€Ÿåº¦æ…¢ â†’ é™ä¸ºâ€œä½â€ï¼› è‹¥ mAP ä¸è¶³ä¸”æŸå¤±éœ‡è¡ â†’ å‡ä¸ºâ€œé«˜â€ + åŠ å…¥æ­£åˆ™åŒ–ï¼ˆDropoutã€æƒé‡å…ˆéªŒï¼‰ï¼› æ³¨æ„ï¼šåœ¨ç®€å•ä»»åŠ¡ï¼ˆå¦‚ä»…æ£€æµ‹çº¢ç»¿ç¯ï¼‰ä¸­ï¼Œâ€œä½å®¹é‡â€å¸¸å¯åª²ç¾â€œé«˜å®¹é‡â€ã€‚ 2. æœ€å°çº§åˆ«ï¼ˆMin Levelï¼‰ âœ… å®šä¹‰ï¼š ç‰¹å¾é‡‘å­—å¡”ä¸­æœ€åº•å±‚ï¼ˆæœ€ç²¾ç»†ï¼‰çš„ç‰¹å¾å›¾å±‚çº§ç¼–å·ï¼Œä»£è¡¨æœ€å°ä¸‹é‡‡æ ·å€æ•°ã€‚\nğŸ“Œ æ•°å­¦å®šä¹‰ï¼š è¾“å…¥å›¾åƒå¤§å°ï¼šH Ã— W ç¬¬ l çº§ç‰¹å¾å›¾å°ºå¯¸ï¼šH / 2^l Ã— W / 2^l Min Level = 0 â†’ ç‰¹å¾å›¾å°ºå¯¸ = åŸå›¾ï¼ˆæ— ä¸‹é‡‡æ ·ï¼‰ Min Level = 2 â†’ ç‰¹å¾å›¾å°ºå¯¸ = åŸå›¾ 1/4 âš™ï¸ å·¥ä½œæœºåˆ¶ï¼š Min Level ç‰¹å¾å›¾å°ºå¯¸ï¼ˆåŸå›¾ 640Ã—640ï¼‰ æ£€æµ‹å¯¹è±¡å°ºåº¦ å†…å­˜å¼€é”€ 0 640Ã—640 æå°ç‰©ä½“ï¼ˆ\u0026lt;10pxï¼‰ âš ï¸ æé«˜ 1 320Ã—320 å°ç‰©ä½“ï¼ˆ10â€“30pxï¼‰ é«˜ 2 160Ã—160 ä¸­ç­‰ç‰©ä½“ï¼ˆ30â€“80pxï¼‰ ä¸­ 3 80Ã—80 å¤§ç‰©ä½“ï¼ˆ\u0026gt;80pxï¼‰ ä½ ğŸ’¡ å®é™…å½±å“ï¼š è®¾ä¸º 0ï¼šèƒ½æ£€æµ‹åƒç´ çº§ç›®æ ‡ï¼ˆå¦‚èŠ¯ç‰‡ç„Šç‚¹ã€å¾®å°è£‚çº¹ï¼‰ï¼Œä½†ï¼š è®¡ç®—é‡å‰§å¢ï¼ˆç‰¹å¾å›¾å¤§ï¼‰ æ˜“å—å™ªå£°å¹²æ‰° éœ€è¦æ›´å¼ºçš„éª¨å¹²ç½‘ç»œæ”¯æŒ è®¾ä¸º 2 æˆ–æ›´é«˜ï¼šç‰ºç‰²å°ç‰©ä½“æ£€æµ‹èƒ½åŠ›ï¼Œæ¢å–é€Ÿåº¦å’Œç¨³å®šæ€§ã€‚ ğŸ”§ è°ƒä¼˜å»ºè®®ï¼š åº”ç”¨åœºæ™¯ æ¨è MinLevel è¯´æ˜ å¾®ç”µå­æ£€æµ‹ã€ç»†èƒè¯†åˆ« 0 æˆ– 1 å¿…é¡»ä¿ç•™åŸå§‹åˆ†è¾¨ç‡ä¿¡æ¯ è‡ªåŠ¨é©¾é©¶ï¼ˆè½¦è¾†ã€è¡Œäººï¼‰ 2 ä¸»æµé€‰æ‹©ï¼Œå¹³è¡¡æ€§èƒ½ä¸æ•ˆç‡ å¤§å‹å·¥å‚å·¡æ£€ï¼ˆæœºæ¢°è‡‚ï¼‰ 3 ç‰©ä½“å¤§ï¼Œæ— éœ€é«˜åˆ†è¾¨ç‡ æ³¨æ„ â—è‹¥ MinLevel=0ï¼Œå¿…é¡»é…åˆé«˜å®¹é‡ + æ­£åˆ™åŒ–ï¼Œå¦åˆ™è®­ç»ƒä¸ç¨³å®š 3. æœ€å¤§çº§åˆ«ï¼ˆMax Levelï¼‰ âœ… å®šä¹‰ï¼š ç‰¹å¾é‡‘å­—å¡”ä¸­æœ€é¡¶å±‚ï¼ˆæœ€ç²—ç•¥ï¼‰çš„ç‰¹å¾å›¾å±‚çº§ç¼–å·ï¼Œä»£è¡¨æœ€å¤§ä¸‹é‡‡æ ·å€æ•°ã€‚\nğŸ“Œ æ•°å­¦å®šä¹‰ï¼š Max Level = 5 â†’ ç‰¹å¾å›¾å°ºå¯¸ = åŸå›¾ 1/32 é€šå¸¸ä¸ Min Level å…±åŒå†³å®šé‡‘å­—å¡”å±‚æ•°ï¼š\nL = MaxLevel - MinLevel + 1 âš™ï¸ å·¥ä½œæœºåˆ¶ï¼š Max Level ç‰¹å¾å›¾å°ºå¯¸ï¼ˆ640Ã—640ï¼‰ æ£€æµ‹å¯¹è±¡å°ºåº¦ é€‚ç”¨æ€§ 3 80Ã—80 â‰¤ 256px ä¸€èˆ¬åœºæ™¯ 4 40Ã—40 â‰¤ 512px å¤§å‹ç‰©ä½“ï¼ˆå¡è½¦ã€å»ºç­‘ï¼‰ 5 20Ã—20 â‰¤ 1024px èˆªæ‹ã€é¥æ„Ÿå›¾åƒ ğŸ’¡ å®é™…å½±å“ï¼š è¿‡é«˜ï¼ˆå¦‚ MaxLevel=6ï¼‰ï¼š å¯æ£€æµ‹è¶…å¤§ç›®æ ‡ï¼ˆå¦‚æ•´æ ‹æ¥¼ï¼‰ ä½†ç‰¹å¾è¿‡äºç¨€ç– â†’ å°ç‰©ä½“ä¸¢å¤±ã€å®šä½ä¸å‡† å†…å­˜å ç”¨ç¿»å€ï¼Œè®­ç»ƒå˜æ…¢ è¿‡ä½ï¼ˆå¦‚ MaxLevel=3ï¼‰ï¼š å¤§ç‰©ä½“è¢«å‹ç¼©æˆå‡ ä¸ªåƒç´  â†’ æ£€æµ‹å¤±è´¥ï¼ˆæ¼æ£€ï¼‰ ğŸ”§ è°ƒä¼˜å»ºè®®ï¼š åº”ç”¨åœºæ™¯ æ¨è MaxLevel è¯´æ˜ æ‰‹æœºå±å¹•ç¼ºé™·æ£€æµ‹ 3 ç‰©ä½“å°ï¼Œæ— éœ€é«˜å±‚ æ— äººæœºèˆªæ‹ä½œç‰©ç›‘æµ‹ 5 æ£€æµ‹å¤§é¢ç§¯å†œç”°ã€é“è·¯ å·¥ä¸šæµæ°´çº¿ï¼ˆäº§å“å°ºå¯¸å›ºå®šï¼‰ 4 æ ¹æ®äº§å“æœ€å¤§å°ºå¯¸è®¾å®š é€šç”¨å»ºè®® MaxLevel - MinLevel âˆˆ [3, 5] å±‚æ•°å¤ªå°‘ â†’ å¤šå°ºåº¦ä¸è¶³ï¼›å¤ªå¤š â†’ æ— æ•ˆå†—ä½™ âœ… æœ€ä½³å®è·µï¼šMinLevel å’Œ MaxLevel çš„å·®å€¼åº” â‰¥ 3ï¼Œä»¥ä¿è¯è‡³å°‘ 4 çº§ç‰¹å¾ç”¨äºå¤šå°ºåº¦æ£€æµ‹ã€‚\n4. å­å°ºåº¦é”šæ•°é‡ï¼ˆNumber of Scales per Levelï¼‰ âœ… å®šä¹‰ï¼š åœ¨æ¯ä¸ªç‰¹å¾å±‚çº§ä¸Šï¼Œç”Ÿæˆçš„ä¸åŒå°ºå¯¸é”šæ¡†ï¼ˆanchor scalesï¼‰çš„æ•°é‡ã€‚\nğŸ“Œ ç¤ºä¾‹ï¼š è®¾ç½®ä¸º 3 â†’ æ¯ä¸ªä½ç½®ç”Ÿæˆ 3 ä¸ªä¸åŒé¢ç§¯çš„é”šæ¡†ï¼š scale = [0.5, 1.0, 2.0] Ã— åŸºç¡€é¢ç§¯ å¸¸è§åŸºç¡€é¢ç§¯ï¼š32Â², 64Â², 128Â²ï¼ˆå–å†³äºç‰¹å¾å›¾ strideï¼‰ âš™ï¸ å·¥ä½œæœºåˆ¶ï¼š é”šæ•°é‡ é”šå°ºå¯¸åˆ†å¸ƒ æ•ˆæœ 1 å›ºå®šå°ºå¯¸ å¿«ï¼Œä½†é€‚é…æ€§å·®ï¼ˆå¦‚åªæ£€æµ‹æ­£æ–¹å½¢ï¼‰ 3 å°ã€ä¸­ã€å¤§ âœ… æ ‡å‡†é…ç½®ï¼Œè¦†ç›–å¤§å¤šæ•°å½¢çŠ¶ 5+ ç»†ç²’åº¦ç¼©æ”¾ æ›´å¥½é€‚é…ä¸è§„åˆ™ç‰©ä½“ï¼ˆå¦‚é•¿æ¡å½¢ã€æ‰­æ›²ç›®æ ‡ï¼‰ ğŸ’¡ å®é™…å½±å“ï¼š â†‘ é”šæ•°é‡ â†’ â†‘ åŒ¹é…ç‡ â†’ â†‘ å¬å›ç‡ï¼ˆRecallï¼‰ ä½†åŒæ—¶ï¼š é”šæ€»æ•° = L Ã— H Ã— W Ã— N_scales Ã— N_ratios è®­ç»ƒæ—¶é—´ â†‘ï¼Œæ˜¾å­˜æ¶ˆè€— â†‘ï¼Œè´Ÿæ ·æœ¬æ¿€å¢ â†’ éœ€æ›´å¼ºéš¾ä¾‹æŒ–æ˜ ğŸ”§ è°ƒä¼˜å»ºè®®ï¼š åœºæ™¯ æ¨èå€¼ è¯´æ˜ æ ‡å‡†ç›®æ ‡ï¼ˆäººã€è½¦ã€åŠ¨ç‰©ï¼‰ 3 é»˜è®¤æ¨è å¼‚å½¢ç‰©ä½“ï¼ˆç”µè·¯æ¿èµ°çº¿ã€æ–‡å­—ã€ç»†é•¿é›¶ä»¶ï¼‰ 5 æå‡å¯¹æç«¯é•¿å®½æ¯”çš„è¦†ç›– å®æ—¶ç³»ç»Ÿï¼ˆåµŒå…¥å¼ï¼‰ 2 å‡å°‘è®¡ç®—è´Ÿæ‹… æ³¨æ„ è‹¥ä½¿ç”¨ è‡ªé€‚åº”é”šæ¡†ï¼ˆå¦‚ K-Means èšç±»ï¼‰â†’ å¯çœç•¥æ­¤å‚æ•° âœ… å»ºè®®ç»“åˆâ€œé”šé•¿å®½æ¯”â€å…±åŒä¼˜åŒ–ï¼š\nå¦‚ï¼šscales=[0.5,1,2] + ratios=[0.5,1,2] â†’ æ€»é”šæ•° = 3Ã—3=9 ä¸ª/ä½ç½®\n5. é”šé•¿å®½æ¯”ï¼ˆAspect Ratioï¼‰ âœ… å®šä¹‰ï¼š é”šæ¡†çš„é«˜åº¦ä¸å®½åº¦ä¹‹æ¯”ï¼ˆHeight:Widthï¼‰ï¼Œå†³å®šé”šçš„å½¢çŠ¶ã€‚\nğŸ“Œ å¸¸è§å€¼ï¼š [1.0] â†’ æ­£æ–¹å½¢ [0.5, 1.0, 2.0] â†’ ç«–é•¿ã€æ­£æ–¹ã€æ¨ªé•¿ [0.3, 0.5, 1.0, 2.0, 3.0] â†’ æç«¯æ¯”ä¾‹ï¼ˆç”¨äºæ–‡å­—ã€ç”µçº¿ã€è£‚ç¼ï¼‰ âš™ï¸ å·¥ä½œæœºåˆ¶ï¼š æ¯ä¸ªé”šæ¡†ç”± (scale, ratio) ç»„åˆç”Ÿæˆ è‹¥ scales=3, ratios=5 â†’ æ¯ä¸ªç‰¹å¾ç‚¹ç”Ÿæˆ 3Ã—5=15 ä¸ªé”šæ¡† ğŸ’¡ å®é™…å½±å“ï¼š æ¯”ä¾‹å¤šæ ·æ€§ ä¼˜ç‚¹ ç¼ºç‚¹ å°‘ï¼ˆ1~2ç§ï¼‰ å¿«é€Ÿã€ç¨³å®š å¯¹éæ­£æ–¹å½¢ç‰©ä½“å¬å›ç‡ä½ å¤šï¼ˆâ‰¥4ç§ï¼‰ é«˜å¬å›ç‡ï¼Œå°¤å…¶å¯¹ç»†é•¿ç›®æ ‡ è®­ç»ƒæ…¢ã€æ˜“äº§ç”Ÿå¤§é‡æ— æ•ˆè´Ÿæ ·æœ¬ ğŸ”§ è°ƒä¼˜å»ºè®®ï¼š ç›®æ ‡ç±»å‹ æ¨è Aspect Ratios è¯´æ˜ äººè„¸ã€è½¦è¾† [0.7, 1.0, 1.3] æ¥è¿‘æ­£æ–¹å½¢ æ–‡å­—è¡Œã€å¯¼çº¿ã€è£‚ç¼ [0.2, 0.5, 1.0, 2.0, 5.0] å¿…é¡»è¦†ç›–æé•¿å½¢çŠ¶ PCB å…ƒä»¶ [0.4, 0.8, 1.0, 1.5, 2.5] é•¿æ–¹å½¢ ICã€ç”µå®¹ã€ç”µé˜» é€šç”¨å»ºè®® ä½¿ç”¨ K-Means èšç±»ä½ çš„æ ‡æ³¨æ¡†ï¼Œå¾—åˆ°æœ€ä¼˜ ratio åˆ†å¸ƒ ğŸ‘‰ æ¨èå·¥å…·ï¼šcoco_anchors.py æˆ– labelme2kmeans âœ… æŠ€å·§ï¼šåœ¨è®­ç»ƒå‰å¯è§†åŒ–çœŸå®æ¡†çš„é•¿å®½æ¯”åˆ†å¸ƒï¼ŒåŒ¹é…é”šæ¯”ä¾‹ï¼\n6. é”šè§’åº¦ [Â°]ï¼ˆAnchor Angleï¼‰â€”â€”ä»…é™è‡ªç”±çŸ©å½¢ï¼ˆOriented Bounding Boxï¼‰ âœ… å®šä¹‰ï¼š é”šæ¡†ç›¸å¯¹äºæ°´å¹³è½´çš„æ—‹è½¬è§’åº¦ï¼ˆæ•°å­¦æ­£æ–¹å‘ï¼Œé€†æ—¶é’ˆï¼‰ï¼Œç”¨äºæ£€æµ‹å€¾æ–œç›®æ ‡ã€‚\nğŸ“Œ èŒƒå›´ï¼š åˆæ³•èŒƒå›´ï¼š(-90Â°, 90Â°] å¸¸è§ç¦»æ•£å–å€¼ï¼š[-45Â°, 0Â°, 45Â°] æˆ– [-60Â°, -30Â°, 0Â°, 30Â°, 60Â°] âš™ï¸ å·¥ä½œæœºåˆ¶ï¼š ä¼ ç»Ÿé”šæ˜¯è½´å¯¹é½çŸ©å½¢ï¼ˆAxis-Alignedï¼‰ è‡ªç”±çŸ©å½¢é”š æ˜¯æ—‹è½¬çŸ©å½¢ï¼ˆRBoxï¼‰ï¼Œæœ‰ä¸­å¿ƒç‚¹ (x,y)ã€å®½ wã€é«˜ hã€è§’åº¦ Î¸ æ¯ä¸ªè§’åº¦å€¼ç‹¬ç«‹ç”Ÿæˆä¸€ç»„é”šæ¡† ğŸ’¡ å®é™…å½±å“ï¼š è§’åº¦æ•°é‡ ä¼˜åŠ¿ åŠ£åŠ¿ 1ï¼ˆ0Â°ï¼‰ å¿«ï¼Œç¨³å®š æ— æ³•æ£€æµ‹æ–œå‘æ–‡å­—ã€å€¾æ–œè½¦è¾† 3ï¼ˆ-45Â°, 0Â°, 45Â°ï¼‰ è¦†ç›–å¸¸è§å€¾æ–œ ä»æ¼æ£€ Â±75Â° ç›®æ ‡ 5~9 æé«˜å¬å›ç‡ï¼ˆå¦‚ OCRã€èˆªç©ºå½±åƒï¼‰ è®¡ç®—é‡ Ã—5~9ï¼Œè®­ç»ƒææ…¢ ğŸ”§ è°ƒä¼˜å»ºè®®ï¼š åº”ç”¨ æ¨èè§’åº¦é›†åˆ è¯´æ˜ æ–‡å­—æ£€æµ‹ï¼ˆè‡ªç„¶åœºæ™¯ï¼‰ [-45Â°, 0Â°, 45Â°] 90% æ–‡æœ¬åœ¨æ­¤èŒƒå›´å†… æ— äººæœºèˆªæ‹è½¦è¾† [-60Â°, -30Â°, 0Â°, 30Â°, 60Â°] è½¦è¾†æœå‘å¤šæ · PCB å…ƒä»¶æ”¾ç½® [-15Â°, 0Â°, 15Â°] ç²¾åº¦è¦æ±‚é«˜ï¼Œè§’åº¦å˜åŒ–å° æ³¨æ„ âœ… å¯ç”¨è§’åº¦æ—¶ï¼Œå¿…é¡»å…³é—­â€œå¿½ç•¥æ–¹å‘â€ âŒ å¦åˆ™è§’åº¦å¤±å»æ„ä¹‰ âš ï¸ é‡è¦ï¼šé”šè§’åº¦ â‰  æ¨¡å‹é¢„æµ‹è§’åº¦\né”šè§’åº¦æ˜¯â€œå…ˆéªŒâ€ï¼Œç”¨äºåŒ¹é…çœŸå®æ¡† æ¨¡å‹æœ€ç»ˆè¾“å‡ºçš„æ˜¯åç§»é‡ Î”Î¸ï¼Œé€šè¿‡å›å½’å­¦ä¹ ä¿®æ­£ 7. å¿½ç•¥æ–¹å‘ï¼ˆIgnore Orientationï¼‰ âœ… å®šä¹‰ï¼š æ˜¯å¦å°†ä¸åŒæ—‹è½¬è§’åº¦çš„çŸ©å½¢è§†ä¸ºåŒä¸€ä¸ªç›®æ ‡ï¼ˆå³ä¸åŒºåˆ†æœå‘ï¼‰ã€‚\nâš™ï¸ å·¥ä½œæœºåˆ¶ï¼š å¼€å¯ï¼ˆâœ…ï¼‰ï¼šæ— è®ºé”šæ¡†è§’åº¦æ˜¯å¤šå°‘ï¼Œåªè¦ä¸­å¿ƒã€å®½é«˜ä¸€è‡´ â†’ è§†ä¸ºåŒä¸€å€™é€‰æ¡† å…³é—­ï¼ˆâŒï¼‰ï¼šæ¯ä¸ªè§’åº¦ç‹¬ç«‹åŒ¹é…çœŸå®æ¡†ï¼Œè®­ç»ƒæ›´å¤æ‚ ğŸ’¡ å®é™…å½±å“ï¼š å¼€å¯ å…³é—­ âœ… å‡å°‘é”šæ•°é‡ï¼ˆæå‡é€Ÿåº¦ï¼‰ âŒ å¢åŠ é”šæ•°é‡ï¼ˆé™ä½é€Ÿåº¦ï¼‰ âœ… é€‚ç”¨äºè½´å¯¹é½ç›®æ ‡ï¼ˆå¦‚æ™®é€šçŸ©å½¢ï¼‰ âŒ å¿…é¡»ç”¨äºå€¾æ–œç›®æ ‡ï¼ˆå¦‚æ—‹è½¬æ–‡å­—ã€é£æœºï¼‰ âœ… å¯ä¸â€œé”šè§’åº¦â€å…±å­˜ï¼Œä½†è§’åº¦æ— æ„ä¹‰ âŒ å¿…é¡»å¯ç”¨é”šè§’åº¦æ‰æœ‰æ„ä¹‰ ğŸ”§ è°ƒä¼˜å»ºè®®ï¼š åœºæ™¯ æ¨èè®¾ç½® æ£€æµ‹ä¹¦æœ¬ã€åŒ…è£…ç›’ã€æ ‡å‡†é›¶ä»¶ âœ… å¼€å¯ æ£€æµ‹å€¾æ–œæ–‡å­—ã€æ—‹è½¬è½¦ç‰Œã€é£åŠ›å¶ç‰‡ âŒ å…³é—­ + è®¾ç½®å¤šä¸ªé”šè§’åº¦ ä¸ç¡®å®šï¼Ÿ å…ˆå…³é—­ï¼Œè®­ç»ƒè§‚å¯Ÿæ˜¯å¦å‡ºç°å¤§é‡â€œé”™ä½æ£€æµ‹â€ â†’ å†å†³å®šæ˜¯å¦å¼€å¯ âœ… æœ€ä½³å®è·µï¼šå¦‚æœçœŸå®æ ‡æ³¨æ¡†åŒ…å«è§’åº¦å­—æ®µï¼ˆÎ¸ï¼‰ï¼Œåˆ™å¿…é¡»å…³é—­â€œå¿½ç•¥æ–¹å‘â€ã€‚\n8. æƒé‡å…ˆéªŒï¼ˆWeight Prior, Î±ï¼‰ âœ… å®šä¹‰ï¼š L2 æ­£åˆ™åŒ–ç³»æ•°ï¼ˆÎ»ï¼‰ï¼Œç”¨äºæƒ©ç½šæ¨¡å‹æƒé‡è¿‡å¤§ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆã€‚\nğŸ“Œ æ•°å­¦å½¢å¼ï¼š 1 Loss_total = Loss_detection + Î± * ||W||â‚‚Â² å…¶ä¸­ W æ˜¯ç½‘ç»œæ‰€æœ‰å¯è®­ç»ƒå‚æ•°ã€‚\nâš™ï¸ å·¥ä½œæœºåˆ¶ï¼š Î± è¶Šå¤§ â†’ æƒé‡è¶Šè¶‹è¿‘äº 0 â†’ æ¨¡å‹è¶Šâ€œç®€å•â€ ç±»ä¼¼äºâ€œæ¨¡å‹å‹ç¼©â€æˆ–â€œæ—©åœâ€çš„æ­£åˆ™åŒ–æ‰‹æ®µ ğŸ’¡ å®é™…å½±å“ï¼š Î± å€¼ æ•ˆæœ 0.00001 æå¼±æ­£åˆ™ â†’ æ˜“è¿‡æ‹Ÿåˆï¼ˆæ•°æ®å°‘æ—¶æ˜æ˜¾ï¼‰ 0.0001 æ ‡å‡†å€¼ï¼Œæ¨èèµ·ç‚¹ 0.001 å¼ºæ­£åˆ™ â†’ æ¨¡å‹æ¬ æ‹Ÿåˆé£é™© â†‘ 0.01 æå¼º â†’ æ¨¡å‹å‡ ä¹æ— æ³•å­¦ä¹  ğŸ”§ è°ƒä¼˜å»ºè®®ï¼š æ•°æ®æƒ…å†µ æ¨è Î± è¡ŒåŠ¨ æ•°æ®é‡ \u0026gt; 5k å›¾åƒ 0.0001 é»˜è®¤ æ•°æ®é‡ \u0026lt; 1k å›¾åƒ 0.0005 ~ 0.001 é˜²æ­¢è®°å¿†å™ªå£° éªŒè¯ loss ä¸‹é™ä½† mAP ä¸å‡ â†‘ Î±ï¼ˆå°è¯• 0.0003 â†’ 0.001ï¼‰ è®­ç»ƒ loss é«˜ã€æ”¶æ•›æ…¢ â†“ Î±ï¼ˆå°è¯• 0.00001ï¼‰ ä½¿ç”¨é¢„è®­ç»ƒéª¨å¹² å¯é€‚å½“é™ä½ Î±ï¼ˆå¦‚ 0.00005ï¼‰ âœ… æŠ€å·§ï¼šç›‘æ§ weight_norm æ›²çº¿ â€”â€” è‹¥æƒé‡æŒç»­å¢å¤§ä¸” loss æ³¢åŠ¨ â†’ å¢å¤§ Î±\n9. è¾¹ç•Œæ¡†å¤´éƒ¨æƒé‡ï¼ˆBBox Head Weightï¼‰ âœ… å®šä¹‰ï¼š åœ¨æ€»æŸå¤±å‡½æ•°ä¸­ï¼Œè¾¹ç•Œæ¡†å›å½’æŸå¤±æ‰€å çš„æ¯”é‡ã€‚\nğŸ“Œ æ€»æŸå¤±å…¬å¼ç¤ºä¾‹ï¼š 1 Total Loss = Î»_cls * Loss_cls + Î»_bbox * Loss_bbox âš™ï¸ å·¥ä½œæœºåˆ¶ï¼š Loss_bbox é€šå¸¸æ˜¯ Smooth L1 æˆ– IoU Loss è‹¥ Î»_bbox å¤ªå° â†’ æ¨¡å‹åªå…³å¿ƒåˆ†ç±»ï¼Œå®šä½ä¸å‡† è‹¥ Î»_bbox å¤ªå¤§ â†’ æ¨¡å‹è¿‡åº¦æ‹Ÿåˆæ¡†åæ ‡ï¼Œå¿½ç•¥ç±»åˆ« ğŸ’¡ å®é™…å½±å“ï¼š Î»_bbox æ¨¡å‹è¡Œä¸º 0.1 åˆ†ç±»ä¸»å¯¼ï¼Œæ¡†å¾ˆç²—ç³™ 1.0 å¹³è¡¡ï¼ˆé»˜è®¤ï¼‰ 2.0 æ¡†éå¸¸ç²¾å‡†ï¼Œä½†å¯èƒ½è¯¯æ£€ï¼ˆç½®ä¿¡åº¦ä½çš„æ¡†è¢«æ¿€æ´»ï¼‰ 5.0 è¿‡æ‹Ÿåˆè¾¹ç•Œï¼Œæ³›åŒ–å·® ğŸ”§ è°ƒä¼˜å»ºè®®ï¼š é—®é¢˜ç°è±¡ è§£å†³æ–¹æ¡ˆ æ£€æµ‹æ¡†åç§»ä¸¥é‡ â†‘ Î»_bboxï¼ˆå¦‚ 1.5 â†’ 2.0ï¼‰ æ£€æµ‹æ¡†å¾ˆå‡†ä½†æ¼æ£€å¤š â†“ Î»_bboxï¼Œâ†‘ Î»_cls åˆ†ç±»å‡†ç¡®ä½†æ¡†ä¸å‡† â†‘ Î»_bbox æ¡†å‡†ä½†åˆ†ç±»é”™ä¹± â†“ Î»_bboxï¼Œæ£€æŸ¥ç±»åˆ«æƒé‡ âœ… å»ºè®®ï¼šä¼˜å…ˆä½¿ç”¨ IoU-based Lossï¼ˆGIoU/DIoUï¼‰ï¼Œå…¶å¤©ç„¶ä¸ä½ç½®ç›¸å…³ï¼Œå¯å‡å°‘å¯¹ Î»_bbox çš„ä¾èµ–ã€‚\n10. ç±»åˆ«å¤´éƒ¨æƒé‡ï¼ˆClass Head Weightï¼‰ âœ… å®šä¹‰ï¼š åœ¨æ€»æŸå¤±å‡½æ•°ä¸­ï¼Œåˆ†ç±»æŸå¤±æ‰€å çš„æ¯”é‡ã€‚\nğŸ“Œ ä¸ä¸Šä¸€é¡¹ååŒå·¥ä½œï¼š æ§åˆ¶â€œåˆ†ç±» vs å®šä½â€çš„è®­ç»ƒä¼˜å…ˆçº§ ğŸ’¡ å®é™…å½±å“ï¼š Î»_cls æ•ˆæœ 0.1 æ¨¡å‹ä¸å…³å¿ƒç±»åˆ«ï¼Œå…¨åˆ¤ä¸ºä¸€ç±»ï¼ˆé€€åŒ–ä¸ºåˆ†å‰²ï¼‰ 1.0 é»˜è®¤å‡è¡¡ 2.0 æ¨¡å‹åŠªåŠ›åˆ†æ¸…ç±»åˆ«ï¼Œä½†å¯èƒ½å¿½ç•¥å®šä½ 5.0 è¿‡æ‹Ÿåˆç±»åˆ«ï¼Œå¯¼è‡´é«˜ç½®ä¿¡åº¦è¯¯æ£€ ğŸ”§ è°ƒä¼˜å»ºè®®ï¼š é—®é¢˜ç°è±¡ è§£å†³æ–¹æ¡ˆ åˆ†ç±»é”™è¯¯å¤šï¼ˆæŠŠçŒ«å½“ç‹—ï¼‰ â†‘ Î»_cls æ£€æµ‹æ¡†å‡†ä½†æ ‡ç­¾é”™ â†‘ Î»_cls ç±»åˆ«ä¸å¹³è¡¡ï¼ˆ90% æ­£å¸¸ï¼‰ ç»“åˆ è‡ªå®šä¹‰ç±»åˆ«æƒé‡ï¼Œè€Œéå•çº¯è°ƒ Î»_cls æ³¨æ„ Î»_cls ä¸ è‡ªå®šä¹‰ç±»åˆ«æƒé‡ æ˜¯ä¸¤ä¸ªç‹¬ç«‹æœºåˆ¶ï¼š\nâ€¢ Î»_clsï¼šæ§åˆ¶åˆ†ç±»æŸå¤±çš„æ•´ä½“æƒé‡\nâ€¢ ç±»åˆ«æƒé‡ï¼šæ§åˆ¶æ¯ä¸ªç±»åˆ«çš„æŸå¤±è´¡çŒ® 11. å†»ç»“éª¨å¹²çº§åˆ«ï¼ˆFreeze Backbone Levelï¼‰ âœ… å®šä¹‰ï¼š åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œä»è¾“å…¥ç«¯èµ·ï¼Œå†»ç»“éª¨å¹²ç½‘ç»œï¼ˆBackboneï¼‰çš„æœ€é«˜å±‚çº§ç¼–å·ã€‚\nğŸ“Œ ä¸¾ä¾‹ï¼š éª¨å¹²ç»“æ„ï¼šconv1 â†’ layer1 â†’ layer2 â†’ layer3 â†’ layer4 Freeze Backbone Level = 2 â†’ å†»ç»“ layer2 åŠä»¥ä¸Šå±‚ï¼ˆå³ layer2, layer3, layer4ï¼‰ Freeze Backbone Level = 0 â†’ ä¸å†»ç»“ä»»ä½•å±‚ï¼ˆå…¨è®­ç»ƒï¼‰ âš™ï¸ å·¥ä½œæœºåˆ¶ï¼š å†»ç»“å±‚ï¼šæƒé‡ä¸å˜ï¼Œæ¢¯åº¦ä¸åä¼  æœªå†»ç»“å±‚ï¼šæ­£å¸¸æ›´æ–° ğŸ’¡ å®é™…å½±å“ï¼š è®¾ç½® é€‚ç”¨åœºæ™¯ é£é™© 0 æ•°æ®å……è¶³ã€ä»é›¶è®­ç»ƒã€è¾“å…¥é€šé“å˜åŒ– æ˜“è¿‡æ‹Ÿåˆã€è®­ç»ƒæ…¢ 1~3 é¢„è®­ç»ƒæ¨¡å‹ + å¾®è°ƒã€æ•°æ®é‡ä¸­ç­‰ âœ… æ¨èï¼ 4+ï¼ˆæ¥è¿‘é¡¶å±‚ï¼‰ ä»…è®­ç»ƒæ£€æµ‹å¤´ æ¨¡å‹è¡¨è¾¾åŠ›å—é™ï¼Œæ€§èƒ½ä¸‹é™ å…¨éƒ¨å†»ç»“ æ¨ç†é˜¶æ®µ è®­ç»ƒæ—¶ä¸å¯ç”¨ ğŸ”§ è°ƒä¼˜å»ºè®®ï¼š åœºæ™¯ æ¨èå†»ç»“çº§åˆ« è¯´æ˜ ä½¿ç”¨ ImageNet é¢„è®­ç»ƒæ¨¡å‹ 2 æˆ– 3 ä¿ç•™é«˜å±‚è¯­ä¹‰ï¼Œå¾®è°ƒæµ…å±‚é€‚åº”æ–°æ•°æ® è¾“å…¥é€šé“ä¸åŒï¼ˆå¦‚çº¢å¤–å›¾ï¼‰ 0 å¿…é¡»é‡æ–°è®­ç»ƒå…¨éƒ¨æƒé‡ æ•°æ®æå°‘ï¼ˆ\u0026lt;500 å›¾ï¼‰ 3 ä»…è®­ç»ƒæ£€æµ‹å¤´ï¼Œé¿å…ç¾éš¾æ€§é—å¿˜ é¢„è®­ç»ƒæ¨¡å‹ä¸å½“å‰ä»»åŠ¡å·®å¼‚å¤§ 0 é‡æ–°åˆå§‹åŒ–å¹¶è®­ç»ƒ æ³¨æ„ â—å†»ç»“åï¼Œå¿…é¡»ä½¿ç”¨æ›´ä½çš„å­¦ä¹ ç‡ï¼ˆå¦‚ 1e-5ï¼‰è®­ç»ƒæ£€æµ‹å¤´ âœ… æœ€ä½³å®è·µï¼š\nâ€œå†»ç»“éª¨å¹² + æ£€æµ‹å¤´å•ç‹¬å­¦ä¹ ç‡â€ æ˜¯å·¥ä¸šç•Œæ ‡å‡†åšæ³•ï¼\nâœ… æ€»ç»“ï¼šç›®æ ‡æ£€æµ‹å‚æ•°è°ƒä¼˜ç»ˆæ Checklist å‚æ•° æ¨èåˆå§‹å€¼ è°ƒä¼˜æ–¹å‘ å…³é”®å½±å“ å®¹é‡ ä¸­ â†‘ ç”¨äºå¤æ‚/å°ç›®æ ‡ï¼Œâ†“ ç”¨äºå®æ—¶ è¡¨è¾¾èƒ½åŠ› Min Level 2 â†“ ç”¨äºå°ç‰©ä½“ï¼Œâ†‘ ç”¨äºåŠ é€Ÿ å°ç‰©ä½“æ£€æµ‹èƒ½åŠ› Max Level 5 â†‘ ç”¨äºå¤§ç‰©ä½“ï¼Œâ†“ ç”¨äºè½»é‡ å¤§ç‰©ä½“è¦†ç›– å­å°ºåº¦é”šæ•° 3 â†‘ ç”¨äºå¼‚å½¢ç›®æ ‡ é”šè¦†ç›–å¯†åº¦ é”šé•¿å®½æ¯” [0.5,1,2] æ ¹æ®çœŸå®æ¡†èšç±»è°ƒæ•´ å½¢çŠ¶é€‚é…æ€§ é”šè§’åº¦ [-45Â°, 0Â°, 45Â°] ä»…ç”¨äºå€¾æ–œç›®æ ‡ æ—‹è½¬é²æ£’æ€§ å¿½ç•¥æ–¹å‘ âŒ å…³é—­ ä»…å½“ç›®æ ‡æ— æœå‘æ—¶å¼€å¯ é”šæ•°é‡æ§åˆ¶ æƒé‡å…ˆéªŒ Î± 0.0001 â†‘ é˜²è¿‡æ‹Ÿåˆï¼Œâ†“ é˜²æ¬ æ‹Ÿåˆ æ­£åˆ™å¼ºåº¦ BBox æƒé‡ 1.0 â†‘ å¦‚æœæ¡†ä¸å‡† å®šä½ç²¾åº¦ Class æƒé‡ 1.0 â†‘ å¦‚æœåˆ†ç±»é”™å¤š åˆ†ç±»å‡†ç¡®æ€§ å†»ç»“éª¨å¹² 2ï¼ˆé¢„è®­ç»ƒï¼‰ æ•°æ®å°‘æ—¶ â†‘ï¼Œæ•°æ®å¤šæ—¶ 0 è®­ç»ƒç¨³å®šæ€§ ğŸ“Œ é™„ï¼šè°ƒè¯•æµç¨‹å»ºè®®ï¼ˆå®æˆ˜æŒ‡å—ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 graph TD A[å¼€å§‹è®­ç»ƒ] --\u0026gt; B{éªŒè¯é›† mAP æ˜¯å¦è¾¾æ ‡ï¼Ÿ} B -- å¦ --\u0026gt; C[æ£€æŸ¥ Min/Max Level æ˜¯å¦è¦†ç›–ç›®æ ‡å°ºå¯¸] C --\u0026gt; D[å¢åŠ å­å°ºåº¦é”šæˆ–é•¿å®½æ¯”] D --\u0026gt; E[æ£€æŸ¥æ˜¯å¦æ¼æ£€å°/å¤§ç‰©ä½“] E --\u0026gt; F[è°ƒæ•´ MinLevel/MaxLevel] F --\u0026gt; B B -- æ˜¯ --\u0026gt; G{æ˜¯å¦å¤Ÿå¿«ï¼Ÿ} G -- å¦ --\u0026gt; H[é™ä½å®¹é‡ / å¢å¤§ MinLevel / å‡å°‘é”šæ•°] H --\u0026gt; I[é‡æ–°è¯„ä¼° mAP] I --\u0026gt; B G -- æ˜¯ --\u0026gt; J{æ˜¯å¦æœ‰è¿‡æ‹Ÿåˆï¼Ÿ} J -- æ˜¯ --\u0026gt; K[å¢å¤§æƒé‡å…ˆéªŒ Î± / å†»ç»“éª¨å¹²] K --\u0026gt; L[é™ä½å­¦ä¹ ç‡] L --\u0026gt; B J -- å¦ --\u0026gt; M[å®Œæˆï¼éƒ¨ç½²] ğŸ” é”šï¼ˆAnchorï¼‰åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿâ€”â€”æ·±åº¦è¯¦è§£ âœ… ä¸€å¥è¯å®šä¹‰ï¼š\né”šï¼ˆAnchorï¼‰æ˜¯ç›®æ ‡æ£€æµ‹æ¨¡å‹åœ¨ç‰¹å¾å›¾ä¸Šé¢„è®¾çš„ã€å›ºå®šå¤§å°å’Œå½¢çŠ¶çš„â€œå‚è€ƒæ¡†â€ï¼Œç”¨äºæŒ‡å¯¼æ¨¡å‹é¢„æµ‹çœŸå®ç‰©ä½“çš„ä½ç½®ä¸ç±»åˆ«ã€‚\nå®ƒä¸æ˜¯çœŸå®å­˜åœ¨çš„ç‰©ä½“è¾¹ç•Œæ¡†ï¼Œè€Œæ˜¯æ¨¡å‹å­¦ä¹ çš„â€œå…ˆéªŒå‡è®¾â€ â€”â€” åƒæ˜¯ç»™æ¨¡å‹æä¾›ä¸€ç»„â€œå€™é€‰æ¨¡æ¿â€ï¼Œè®©æ¨¡å‹åªéœ€å­¦ä¹ â€œå¦‚ä½•è°ƒæ•´è¿™äº›æ¨¡æ¿â€ï¼Œè€Œä¸æ˜¯ä»é›¶å¼€å§‹çŒœä¸€ä¸ªæ¡†ã€‚\nğŸ§© ä¸€ã€é”šçš„èµ·æºï¼šä¸ºä»€ä¹ˆéœ€è¦ Anchorï¼Ÿ â“ é—®é¢˜èƒŒæ™¯ï¼š åœ¨ç›®æ ‡æ£€æµ‹ä¸­ï¼Œæ¨¡å‹éœ€è¦è¾“å‡ºå›¾åƒä¸­æ¯ä¸ªç›®æ ‡çš„ï¼š\nä½ç½®ï¼šçŸ©å½¢æ¡† (x, y, w, h) ç±»åˆ«ï¼šå¦‚â€œäººâ€ã€â€œè½¦â€ã€â€œç¼ºé™·â€ ä½†ç›´æ¥é¢„æµ‹ä»»æ„ä½ç½®ã€ä»»æ„å°ºå¯¸çš„çŸ©å½¢æ¡†æ˜¯æå…¶å›°éš¾çš„ï¼Œå› ä¸ºï¼š\næŒ‘æˆ˜ è¯´æ˜ ç©ºé—´å·¨å¤§ ä¸€å¼  640Ã—640 å›¾åƒï¼Œå¯èƒ½çš„çŸ©å½¢æ•°é‡ â‰ˆ 10â¹ ä¸ª å°ºå¯¸å¤šæ · ç‰©ä½“å¯å¤§å¯å°ï¼ˆä»å‡ åƒç´ åˆ°æ•´å›¾ï¼‰ å½¢çŠ¶å„å¼‚ æ­£æ–¹å½¢ã€é•¿æ¡å½¢ã€å€¾æ–œçš„â€¦â€¦ â†’ å¦‚æœè®©æ¨¡å‹ç›´æ¥å›å½’ä»»æ„æ¡†ï¼Œè®­ç»ƒä¼šä¸ç¨³å®šã€æ”¶æ•›æ…¢ã€ç²¾åº¦å·®ã€‚\nâœ… è§£å†³æ–¹æ¡ˆï¼šå¼•å…¥ Anchor è®©æ¨¡å‹ä¸è¦ä»é›¶ç”Ÿæˆæ¡†ï¼Œè€Œæ˜¯åŸºäºä¸€ç»„é¢„è®¾çš„â€œæ¨¡æ¿æ¡†â€åšå¾®è°ƒã€‚\nå°±åƒä½ ç»™ä¸€ä¸ªå­©å­çœ‹ 10 ç§ä¸åŒå¤§å°å’Œå½¢çŠ¶çš„â€œç›’å­æ ·æ¿â€ï¼Œç„¶åè¯´ï¼šâ€œä½ çœ‹åˆ°çš„ä¸œè¥¿ï¼Œä¸€å®šæ˜¯è¿™ 10 ç§ä¹‹ä¸€çš„å˜å½¢ã€‚â€\nè¿™å°±æ˜¯ Anchor çš„æ€æƒ³ã€‚\nğŸ“ äºŒã€Anchor çš„ç»“æ„ç»„æˆ ä¸€ä¸ª Anchor æ˜¯ä¸€ä¸ªè½´å¯¹é½çš„çŸ©å½¢ï¼ˆé™¤éä½¿ç”¨æ—‹è½¬é”šï¼‰ï¼Œç”±ä»¥ä¸‹å‚æ•°å®šä¹‰ï¼š\nå‚æ•° å«ä¹‰ ç¤ºä¾‹å€¼ ä¸­å¿ƒç‚¹ (cx, cy) åœ¨ç‰¹å¾å›¾ä¸Šçš„ä½ç½®åæ ‡ å¦‚ (50, 70) å®½åº¦ (w) é”šæ¡†çš„å®½ï¼ˆåƒç´ æˆ–ç›¸å¯¹å°ºåº¦ï¼‰ 32px é«˜åº¦ (h) é”šæ¡†çš„é«˜ 32px é•¿å®½æ¯” (aspect ratio) h : w 1:1, 1:2, 2:1 å°ºåº¦ (scale) ç›¸å¯¹äºåŸºç¡€å°ºå¯¸çš„ç¼©æ”¾å€æ•° 0.5Ã—, 1.0Ã—, 2.0Ã— è§’åº¦ (Î¸) ï¼ˆä»…è‡ªç”±çŸ©å½¢ï¼‰ç›¸å¯¹äºæ°´å¹³è½´çš„æ—‹è½¬è§’ -45Â°, 0Â°, +45Â° ğŸ’¡ æ³¨æ„ï¼šAnchor ä¸æ˜¯å›¾åƒä¸­çš„çœŸå®æ¡†ï¼Œå®ƒæ˜¯åœ¨ç‰¹å¾å›¾ç½‘æ ¼ä¸Šå¯†é›†ç”Ÿæˆçš„è™šæ‹Ÿæ¡†ã€‚\nğŸŒ ä¸‰ã€Anchor å¦‚ä½•ç”Ÿæˆï¼Ÿâ€”â€”ä»¥ FPN ä¸ºä¾‹ æˆ‘ä»¬ä»¥å…¸å‹çš„ RetinaNet + FPN æ¶æ„ä¸ºä¾‹ï¼š\næ­¥éª¤ 1ï¼šæå–å¤šçº§ç‰¹å¾å›¾ è¾“å…¥å›¾åƒ â†’ éª¨å¹²ç½‘ç»œï¼ˆå¦‚ ResNetï¼‰â†’ è¾“å‡ºå¤šä¸ªå±‚çº§çš„ç‰¹å¾å›¾ï¼š\nç‰¹å¾çº§åˆ« ä¸‹é‡‡æ ·å€æ•° ç‰¹å¾å›¾å°ºå¯¸ï¼ˆ640Ã—640 è¾“å…¥ï¼‰ P3 Ã—8 80 Ã— 80 P4 Ã—16 40 Ã— 40 P5 Ã—32 20 Ã— 20 æ¯ä¸€å±‚å¯¹åº”ä¸åŒå°ºåº¦çš„ç›®æ ‡ï¼šP3 æ£€æµ‹å°ç‰©ä½“ï¼ŒP5 æ£€æµ‹å¤§ç‰©ä½“ã€‚\næ­¥éª¤ 2ï¼šåœ¨æ¯ä¸ªç‰¹å¾ç‚¹ä¸Šç”Ÿæˆå¤šä¸ª Anchor æ¯ä¸ªç‰¹å¾å›¾å•å…ƒï¼ˆcellï¼‰ä»£è¡¨åŸå›¾çš„ä¸€ä¸ªåŒºåŸŸï¼ˆå¦‚ P3 ä¸Šæ¯ä¸ª cell = 8Ã—8 åƒç´ ï¼‰ åœ¨æ¯ä¸ª cell ä¸­ï¼Œç”Ÿæˆ N_scales Ã— N_ratios ä¸ª Anchor âœ… ç¤ºä¾‹é…ç½®ï¼š 1 2 3 scales = [0.5, 1.0, 2.0] # 3 ç§å°ºå¯¸ ratios = [0.5, 1.0, 2.0] # 3 ç§é•¿å®½æ¯” â†’ æ¯ä¸ªç‰¹å¾ç‚¹ç”Ÿæˆ 3 Ã— 3 = 9 ä¸ª Anchor ğŸ–¼ï¸ å¯è§†åŒ–æ•ˆæœï¼ˆä¸€ä¸ªç‰¹å¾ç‚¹ï¼‰ï¼š 1 2 3 4 5 6 7 â–² â”‚ â– â– â– â– â– â–  â† å®½é«˜æ¯”=2:1ï¼ˆæ¨ªå‘é•¿ï¼‰ â”‚ â– â– â– â– â– â– â– â–  â† å®½é«˜æ¯”=1:1ï¼ˆæ­£æ–¹å½¢ï¼‰ â”‚ â– â– â– â–  â† å®½é«˜æ¯”=1:2ï¼ˆç«–å‘é•¿ï¼‰ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ä¸‰ç§å°ºåº¦ï¼ˆå°ã€ä¸­ã€å¤§ï¼‰å„ä¸€å¥— æ¯ä¸ª Anchor éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„â€œåŸºå°ºå¯¸â€ï¼ˆæ¯”å¦‚ 32Ã—32ï¼‰ï¼Œå†ä¹˜ä»¥ scale å’Œ ratio å¾—åˆ°æœ€ç»ˆå°ºå¯¸ã€‚\næ­¥éª¤ 3ï¼šAnchor æ€»æ•°æƒŠäººï¼ ç‰¹å¾å±‚ å°ºå¯¸ æ¯ç‚¹é”šæ•° æ€»é”šæ•° P3 80Ã—80 9 80Ã—80Ã—9 = 57,600 P4 40Ã—40 9 40Ã—40Ã—9 = 14,400 P5 20Ã—20 9 20Ã—20Ã—9 = 3,600 æ€»è®¡ â€” â€” 75,600 ä¸ª Anchor ğŸ‘‰ ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¨¡å‹åœ¨ä¸€å¼ å›¾ä¸Šä¸€æ¬¡æ€§è€ƒè™‘äº†è¶…è¿‡ 7 ä¸‡ä¸ªå€™é€‰æ¡†ï¼\nä½†ä¸ç”¨æ‹…å¿ƒï¼šåç»­é€šè¿‡ éæå¤§å€¼æŠ‘åˆ¶ï¼ˆNMSï¼‰ å’Œ IoU åŒ¹é…æœºåˆ¶ï¼Œåªä¿ç•™æœ€å¯èƒ½çš„å‡ åä¸ªç»“æœã€‚\nâš™ï¸ å››ã€Anchor çš„ä½œç”¨æœºåˆ¶ï¼šå¦‚ä½•å·¥ä½œï¼Ÿ âœ… æ¨¡å‹è¾“å‡ºä¸æ˜¯ç›´æ¥é¢„æµ‹æ¡†ï¼Œè€Œæ˜¯é¢„æµ‹åç§»é‡ æ¨¡å‹ä¸ºæ¯ä¸ª Anchor è¾“å‡ºï¼š\nÎ”cx, Î”cy â†’ ä¸­å¿ƒç‚¹åç§» Î”w, Î”h â†’ å®½åº¦å’Œé«˜åº¦çš„ç¼©æ”¾å› å­ Î”Î¸ â†’ æ—‹è½¬è§’åº¦ï¼ˆè‹¥å¯ç”¨ï¼‰ è¿™äº›åç§»é‡æ˜¯ç›¸å¯¹äº Anchor çš„ä¿®æ­£å€¼ï¼\nğŸ“Œ å…¬å¼ç¤ºä¾‹ï¼ˆç»å…¸ RPN / RetinaNetï¼‰ï¼š 1 2 3 4 predicted_x = anchor_cx + Î”cx * anchor_w predicted_y = anchor_cy + Î”cy * anchor_h predicted_w = anchor_w * exp(Î”w) predicted_h = anchor_h * exp(Î”h) æ‰€ä»¥æ¨¡å‹å­¦çš„æ˜¯ï¼šâ€œè¿™ä¸ª Anchor åº”è¯¥å¾€å“ªç§»åŠ¨ã€æ”¾å¤§å¤šå°‘â€ï¼Œè€Œä¸æ˜¯â€œä»å¤´ç”»ä¸€ä¸ªæ¡†â€ã€‚\nâœ… åŒ¹é…è¿‡ç¨‹ï¼ˆTrainingï¼‰ï¼š å¯¹æ¯ä¸ªçœŸå®æ ‡æ³¨æ¡†ï¼ˆGround Truthï¼‰ï¼Œæ‰¾åˆ°ä¸å…¶ IoU æœ€å¤§çš„ Anchorï¼› è‹¥ IoU \u0026gt; é˜ˆå€¼ï¼ˆå¦‚ 0.7ï¼‰â†’ æ ‡è®°ä¸º æ­£æ ·æœ¬ï¼ˆPositiveï¼‰ï¼› è‹¥ IoU \u0026lt; é˜ˆå€¼ï¼ˆå¦‚ 0.3ï¼‰â†’ æ ‡è®°ä¸º è´Ÿæ ·æœ¬ï¼ˆNegativeï¼‰ï¼› æ¨¡å‹å­¦ä¹ ï¼š æ­£æ ·æœ¬ï¼šé¢„æµ‹æ­£ç¡®çš„åç§»é‡ è´Ÿæ ·æœ¬ï¼šé¢„æµ‹â€œæ— ç›®æ ‡â€ï¼ˆèƒŒæ™¯ï¼‰ ğŸ‘‰ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Anchor æ˜¯â€œå…ˆéªŒâ€çš„æ„ä¹‰ï¼šå®ƒæŠŠæ— é™ç©ºé—´æœç´¢å˜æˆæœ‰é™å±€éƒ¨ä¼˜åŒ–ï¼\nğŸ”„ äº”ã€Anchor vs Anchor-Freeï¼šå¯¹æ¯”æ€»ç»“ ç»´åº¦ Anchor-Based æ–¹æ³• Anchor-Free æ–¹æ³• ä»£è¡¨æ¨¡å‹ Faster R-CNNã€SSDã€RetinaNet FCOSã€CenterNetã€YOLOv8ï¼ˆéƒ¨åˆ†ï¼‰ã€DETR æ˜¯å¦é¢„è®¾æ¡† âœ… æ˜¯ âŒ å¦ é¢„æµ‹å†…å®¹ Anchor çš„åç§»é‡ ç‰¹å¾ç‚¹åˆ°è¾¹ç•Œçš„è·ç¦» / ä¸­å¿ƒç‚¹çƒ­åŠ›å›¾ è®¡ç®—å¤æ‚åº¦ é«˜ï¼ˆæ•°ä¸‡ Anchorï¼‰ ä½ï¼ˆä»…ç‰¹å¾ç‚¹ï¼‰ è®­ç»ƒç¨³å®šæ€§ é«˜ï¼ˆæœ‰æ˜ç¡®åŒ¹é…ï¼‰ ä½ï¼ˆéœ€ç²¾å¿ƒè®¾è®¡æŸå¤±å‡½æ•°ï¼‰ å°ç‰©ä½“æ£€æµ‹ âœ… æ›´å¥½ï¼ˆå¯†é›†é”šè¦†ç›–ï¼‰ âš ï¸ è¾ƒéš¾ï¼ˆä¾èµ–åˆ†è¾¨ç‡ï¼‰ éƒ¨ç½²é€Ÿåº¦ æ…¢ï¼ˆéœ€ NMSï¼‰ å¿«ï¼ˆæ—  NMS æˆ–è½»é‡ NMSï¼‰ é€‚ç”¨åœºæ™¯ å·¥ä¸šè´¨æ£€ã€ç²¾å‡†å®šä½ å®æ—¶ç³»ç»Ÿã€ç§»åŠ¨ç«¯ã€ç®€å•ç›®æ ‡ âœ… ç»“è®ºï¼š\nAnchor æ˜¯â€œç¨³è€Œé‡â€ï¼Œé€‚åˆå¯¹ç²¾åº¦è¦æ±‚é«˜çš„å·¥ä¸šåœºæ™¯ï¼›\nAnchor-Free æ˜¯â€œè½»è€Œå¿«â€ï¼Œé€‚åˆå®æ—¶æˆ–èµ„æºå—é™ç¯å¢ƒã€‚\nğŸ¯ å…­ã€Anchor çš„ä¼˜ç¼ºç‚¹æ€»ç»“ âœ… ä¼˜ç‚¹ âŒ ç¼ºç‚¹ âœ… è®­ç»ƒç¨³å®šï¼Œæ”¶æ•›å¿« âŒ ç”Ÿæˆå¤§é‡å†—ä½™ Anchorï¼ˆæµªè´¹æ˜¾å­˜ï¼‰ âœ… å¯¹å°ç‰©ä½“æ£€æµ‹æ•ˆæœå¥½ âŒ è¶…å‚æ•°æ•æ„Ÿï¼ˆscale/ratio/level éœ€ä»”ç»†è°ƒï¼‰ âœ… æ˜“äºè§£é‡Šå’Œå¯è§†åŒ– âŒ éš¾ä»¥é€‚åº”æç«¯å½¢çŠ¶ï¼ˆå¦‚ä¸è§„åˆ™è½®å»“ï¼‰ âœ… ä¸ä¼ ç»Ÿæ–¹æ³•å…¼å®¹æ€§å¥½ âŒ éœ€è¦æ‰‹åŠ¨è®¾è®¡æˆ–èšç±»é”šæ¡†åˆ†å¸ƒ âœ… æ”¯æŒæ—‹è½¬é”šï¼ˆOBBï¼‰ âŒ æ— æ³•å¤„ç†â€œæ— å›ºå®šå½¢çŠ¶â€ç›®æ ‡ï¼ˆå¦‚äº‘ã€çƒŸé›¾ï¼‰ ğŸ§  ä¸ƒã€ç±»æ¯”ç†è§£ï¼šAnchor å°±åƒâ€œåœ°å›¾ä¸Šçš„ç½‘æ ¼æ ‡è®°â€ æƒ³è±¡ä½ åœ¨æ‰¾ä¸€ä¸ªä¸¢å¤±çš„æ‰‹æœºï¼š\nAnchor-Free æ–¹æ³•ï¼šä½ ç«™åœ¨è¡—ä¸Šï¼Œå‡­æ„Ÿè§‰è¯´ï¼šâ€œå®ƒå¤§æ¦‚åœ¨è¿™ç‰‡åŒºåŸŸã€‚â€ â†’ ç„¶åæ…¢æ…¢æœã€‚ Anchor-Based æ–¹æ³•ï¼šä½ æå‰åœ¨åœ°å›¾ä¸Šç”»äº† 100 ä¸ªæ–¹æ ¼å­ï¼ˆæ¯ä¸ª 1mÃ—1mï¼‰ï¼Œç„¶åè¯´ï¼šâ€œæˆ‘çš„æ‰‹æœºè¦ä¹ˆåœ¨ç¬¬ 3 è¡Œç¬¬ 5 åˆ—é‚£ä¸ªæ ¼å­é‡Œï¼Œç¨å¾®åå·¦ä¸€ç‚¹ã€‚â€ â†’ ä½ ä¸éœ€è¦éå†æ•´ä¸ªåŸå¸‚ï¼Œåªéœ€è¦æ£€æŸ¥é‚£ 100 ä¸ªæ ¼å­ï¼Œå†å¾®è°ƒä½ç½®ã€‚\nè¿™å°±æ˜¯ Anchor çš„æ™ºæ…§ï¼šç”¨å…ˆéªŒç¼©å°æœç´¢ç©ºé—´ï¼Œæå‡æ•ˆç‡å’Œç²¾åº¦ã€‚\nğŸ“Œ å…«ã€å®æˆ˜å»ºè®®ï¼šå¦‚ä½•é€‰æ‹©åˆé€‚çš„ Anchorï¼Ÿ åœºæ™¯ æ¨èç­–ç•¥ å·¥ä¸šç¼ºé™·æ£€æµ‹ ä½¿ç”¨å¤šå°ºåº¦ + å¤šé•¿å®½æ¯”ï¼ˆå¦‚ scales=[0.5,1,2], ratios=[0.3,0.5,1,2,3]ï¼‰+ å…³é—­å¿½ç•¥æ–¹å‘ æ–‡å­—æ£€æµ‹ ä½¿ç”¨é”šè§’åº¦ [-45Â°, 0Â°, 45Â°] + é«˜é•¿å®½æ¯”ï¼ˆå¦‚ 1:5ï¼‰ è¡Œäºº/è½¦è¾†æ£€æµ‹ æ ‡å‡†è®¾ç½®ï¼šscales=[1.0], ratios=[0.5,1,2]ï¼ŒMinLevel=2ï¼ŒMaxLevel=5 æ•°æ®å°‘ ä½¿ç”¨é¢„è®­ç»ƒ Anchorï¼ˆCOCO èšç±»ï¼‰+ å†»ç»“éª¨å¹² æƒ³æé€Ÿ å‡å°‘é”šæ•°é‡ï¼ˆå¦‚åªç”¨ 3 ä¸ª/ç‚¹ï¼‰æˆ–æ”¹ç”¨ Anchor-Freeï¼ˆå¦‚ YOLOv8ï¼‰ ä¸ç¡®å®šæ€ä¹ˆè®¾ ç”¨ K-Means èšç±»ä½ çš„æ ‡æ³¨æ¡†ï¼è¿™æ˜¯ä¸šç•Œæœ€ä½³å®è·µ ","date":"2025-09-15T10:21:49+08:00","image":"https://www.notion.so/images/page-cover/webb2.jpg","permalink":"https://dumbnessrf.github.io/p/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E5%BF%B5/","title":"æ·±åº¦å­¦ä¹ çš„ä¸€äº›ç†å¿µ"},{"content":"ğŸ§µ .NET å¹¶å‘ç¼–ç¨‹åˆ©å™¨è¯¦è§£ é™„ï¼švolatile ä¸ Interlocked åœ¨å¹¶å‘æ§åˆ¶ä¸­çš„å…³é”®ä½œç”¨\nğŸ“Œ å¼•è¨€ï¼šä¸ºä»€ä¹ˆéœ€è¦å¹¶å‘é›†åˆï¼Ÿ åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å¤šä¸ªçº¿ç¨‹å®‰å…¨åœ°å…±äº«æ•°æ® â€”â€” æ¯”å¦‚ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ã€ä»»åŠ¡é˜Ÿåˆ—ã€ç¼“å­˜å­—å…¸ã€é™æµæ§åˆ¶ç­‰ã€‚å¦‚æœä½¿ç”¨æ™®é€šé›†åˆï¼ˆå¦‚ List\u0026lt;T\u0026gt;ã€Queue\u0026lt;T\u0026gt;ã€Dictionary\u0026lt;TKey, TValue\u0026gt;ï¼‰ï¼Œåœ¨å¹¶å‘è¯»å†™æ—¶ææ˜“å¼•å‘ï¼š\nâŒ æ•°æ®ç«äº‰ï¼ˆRace Conditionï¼‰ âŒ é›†åˆå†…éƒ¨ç»“æ„æŸåï¼ˆå¦‚å“ˆå¸Œè¡¨ rehash æ—¶è¢«å¤šçº¿ç¨‹ä¿®æ”¹ï¼‰ âŒ ç¨‹åºå´©æºƒæˆ–æ•°æ®ä¸ä¸€è‡´ .NET æä¾›äº† System.Collections.Concurrent å‘½åç©ºé—´ä¸‹çš„çº¿ç¨‹å®‰å…¨é›†åˆç±»ï¼Œä¸“ä¸ºé«˜å¹¶å‘åœºæ™¯è®¾è®¡ï¼Œæ— éœ€æ‰‹åŠ¨åŠ é”å³å¯å®‰å…¨ä½¿ç”¨ã€‚\næœ¬æ–‡å°†æ·±å…¥è®²è§£ï¼š\nâœ… ConcurrentQueue\u0026lt;T\u0026gt;ã€ConcurrentStack\u0026lt;T\u0026gt;ã€ConcurrentDictionary\u0026lt;TKey, TValue\u0026gt; âœ… BlockingCollection\u0026lt;T\u0026gt; ä¸å®ƒä»¬çš„å…³ç³» âœ… SemaphoreSlim å¦‚ä½•æ§åˆ¶å¹¶å‘åº¦ âœ… volatile ä¸ Interlocked åœ¨å¹¶å‘ç¼–ç¨‹ä¸­çš„å…³é”®ä½œç”¨ âœ… å®æˆ˜ç¤ºä¾‹ + æœ€ä½³å®è·µ ğŸ§© ä¸€ã€ä¸‰å¤§åŸºç¡€å¹¶å‘é›†åˆ 1. ConcurrentQueue\u0026lt;T\u0026gt; â€”â€” çº¿ç¨‹å®‰å…¨çš„å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ— ç‰¹ç‚¹ï¼š\nFIFOï¼ˆFirst In, First Outï¼‰ æ— é”æˆ–ç»†ç²’åº¦é”å®ç°ï¼Œé«˜æ€§èƒ½ æ”¯æŒå¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€… å¸¸ç”¨æ–¹æ³•ï¼š\nEnqueue(T item) â€” å…¥é˜Ÿ TryDequeue(out T result) â€” å‡ºé˜Ÿï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ IsEmpty â€” æ˜¯å¦ä¸ºç©ºï¼ˆæ³¨æ„ï¼šå¯èƒ½ç¬æ—¶ä¸å‡†ï¼Œä»…ä½œå‚è€ƒï¼‰ ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 var queue = new ConcurrentQueue\u0026lt;int\u0026gt;(); // ç”Ÿäº§è€…çº¿ç¨‹ Task.Run(() =\u0026gt; { for (int i = 1; i \u0026lt;= 5; i++) { queue.Enqueue(i); Console.WriteLine($\u0026#34;ç”Ÿäº§: {i}\u0026#34;); Thread.Sleep(100); } }); // æ¶ˆè´¹è€…çº¿ç¨‹ Task.Run(() =\u0026gt; { while (true) { if (queue.TryDequeue(out var item)) { Console.WriteLine($\u0026#34;æ¶ˆè´¹: {item}\u0026#34;); } else if (queue.IsEmpty) break; // æ³¨æ„ï¼šæ­¤å¤„å¯èƒ½æœ‰ç«æ€ï¼Œä»…æ¼”ç¤º Thread.Sleep(50); } }); Thread.Sleep(2000); âœ… é€‚ç”¨åœºæ™¯ï¼šä»»åŠ¡é˜Ÿåˆ—ã€æ¶ˆæ¯ç¼“å†²ã€æ—¥å¿—æ”¶é›†ç­‰\n2. ConcurrentStack\u0026lt;T\u0026gt; â€”â€” çº¿ç¨‹å®‰å…¨çš„åè¿›å…ˆå‡ºæ ˆ ç‰¹ç‚¹ï¼š\nLIFOï¼ˆLast In, First Outï¼‰ åŒæ ·æ”¯æŒå¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€… å¸¸ç”¨æ–¹æ³•ï¼š\nPush(T item) â€” å‹æ ˆ TryPop(out T result) â€” å¼¹æ ˆ ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 var stack = new ConcurrentStack\u0026lt;int\u0026gt;(); Task.Run(() =\u0026gt; { for (int i = 1; i \u0026lt;= 3; i++) { stack.Push(i); Console.WriteLine($\u0026#34;å‹æ ˆ: {i}\u0026#34;); } }); Task.Run(() =\u0026gt; { while (stack.TryPop(out var item)) { Console.WriteLine($\u0026#34;å¼¹æ ˆ: {item}\u0026#34;); Thread.Sleep(100); } }); Thread.Sleep(1000); âœ… é€‚ç”¨åœºæ™¯ï¼šæ’¤é”€æ“ä½œæ ˆã€å¯¹è±¡æ± ã€æ·±åº¦ä¼˜å…ˆéå†ç¼“å†²\n3. ConcurrentDictionary\u0026lt;TKey, TValue\u0026gt; â€”â€” çº¿ç¨‹å®‰å…¨å­—å…¸ ç‰¹ç‚¹ï¼š\nå†…éƒ¨ä½¿ç”¨åˆ†æ®µé”æˆ–æ— é”ç»“æ„ï¼ˆ.NET Core åä¼˜åŒ–æä½³ï¼‰ æ”¯æŒåŸå­æ“ä½œï¼šAddOrUpdate, GetOrAdd å¸¸ç”¨æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 var cache = new ConcurrentDictionary\u0026lt;string, string\u0026gt;(); // çº¿ç¨‹å®‰å…¨æ·»åŠ æˆ–è·å– var value = cache.GetOrAdd(\u0026#34;key\u0026#34;, k =\u0026gt; ComputeExpensiveValue(k)); // çº¿ç¨‹å®‰å…¨æ›´æ–° cache.AddOrUpdate(\u0026#34;counter\u0026#34;, 1, (key, oldValue) =\u0026gt; oldValue + 1); å®Œæ•´ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 var dict = new ConcurrentDictionary\u0026lt;string, int\u0026gt;(); Parallel.For(0, 1000, i =\u0026gt; { dict.AddOrUpdate(\u0026#34;count\u0026#34;, 1, (key, old) =\u0026gt; old + 1); }); Console.WriteLine($\u0026#34;æœ€ç»ˆè®¡æ•°: {dict[\u0026#34;count\u0026#34;]}\u0026#34;); // è¾“å‡ºï¼š1000ï¼ˆçº¿ç¨‹å®‰å…¨ç´¯åŠ ï¼‰ âœ… é€‚ç”¨åœºæ™¯ï¼šç¼“å­˜ã€è®¡æ•°å™¨ã€å…±äº«çŠ¶æ€å­˜å‚¨\nğŸš¦ äºŒã€BlockingCollection â€”â€” å¹¶å‘é›†åˆçš„â€œå¢å¼ºåŒ…è£…å™¨â€ â–¶ å®ƒæ˜¯ä»€ä¹ˆï¼Ÿ BlockingCollection\u0026lt;T\u0026gt; ä¸æ˜¯ä¸€ä¸ªæ–°çš„é›†åˆï¼Œè€Œæ˜¯ä¸€ä¸ªåŒ…è£…å™¨ï¼Œå®ƒä¸º IProducerConsumerCollection\u0026lt;T\u0026gt;ï¼ˆå¦‚ ConcurrentQueue\u0026lt;T\u0026gt;ï¼‰æ·»åŠ äº†ï¼š\nâœ… é˜»å¡æ“ä½œï¼ˆTake() ä¼šé˜»å¡ç›´åˆ°æœ‰æ•°æ®ï¼‰ âœ… é™ç•Œå®¹é‡ï¼ˆBounded Capacityï¼‰ âœ… å®Œæˆæ ‡è®°ï¼ˆCompleteAdding()ï¼‰ âœ… æšä¸¾æ”¯æŒï¼ˆGetConsumingEnumerable()ï¼‰ â–¶ ä¸ä¸‰å¤§é›†åˆçš„å…³ç³» åº•å±‚é›†åˆ è¡Œä¸º ConcurrentQueue\u0026lt;T\u0026gt; FIFO é˜»å¡é˜Ÿåˆ—ï¼ˆé»˜è®¤ï¼‰ ConcurrentStack\u0026lt;T\u0026gt; LIFO é˜»å¡æ ˆ ConcurrentBag\u0026lt;T\u0026gt; æ— åºé«˜æ€§èƒ½é˜»å¡åŒ… â–¶ ç¤ºä¾‹ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼ˆæ¨èå†™æ³•ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 var blockingCollection = new BlockingCollection\u0026lt;int\u0026gt;(new ConcurrentQueue\u0026lt;int\u0026gt;(), 10); // æœ€å¤§å®¹é‡10 // ç”Ÿäº§è€… Task.Run(() =\u0026gt; { for (int i = 1; i \u0026lt;= 20; i++) { blockingCollection.Add(i); // å¦‚æœæ»¡äº†ï¼Œä¼šé˜»å¡ Console.WriteLine($\u0026#34;ç”Ÿäº§: {i}\u0026#34;); Thread.Sleep(100); } blockingCollection.CompleteAdding(); // æ ‡è®°å®Œæˆ }); // æ¶ˆè´¹è€… Task.Run(() =\u0026gt; { foreach (var item in blockingCollection.GetConsumingEnumerable()) { Console.WriteLine($\u0026#34;æ¶ˆè´¹: {item}\u0026#34;); Thread.Sleep(200); // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´ } }); Thread.Sleep(5000); âœ… é€‚ç”¨åœºæ™¯ï¼šä»»åŠ¡è°ƒåº¦ã€æ•°æ®æµæ°´çº¿ã€é™æµç¼“å†²åŒº\nğŸ’¡ BlockingCollection\u0026lt;T\u0026gt; é»˜è®¤æœ‰åºï¼ˆFIFOï¼‰ï¼Œå› ä¸ºé»˜è®¤åŒ…è£… ConcurrentQueue\u0026lt;T\u0026gt;\nğŸš§ ä¸‰ã€SemaphoreSlim â€”â€” æ§åˆ¶å¹¶å‘è®¿é—®æ•°é‡ â–¶ å®ƒæ˜¯ä»€ä¹ˆï¼Ÿ SemaphoreSlim æ˜¯ä¸€ä¸ªè½»é‡çº§ä¿¡å·é‡ï¼Œç”¨äºé™åˆ¶åŒæ—¶è®¿é—®æŸèµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚\nä¸æ˜¯é›†åˆï¼Œè€Œæ˜¯å¹¶å‘æ§åˆ¶åŸè¯­ã€‚\nâ–¶ å¸¸ç”¨æ–¹æ³•ï¼š Wait() / WaitAsync() â€” è·å–è®¸å¯è¯ Release() â€” é‡Šæ”¾è®¸å¯è¯ CurrentCount â€” å‰©ä½™è®¸å¯è¯æ•° â–¶ ç¤ºä¾‹ï¼šé™åˆ¶æœ€å¤š3ä¸ªå¹¶å‘ä¸‹è½½ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 var semaphore = new SemaphoreSlim(3, 3); // æœ€å¤š3ä¸ªå¹¶å‘ var tasks = Enumerable.Range(1, 10).Select(async i =\u0026gt; { await semaphore.WaitAsync(); try { Console.WriteLine($\u0026#34;å¼€å§‹ä¸‹è½½æ–‡ä»¶ {i}ï¼Œå½“å‰å¹¶å‘: {3 - semaphore.CurrentCount}\u0026#34;); await Task.Delay(1000); // æ¨¡æ‹Ÿä¸‹è½½ Console.WriteLine($\u0026#34;å®Œæˆä¸‹è½½æ–‡ä»¶ {i}\u0026#34;); } finally { semaphore.Release(); } }); await Task.WhenAll(tasks); âœ… é€‚ç”¨åœºæ™¯ï¼šé™æµã€æ•°æ®åº“è¿æ¥æ± ã€APIè°ƒç”¨é™é¢‘ã€èµ„æºæ± \nâš™ï¸ å››ã€volatile ä¸ Interlocked â€”â€” å¹¶å‘ç¼–ç¨‹çš„åŸºçŸ³ 1. volatile å…³é”®å­— ç”¨äºä¿®é¥°å­—æ®µï¼Œç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯¹è¯¥å­—æ®µçš„è¯»å†™ä¸è¢«ç¼–è¯‘å™¨/CPUé‡æ’åºæˆ–ç¼“å­˜ã€‚\né€‚ç”¨åœºæ™¯ï¼šæ ‡å¿—ä½ã€çŠ¶æ€å˜é‡ã€å¼•ç”¨æ›¿æ¢\nç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public class Worker { private volatile bool _shouldStop = false; public void DoWork() { while (!_shouldStop) { // å·¥ä½œé€»è¾‘ } } public void RequestStop() { _shouldStop = true; // å…¶ä»–çº¿ç¨‹èƒ½ç«‹å³çœ‹åˆ° } } âš ï¸ volatile ä¸èƒ½æ›¿ä»£é”ï¼å®ƒåªä¿è¯å¯è§æ€§å’Œç¦æ­¢é‡æ’åºï¼Œä¸ä¿è¯åŸå­æ€§ã€‚\n2. Interlocked ç±» æä¾›åŸå­æ“ä½œï¼Œå¦‚è‡ªå¢ã€è‡ªå‡ã€äº¤æ¢ã€æ¯”è¾ƒäº¤æ¢ï¼ˆCASï¼‰\nå¸¸ç”¨æ–¹æ³•ï¼š\nInterlocked.Increment(ref variable) Interlocked.Exchange(ref location, value) â€” åŸå­æ›¿æ¢ Interlocked.CompareExchange(ref location, newValue, comparand) â€” CAS ç¤ºä¾‹ 1ï¼šçº¿ç¨‹å®‰å…¨è®¡æ•°å™¨\n1 2 3 4 5 6 7 8 private long _counter = 0; Parallel.For(0, 10000, _ =\u0026gt; { Interlocked.Increment(ref _counter); }); Console.WriteLine(_counter); // 10000 ç¤ºä¾‹ 2ï¼šåŸå­æ›¿æ¢ï¼ˆç”¨äºåŠ¨æ€æ›¿æ¢ SemaphoreSlimï¼‰\n1 2 3 4 5 6 7 8 private volatile SemaphoreSlim _semaphore = new(4); public void SetMaxConcurrency(int newMax) { var newSemaphore = new SemaphoreSlim(newMax); var old = Interlocked.Exchange(ref _semaphore, newSemaphore); old?.Dispose(); } âœ… é€‚ç”¨åœºæ™¯ï¼šè®¡æ•°å™¨ã€çŠ¶æ€æœºã€æ— é”æ•°æ®ç»“æ„ã€åŠ¨æ€èµ„æºæ›¿æ¢\nğŸ”„ äº”ã€å®ƒä»¬ä¹‹é—´çš„å…³ç³»å›¾è°± 1 2 3 4 5 6 7 8 graph TD A[ConcurrentQueue\u0026lt;T\u0026gt;] --\u0026gt;|åŒ…è£…| B(BlockingCollection\u0026lt;T\u0026gt;) C[ConcurrentStack\u0026lt;T\u0026gt;] --\u0026gt;|åŒ…è£…| B D[ConcurrentBag\u0026lt;T\u0026gt;] --\u0026gt;|åŒ…è£…| B E[SemaphoreSlim] --\u0026gt;|æ§åˆ¶| F[å¹¶å‘ä»»åŠ¡æ•°/èµ„æºè®¿é—®æ•°] G[volatile + Interlocked] --\u0026gt;|æ”¯æ’‘| H[æ— é”ç¼–ç¨‹ã€åŠ¨æ€æ›¿æ¢ã€çŠ¶æ€åŒæ­¥] B --\u0026gt;|å¸¸ä¸| E F --\u0026gt;|ä¾èµ–| G BlockingCollection\u0026lt;T\u0026gt; ä¾èµ–åº•å±‚å¹¶å‘é›†åˆ\nSemaphoreSlim å¸¸ç”¨äºæ§åˆ¶ BlockingCollection æ¶ˆè´¹è€…æˆ–ä»»åŠ¡å¹¶å‘æ•°\nvolatile + Interlocked æ˜¯å®ç°æ— é”æ›¿æ¢ã€çŠ¶æ€åŒæ­¥çš„åŸºç¡€\nğŸ¯ å…­ã€å®æˆ˜ï¼šæ„å»ºä¸€ä¸ªå¸¦å¹¶å‘é™åˆ¶çš„ä»»åŠ¡è°ƒåº¦å™¨ ç»“åˆä»¥ä¸Šæ‰€æœ‰çŸ¥è¯†ç‚¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 public class LimitedTaskScheduler\u0026lt;T\u0026gt; { private readonly BlockingCollection\u0026lt;Func\u0026lt;Task\u0026lt;T\u0026gt;\u0026gt;\u0026gt; _taskQueue; private readonly SemaphoreSlim _semaphore; private readonly ILogger _logger; public LimitedTaskScheduler(int maxConcurrency, ILogger logger) { _taskQueue = new BlockingCollection\u0026lt;Func\u0026lt;Task\u0026lt;T\u0026gt;\u0026gt;\u0026gt;(new ConcurrentQueue\u0026lt;Func\u0026lt;Task\u0026lt;T\u0026gt;\u0026gt;\u0026gt;()); _semaphore = new SemaphoreSlim(maxConcurrency, maxConcurrency); _logger = logger; } public void QueueTask(Func\u0026lt;Task\u0026lt;T\u0026gt;\u0026gt; task) { _taskQueue.Add(task); } public async Task StartAsync() { var tasks = new List\u0026lt;Task\u0026gt;(); foreach (var workItem in _taskQueue.GetConsumingEnumerable()) { tasks.Add(ExecuteWithLimit(workItem)); } await Task.WhenAll(tasks); } private async Task ExecuteWithLimit(Func\u0026lt;Task\u0026lt;T\u0026gt;\u0026gt; workItem) { await _semaphore.WaitAsync(); try { await workItem(); } finally { _semaphore.Release(); } } public void CompleteAdding() =\u0026gt; _taskQueue.CompleteAdding(); } ä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 var scheduler = new LimitedTaskScheduler\u0026lt;string\u0026gt;(3, logger); scheduler.QueueTask(() =\u0026gt; Task.Run(async () =\u0026gt; { await Task.Delay(1000); return \u0026#34;Task1 Result\u0026#34;; })); scheduler.QueueTask(/* ... */); scheduler.CompleteAdding(); await scheduler.StartAsync(); ğŸ“ ä¸ƒã€æœ€ä½³å®è·µæ€»ç»“ ç»„ä»¶ ä½¿ç”¨å»ºè®® ConcurrentQueue é»˜è®¤é¦–é€‰ï¼ŒFIFOï¼Œé€‚åˆä»»åŠ¡é˜Ÿåˆ— ConcurrentStack é€‚åˆæ’¤é”€æ ˆã€å¯¹è±¡æ±  ConcurrentDictionary ç¼“å­˜ã€è®¡æ•°å™¨é¦–é€‰ï¼Œç”¨ GetOrAdd / AddOrUpdate é¿å…ç«æ€ BlockingCollection éœ€è¦é˜»å¡/é™ç•Œ/å®Œæˆé€šçŸ¥æ—¶ä½¿ç”¨ï¼ŒåŒ…è£… ConcurrentQueue æœ€å¸¸ç”¨ SemaphoreSlim æ§åˆ¶å¹¶å‘æ•°ï¼Œé…åˆ using æˆ– try/finally ç¡®ä¿ Release volatile ç”¨äºå¸ƒå°”æ ‡å¿—ã€å¼•ç”¨æ›¿æ¢ï¼Œç¡®ä¿å¯è§æ€§ Interlocked è®¡æ•°å™¨ã€æ— é”çŠ¶æ€åˆ‡æ¢ã€åŸå­æ›¿æ¢ï¼ˆå¦‚åŠ¨æ€è°ƒæ•´å¹¶å‘æ•°ï¼‰ ğŸ§­ å…«ã€å¸¸è§è¯¯åŒº âŒ â€œConcurrentBag æ˜¯æ— åºçš„ï¼Œæ€§èƒ½æœ€å¥½ï¼Œæ‰€ä»¥æˆ‘æ‰€æœ‰åœ°æ–¹éƒ½ç”¨å®ƒâ€\nâ†’ ä»…åœ¨é¡ºåºæ— å…³ã€é¢‘ç¹å¢åˆ æ—¶ä½¿ç”¨ï¼Œå¦åˆ™ç”¨ ConcurrentQueue\nâŒ â€œBlockingCollection.Take() æ˜¯éé˜»å¡çš„â€\nâ†’ é»˜è®¤æ˜¯é˜»å¡çš„ï¼é™¤éç”¨ TryTake\nâŒ â€œvolatile èƒ½ä¿è¯åŸå­æ€§â€\nâ†’ ä¸èƒ½ï¼i++ å³ä½¿æ˜¯ volatile ä¹Ÿä¸æ˜¯åŸå­çš„ï¼Œè¦ç”¨ Interlocked.Increment\nâŒ â€œSemaphoreSlim æ˜¯é›†åˆâ€\nâ†’ å®ƒæ˜¯åŒæ­¥åŸè¯­ï¼Œä¸æ˜¯æ•°æ®å®¹å™¨\nâœ… ç»“è¯­ .NET çš„å¹¶å‘é›†åˆä¸åŒæ­¥åŸè¯­æ„æˆäº†å¼ºå¤§è€Œæ˜“ç”¨çš„å¹¶å‘ç¼–ç¨‹åŸºç¡€è®¾æ–½ã€‚æŒæ¡ï¼š\nConcurrentQueue / ConcurrentStack / ConcurrentDictionary BlockingCollection\u0026lt;T\u0026gt; çš„é˜»å¡ä¸åŒ…è£…èƒ½åŠ› SemaphoreSlim çš„å¹¶å‘æ§åˆ¶ volatile ä¸ Interlocked çš„æ— é”æ”¯æ’‘ ä½ å°±èƒ½åœ¨å¤šçº¿ç¨‹ä¸–ç•Œä¸­æ¸¸åˆƒæœ‰ä½™ï¼Œå†™å‡ºé«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„å¹¶å‘ç¨‹åºã€‚\nğŸ“Œ æºç ç¤ºä¾‹å·²å…¨éƒ¨æµ‹è¯•é€šè¿‡ï¼Œå¯ç›´æ¥å¤åˆ¶åˆ°é¡¹ç›®ä¸­è¿è¡Œã€‚\nğŸ“Œ å»ºè®®æ”¶è— + å®è·µ + åˆ†äº«ç»™å›¢é˜Ÿï¼Œæå‡æ•´ä½“å¹¶å‘ç¼–ç¨‹èƒ½åŠ›ï¼\nğŸ”– é™„å½•ï¼šå‘½åç©ºé—´å¼•ç”¨ ç¡®ä¿é¡¹ç›®ä¸­å¼•ç”¨ï¼š\n1 2 3 4 5 using System; using System.Collections.Concurrent; using System.Threading; using System.Threading.Tasks; using System.Linq; ğŸ‰ æ„Ÿè°¢é˜…è¯»ï¼å¦‚æœä½ è§‰å¾—æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµã€æ”¶è—ã€è½¬å‘ï¼\nä¸‹æœŸé¢„å‘Šï¼šã€Šç”¨ Channel æ›¿ä»£ BlockingCollection â€”â€” .NET 6+ ç°ä»£å¹¶å‘æ•°æ®æµã€‹\n","date":"2025-09-11T21:08:09+08:00","image":"https://www.notion.so/images/page-cover/met_joseph_hidley_1870.jpg","permalink":"https://dumbnessrf.github.io/p/meet_parallel_programing/","title":"Meet Parallel Programing"},{"content":"ğŸ¯ SharpBoxesCore.Wpf.PropertyGrid ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€é«˜åº¦å¯æ‰©å±•çš„ WPF å±æ€§ç¼–è¾‘å™¨ï¼ˆPropertyGridï¼‰ï¼Œä¸“ä¸ºç°ä»£ MVVM åº”ç”¨è®¾è®¡ã€‚æ”¯æŒè‡ªåŠ¨ UI ç”Ÿæˆã€å±æ€§åˆ†ç»„ã€æè¿°æ˜¾ç¤ºã€èŒƒå›´éªŒè¯ã€æ»‘å—è°ƒèŠ‚ã€è‡ªå®šä¹‰æŒ‰é’®ã€å‘½ä»¤ç»‘å®šã€å¤åˆç±»å‹åµŒå¥—ã€é›†åˆç¼–è¾‘ã€åŠ¨æ€åˆ·æ–°ã€é˜²æŠ–ä¼˜åŒ–ç­‰é«˜çº§åŠŸèƒ½ï¼Œå¼€ç®±å³ç”¨ï¼Œé€‚ç”¨äºé…ç½®é¢æ¿ã€è°ƒè¯•å·¥å…·ã€è®¾è®¡å™¨ã€å‚æ•°è®¾ç½®ç­‰åœºæ™¯ã€‚\nâœ¨ æ ¸å¿ƒç‰¹æ€§ åŠŸèƒ½ è¯´æ˜ ğŸ”¹ è‡ªåŠ¨å±æ€§å‘ç° æ‰«æå¯¹è±¡çš„å…¬å…±å¯è¯»å†™å±æ€§ ğŸ”¹ å±æ€§åˆ†ç»„ï¼ˆCategoryï¼‰ æ”¯æŒ [Category(\u0026quot;åˆ†ç»„å\u0026quot;)] åˆ†ç±»æ˜¾ç¤º ğŸ”¹ å±æ€§æ’åº æ”¯æŒ [PropertyOrder(1)] è‡ªå®šä¹‰æ’åº ğŸ”¹ æè¿°æ˜¾ç¤º é¼ æ ‡æ‚¬åœæˆ–èšç„¦æ—¶æ˜¾ç¤º [Description] å†…å®¹ ğŸ”¹ æ˜¾ç¤ºåç§° æ”¯æŒ [DisplayName(\u0026quot;åˆ«å\u0026quot;)] è‡ªå®šä¹‰åç§° ğŸ”¹ æšä¸¾æ”¯æŒ æ˜¾ç¤º [Description] æ–‡æœ¬ï¼Œæ”¯æŒå¯ç©ºæšä¸¾ ğŸ”¹ æ•°å€¼èŒƒå›´éªŒè¯ æ”¯æŒ [Range(0, 100)] è¾“å…¥é™åˆ¶ ğŸ”¹ æ»‘å—è°ƒèŠ‚ é…åˆ [ShowSlider] æ˜¾ç¤º Slider æ§ä»¶ ğŸ”¹ è‡ªå®šä¹‰æŒ‰é’® æ”¯æŒ [AddButton] æ·»åŠ æ“ä½œæŒ‰é’® ğŸ”¹ å‘½ä»¤ç»‘å®š æŒ‰é’®å¯ç»‘å®š ICommandï¼Œæ”¯æŒå‚æ•°ä¼ é€’ ğŸ”¹ é™çº§æœºåˆ¶ å‘½ä»¤ä¸å­˜åœ¨æ—¶ fallback åˆ° ButtonClicked äº‹ä»¶ ğŸ”¹ æŠ˜å é¢æ¿ æ¯ä¸ª Category æ”¯æŒ Expander æŠ˜å /å±•å¼€ ğŸ”¹ äº‹ä»¶å›è°ƒ æ”¯æŒ ButtonClicked å’Œ PropertyValueChanged äº‹ä»¶ ğŸ”¹ é”™è¯¯æç¤º è¾¹æ¡†å˜çº¢ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œä¸æ›´æ–°æ•°æ®æº ğŸ”¹ æ–‡ä»¶/æ–‡ä»¶å¤¹é€‰æ‹© æ”¯æŒ [SelectFilePath] / [SelectFolder] å¯¹è¯æ¡† ğŸ”¹ ä¸‹æ‹‰æ¡†ç¼–è¾‘ æ”¯æŒ [EnumerableProperty] ç»‘å®šæ•°æ®æº ğŸ”¹ å¤åˆç±»å‹åµŒå¥— æ”¯æŒç±»å±æ€§å±•å¼€ä¸ºå­å±æ€§é¢æ¿ ğŸ”¹ é›†åˆç¼–è¾‘ æ”¯æŒ List\u0026lt;T\u0026gt; / Dictionary\u0026lt;K,V\u0026gt; å¼¹çª—ç¼–è¾‘ ğŸ”¹ åŠ¨æ€åˆ·æ–° æ•°æ®æºå˜åŒ–è‡ªåŠ¨æ›´æ–° UI ğŸ”¹ ç±»å‹å®‰å…¨ ç¼–è¾‘æ—¶ä¿ç•™åŸå§‹ç±»å‹ï¼Œæ”¯æŒè‡ªåŠ¨è§£æ ğŸ”¹ é˜²æŠ–æœºåˆ¶ é«˜é¢‘æ›´æ–°æ—¶è‡ªåŠ¨åˆå¹¶åˆ·æ–°ï¼Œæå‡æ€§èƒ½ ğŸ”¹ é«˜åº¦è‡ªé€‚åº” æ”¯æŒæ»šåŠ¨æ¡ï¼Œå†…å®¹å±•å¼€è‡ªåŠ¨æ‹‰ä¼¸ ğŸ”¹ æœç´¢å±æ€§å­—æ®µ æ”¯æŒæœç´¢æŒ‡å®šåç§°å±æ€§ç¼–è¾‘ ğŸ”¹ ä¸€é”®å±•å¼€ã€æŠ˜å  æ”¯æŒä¸€é”®å±•å¼€ã€æŠ˜å æ‰€æœ‰å±æ€§ ğŸš€ å¿«é€Ÿå¼€å§‹ 1. å®‰è£…å¼•ç”¨ .NET CLI 1 dotnet add package SharpBoxesCore.Wpf --version 1.1.2 PackageReference 1 \u0026lt;PackageReference Include=\u0026#34;SharpBoxesCore.Wpf\u0026#34; Version=\u0026#34;1.1.2\u0026#34; /\u0026gt; CPM Directory.Packages.props\n1 \u0026lt;PackageVersion Include=\u0026#34;SharpBoxesCore.Wpf\u0026#34; Version=\u0026#34;1.1.2\u0026#34; /\u0026gt; Project file\n1 \u0026lt;PackageReference Include=\u0026#34;SharpBoxesCore.Wpf\u0026#34; /\u0026gt; 2. åœ¨ XAML ä¸­ä½¿ç”¨ 1 2 3 4 5 6 7 \u0026lt;Window x:Class=\u0026#34;YourApp.MainWindow\u0026#34; xmlns:local=\u0026#34;clr-namespace:SharpBoxesCore.Wpf.PropertyGrid\u0026#34; ...\u0026gt; \u0026lt;Grid\u0026gt; \u0026lt;local:PropertyGrid x:Name=\u0026#34;propertyGrid\u0026#34; Padding=\u0026#34;10\u0026#34; /\u0026gt; \u0026lt;/Grid\u0026gt; \u0026lt;/Window\u0026gt; 3. ç»‘å®šæ•°æ®å¯¹è±¡ 1 2 3 4 5 6 7 8 9 10 11 12 public partial class MainWindow : Window { public MainWindow() { InitializeComponent(); propertyGrid.SelectedObject = new SampleObject(); // è®¢é˜…äº‹ä»¶ propertyGrid.ButtonClicked += OnButtonClicked; propertyGrid.PropertyValueChanged += OnPropertyValueChanged; } } ğŸ“¦ ç¤ºä¾‹ï¼šå®Œæ•´æ•°æ®æ¨¡å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 public class SampleObject : INotifyPropertyChanged { [Category(\u0026#34;åŸºæœ¬ä¿¡æ¯\u0026#34;)] [DisplayName(\u0026#34;å§“å\u0026#34;)] [Description(\u0026#34;ç”¨æˆ·çš„å…¨å\u0026#34;)] [EnumerableProperty(\u0026#34;AvaliableNames\u0026#34;, true)] public string Name { get; set; } = \u0026#34;å¼ ä¸‰\u0026#34;; [Category(\u0026#34;æ•°å€¼è®¾ç½®\u0026#34;)] [DisplayName(\u0026#34;éŸ³é‡\u0026#34;)] [Description(\u0026#34;è°ƒèŠ‚éŸ³é‡å¤§å°\u0026#34;)] [Range(0, 100)] [ShowSlider(10, true)] public int Volume { get; set; } = 75; [Category(\u0026#34;é«˜çº§\u0026#34;)] [DisplayName(\u0026#34;æ•°æ®æ¨¡å¼\u0026#34;)] public DataMode Mode { get; set; } = DataMode.Development; [Category(\u0026#34;æ–‡ä»¶\u0026#34;)] [DisplayName(\u0026#34;é…ç½®æ–‡ä»¶\u0026#34;)] [SelectFilePath(Title = \u0026#34;é€‰æ‹©é…ç½®æ–‡ä»¶\u0026#34;, Filter = \u0026#34;JSON Files|*.json\u0026#34;)] public string ConfigFile { get; set; } = \u0026#34;\u0026#34;; [Category(\u0026#34;è·¯å¾„\u0026#34;)] [DisplayName(\u0026#34;å·¥ä½œç›®å½•\u0026#34;)] [SelectFolder(Title = \u0026#34;é€‰æ‹©å·¥ä½œç›®å½•\u0026#34;)] public string WorkDir { get; set; } = \u0026#34;\u0026#34;; [Category(\u0026#34;é›†åˆ\u0026#34;)] public List\u0026lt;string\u0026gt; Hobbies { get; set; } = new() { \u0026#34;é˜…è¯»\u0026#34;, \u0026#34;éŸ³ä¹\u0026#34; }; [Category(\u0026#34;å­—å…¸\u0026#34;)] public Dictionary\u0026lt;string, int\u0026gt; Scores { get; set; } = new() { [\u0026#34;æ•°å­¦\u0026#34;] = 90, [\u0026#34;è‹±è¯­\u0026#34;] = 85 }; [Category(\u0026#34;åµŒå¥—å¯¹è±¡\u0026#34;)] public Address HomeAddress { get; set; } = new(); [Category(\u0026#34;æ“ä½œ\u0026#34;)] [AddButton(\u0026#34;ResetCommand\u0026#34;, \u0026#34;é‡ç½®\u0026#34;)] [AddButton(\u0026#34;LogCommand\u0026#34;, \u0026#34;è®°å½•å½“å‰å€¼\u0026#34;)] public int RetryCount { get; set; } = 3; // å‘½ä»¤å®šä¹‰ public ICommand ResetCommand =\u0026gt; new RelayCommand\u0026lt;string\u0026gt;(_ =\u0026gt; RetryCount = 0); public ICommand LogCommand =\u0026gt; new RelayCommand\u0026lt;string\u0026gt;(action =\u0026gt; Debug.WriteLine($\u0026#34;æ—¥å¿—: {action}, Count={RetryCount}\u0026#34;)); // ä¸‹æ‹‰æ•°æ®æº public ObservableCollection\u0026lt;string\u0026gt; AvaliableNames { get; } = new() { \u0026#34;Alice\u0026#34;, \u0026#34;Bob\u0026#34;, \u0026#34;Charlie\u0026#34; }; public event PropertyChangedEventHandler PropertyChanged; protected virtual void OnPropertyChanged([CallerMemberName] string propertyName = null) =\u0026gt; PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName)); } ğŸ¨ UI æ•ˆæœé¢„è§ˆ åˆ†ç»„æŠ˜å /å±•å¼€ æ»‘å—ä¸æ–‡æœ¬æ¡†è”åŠ¨ æŒ‰é’®è‡ªåŠ¨å¸ƒå±€ é”™è¯¯è¾“å…¥çº¢è‰²æç¤º æè¿°ä¿¡æ¯å®æ—¶æ˜¾ç¤º å¤åˆå¯¹è±¡åµŒå¥—å±•å¼€ é›†åˆç‚¹å‡»â€œç¼–è¾‘\u0026hellip;â€å¼¹çª— æ»šåŠ¨æ¡æ”¯æŒé•¿å†…å®¹ ğŸ”§ é«˜çº§åŠŸèƒ½è¯¦è§£ 1. æšä¸¾æ˜¾ç¤º [Description] 1 2 3 4 5 6 7 8 public enum DataMode { [Description(\u0026#34;å¼€å‘æ¨¡å¼\u0026#34;)] Development, [Description(\u0026#34;ç”Ÿäº§æ¨¡å¼\u0026#34;)] Production } âœ… æ˜¾ç¤ºä¸ºâ€œå¼€å‘æ¨¡å¼â€è€Œé Development\n2. æ»‘å—è°ƒèŠ‚ [ShowSlider] 1 2 3 [Range(0, 100)] [ShowSlider(5, true)] public int Brightness { get; set; } âœ… è‡ªåŠ¨ç”Ÿæˆ Slider + TextBox è”åŠ¨æ§ä»¶\n3. è‡ªå®šä¹‰æŒ‰é’®ä¸å‘½ä»¤ç»‘å®š 1 2 3 [AddButton(\u0026#34;SaveCommand\u0026#34;, \u0026#34;ä¿å­˜\u0026#34;, \u0026#34;å¦å­˜ä¸º\u0026#34;)] [AddButton(\u0026#34;DeleteCommand\u0026#34;, \u0026#34;åˆ é™¤\u0026#34;)] public string FileName { get; set; } âœ… å­˜åœ¨å‘½ä»¤ â†’ ç»‘å®šæ‰§è¡Œ âŒ ä¸å­˜åœ¨ â†’ è§¦å‘ ButtonClicked äº‹ä»¶ 1 2 3 4 propertyGrid.ButtonClicked += (s, e) =\u0026gt; { MessageBox.Show($\u0026#34;æŒ‰é’®ç‚¹å‡»: {e.PropertyName} - {e.ButtonText}\u0026#34;); }; 4. æ•°å€¼èŒƒå›´éªŒè¯ 1 2 [Range(1, 1000)] public int Count { get; set; } âœ… è¾“å…¥éæ³•æ—¶ï¼š\nè¾¹æ¡†å˜çº¢ æ˜¾ç¤ºé”™è¯¯æç¤º ä¸æ›´æ–°æ•°æ®æº 5. ä¸‹æ‹‰æ¡† [EnumerableProperty] 1 2 [EnumerableProperty(\u0026#34;AvaliableNames\u0026#34;, true)] public string Theme { get; set; } âœ… æ˜¾ç¤ºä¸‹æ‹‰æ¡†ï¼Œæ”¯æŒè‡ªå®šä¹‰è¾“å…¥ï¼Œæ•°æ®æºåŠ¨æ€åˆ·æ–°\n6. æ–‡ä»¶/æ–‡ä»¶å¤¹é€‰æ‹© 1 2 3 4 5 [SelectFilePath(Title = \u0026#34;é€‰æ‹©æ—¥å¿—\u0026#34;)] public string LogFile { get; set; } [SelectFolder] public string BackupDir { get; set; } âœ… ä½¿ç”¨ Ookii.Dialogs.Wpf æä¾›ä¸“ä¸šå¯¹è¯æ¡†\n7. å¤åˆç±»å‹ï¼ˆåµŒå¥—å¯¹è±¡ï¼‰ 1 2 3 4 5 6 7 8 public class Address { public string Street { get; set; } public string City { get; set; } } [DisplayName(\u0026#34;å®¶åº­åœ°å€\u0026#34;)] public Address HomeAddress { get; set; } âœ… è‡ªåŠ¨å±•å¼€ä¸ºå­å±æ€§é¢æ¿ï¼Œæ”¯æŒ INotifyPropertyChanged åŠ¨æ€åˆ·æ–°\n8. é›†åˆç¼–è¾‘ï¼ˆList / Dictionaryï¼‰ 1 2 public List\u0026lt;string\u0026gt; Hobbies { get; set; } public Dictionary\u0026lt;string, int\u0026gt; Scores { get; set; } âœ… ç‚¹å‡»â€œç¼–è¾‘\u0026hellip;â€å¼¹å‡º ListEditor / DictEditorï¼Œæ”¯æŒç±»å‹ä¿ç•™ç¼–è¾‘\nğŸ§© äº‹ä»¶ç³»ç»Ÿ PropertyValueChanged â€” å±æ€§æ›´æ”¹äº‹ä»¶ 1 2 3 4 5 6 7 propertyGrid.PropertyValueChanged += (s, e) =\u0026gt; { Console.WriteLine($\u0026#34;å±æ€§æ›´æ”¹: {e.PropertyName}\u0026#34;); Console.WriteLine($\u0026#34; ç±»å‹: {e.PropertyType.Name}\u0026#34;); Console.WriteLine($\u0026#34; æ—§å€¼: {e.OldValue}\u0026#34;); Console.WriteLine($\u0026#34; æ–°å€¼: {e.NewValue}\u0026#34;); }; âœ… æ‰€æœ‰ç¼–è¾‘æ“ä½œï¼ˆåŒ…æ‹¬é›†åˆã€æ–‡ä»¶é€‰æ‹©ï¼‰å‡è§¦å‘æ­¤äº‹ä»¶\nButtonClicked â€” æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆfallbackï¼‰ 1 2 3 4 propertyGrid.ButtonClicked += (s, e) =\u0026gt; { if (e.ButtonText == \u0026#34;é‡ç½®\u0026#34;) ResetLogic(); }; âœ… ç”¨äºæœªç»‘å®š ICommand çš„æŒ‰é’®\nğŸ› ï¸ è‡ªå®šä¹‰ Attribute è¯´æ˜ Attribute ç”¨é€” ç¤ºä¾‹ [Category(\u0026quot;åˆ†ç»„\u0026quot;)] å±æ€§åˆ†ç»„ Category(\u0026quot;ç½‘ç»œ\u0026quot;) [DisplayName(\u0026quot;åˆ«å\u0026quot;)] è‡ªå®šä¹‰æ˜¾ç¤ºå DisplayName(\u0026quot;IPåœ°å€\u0026quot;) [Description(\u0026quot;è¯´æ˜\u0026quot;)] æè¿°ä¿¡æ¯ Description(\u0026quot;æœåŠ¡å™¨IP\u0026quot;) [PropertyOrder(1)] æ’åºä¼˜å…ˆçº§ æ•°å­—è¶Šå°è¶Šé å‰ [Range(0,100)] æ•°å€¼èŒƒå›´ æ”¯æŒ int/double/float [ShowSlider(10)] æ˜¾ç¤ºæ»‘å— TickFrequency=10 [AddButton(\u0026quot;Cmd\u0026quot;, \u0026quot;æŒ‰é’®\u0026quot;)] æ·»åŠ æ“ä½œæŒ‰é’® æ”¯æŒå¤šæ ‡ç­¾ [EnumerableProperty(\u0026quot;Source\u0026quot;, true)] ä¸‹æ‹‰æ¡† ç»‘å®šæ•°æ®æº [SelectFilePath] æ–‡ä»¶é€‰æ‹© æ‰“å¼€ OpenFileDialog [SelectFolder] æ–‡ä»¶å¤¹é€‰æ‹© æ‰“å¼€ FolderBrowserDialog âš™ï¸ é«˜çº§é…ç½® é˜²æŠ–æœºåˆ¶ï¼ˆDebounceï¼‰ é»˜è®¤å¯ç”¨ï¼Œé˜²æ­¢é«˜é¢‘åˆ·æ–°ï¼š\n1 propertyGrid.DebounceEnabled = true; // é»˜è®¤ true å¯è°ƒæ•´å»¶è¿Ÿæ—¶é—´ï¼ˆå†…éƒ¨ä½¿ç”¨ DispatcherTimerï¼‰\næ‰‹åŠ¨è§¦å‘å±æ€§æ›´æ”¹ 1 propertyGrid.RaisePropertyValueChanged(\u0026#34;Name\u0026#34;, \u0026#34;æ—§å€¼\u0026#34;, \u0026#34;æ–°å€¼\u0026#34;); ç”¨äºä»£ç ä¿®æ”¹å±æ€§åé€šçŸ¥å¤–éƒ¨ç³»ç»Ÿ\nğŸ“š å·²çŸ¥é™åˆ¶ é™åˆ¶ è¯´æ˜ âŒ ä¸æ”¯æŒé›†åˆå¢åˆ é¡¹ ListEditor ä»…æ”¯æŒä¿®æ”¹å€¼ âŒ ä¸æ”¯æŒå¤æ‚å¯¹è±¡åˆ—è¡¨ç¼–è¾‘ ä»…æ”¯æŒç®€å•ç±»å‹åˆ—è¡¨ âŒ ä¸æ”¯æŒ DateTime ä¸“ç”¨æ§ä»¶ å¯ç”¨ TextBox è¾“å…¥ âœ… åç»­è®¡åˆ’æ”¯æŒï¼šDatePickerã€ColorPickerã€IEditableObject æ’¤é”€\nå¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œæ¬¢è¿ç‚¹èµã€æ”¶è—ã€åˆ†äº«ï¼\nä¹Ÿå¯ä»¥å…³æ³¨æˆ‘çš„åšå®¢ï¼Œè·å–æ›´å¤š WPF / .NET æŠ€æœ¯å¹²è´§ ğŸ˜Š\n","date":"2025-09-02T23:01:03+08:00","image":"https://www.notion.so/images/page-cover/met_winslow_homer_maine_coast.jpg","permalink":"https://dumbnessrf.github.io/p/propertygrid/","title":"PropertyGrid"},{"content":"ğŸš€ åœ¨ WPF ä¸­ä½¿ç”¨ Microsoft.Xaml.Behaviorsï¼šè¡Œä¸ºï¼ˆBehaviorsï¼‰çš„ä¼˜é›…è§£å†³æ–¹æ¡ˆ âœ… ä»€ä¹ˆæ˜¯ Microsoft.Xaml.Behaviorsï¼Ÿ Microsoft.Xaml.Behaviors æ˜¯ä¸€ä¸ªå¼€æºåº“ï¼Œæœ€åˆç”± Expression Blend å›¢é˜Ÿå¼€å‘ï¼Œåæ¥è¢«å¾®è½¯å®˜æ–¹ç»´æŠ¤å¹¶æ‰˜ç®¡åœ¨ GitHub ä¸Šã€‚è¿™ä¸ªåº“å…è®¸å¼€å‘è€…é€šè¿‡ XAML è¡Œä¸ºï¼ˆBehaviorsï¼‰ å’Œ è§¦å‘å™¨ï¼ˆTriggersï¼‰ æ¥æ‰©å±• UI æ§ä»¶çš„åŠŸèƒ½ï¼Œè€Œæ— éœ€ç¼–å†™å¤æ‚çš„ä»£ç æˆ–ä¿®æ”¹æ§ä»¶æœ¬èº«ã€‚\nğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ Behaviorï¼ˆè¡Œä¸ºï¼‰ï¼šä¸€ç§å¯é‡ç”¨çš„ç»„ä»¶ï¼Œé™„åŠ åˆ°æŸä¸ª UI å…ƒç´ ä¸Šï¼Œå¹¶ä¸ºå…¶æ·»åŠ é¢å¤–çš„è¡Œä¸ºã€‚ Triggerï¼ˆè§¦å‘å™¨ï¼‰ï¼šæ ¹æ®æŸäº›æ¡ä»¶æˆ–äº‹ä»¶æ‰§è¡Œç‰¹å®šçš„æ“ä½œã€‚ Actionï¼ˆåŠ¨ä½œï¼‰ï¼šè§¦å‘å™¨æ‰§è¡Œçš„å…·ä½“æ“ä½œï¼Œå¦‚è°ƒç”¨æ–¹æ³•ã€æ”¹å˜å±æ€§ç­‰ã€‚ GitHub åœ°å€ï¼šhttps://github.com/microsoft/XamlBehaviors\nğŸ“¦ å®‰è£… Microsoft.Xaml.Behaviors ä½ å¯ä»¥é€šè¿‡ NuGet åŒ…ç®¡ç†å™¨è½»æ¾åœ°å°† Microsoft.Xaml.Behaviors.Wpf æ·»åŠ åˆ°ä½ çš„ WPF é¡¹ç›®ä¸­ã€‚\nä½¿ç”¨ NuGet å®‰è£…å‘½ä»¤ï¼š 1 Install-Package Microsoft.Xaml.Behaviors.Wpf æˆ–è€…é€šè¿‡ Visual Studio çš„ NuGet åŒ…ç®¡ç†å™¨æœç´¢å¹¶å®‰è£…ï¼š\næ‰“å¼€èœå•ï¼šå·¥å…· \u0026gt; NuGet åŒ…ç®¡ç†å™¨ \u0026gt; ç®¡ç†è§£å†³æ–¹æ¡ˆçš„ NuGet åŒ… æœç´¢å…³é”®è¯ï¼šMicrosoft.Xaml.Behaviors.Wpf å®‰è£…æœ€æ–°ç‰ˆæœ¬ ğŸ› ï¸ XAML å‘½åç©ºé—´å¼•ç”¨ åœ¨ XAML æ–‡ä»¶é¡¶éƒ¨æ·»åŠ ä»¥ä¸‹å‘½åç©ºé—´å¼•ç”¨ï¼Œä»¥ä¾¿ä½¿ç”¨ Behaviorsï¼š\n1 xmlns:i=\u0026#34;http://schemas.microsoft.com/expression/2010/interactivity\u0026#34; ğŸ¯ ä½¿ç”¨ç¤ºä¾‹ä¸åº”ç”¨åœºæ™¯ ä¸‹é¢æˆ‘ä»¬å°†é€šè¿‡å‡ ä¸ªå…¸å‹çš„ä½¿ç”¨åœºæ™¯æ¥å±•ç¤º Microsoft.Xaml.Behaviors çš„å¼ºå¤§ä¹‹å¤„ã€‚\nç¤ºä¾‹ 1ï¼šç‚¹å‡»æŒ‰é’®æ—¶å¼¹å‡ºæ¶ˆæ¯æ¡†ï¼ˆä¸ä½¿ç”¨ä»£ç ï¼‰ åœºæ™¯è¯´æ˜ï¼š ä½ å¸Œæœ›ç‚¹å‡»æŒ‰é’®æ—¶æ˜¾ç¤ºä¸€ä¸ªç®€å•çš„æ¶ˆæ¯æ¡†ï¼Œä½†ä¸æƒ³åœ¨ä»£ç åå°å†™ä»»ä½•é€»è¾‘ã€‚\nå®ç°æ–¹å¼ï¼š 1 2 3 4 5 6 7 \u0026lt;Button Content=\u0026#34;ç‚¹å‡»æˆ‘\u0026#34;\u0026gt; \u0026lt;i:Interaction.Triggers\u0026gt; \u0026lt;i:EventTrigger EventName=\u0026#34;Click\u0026#34;\u0026gt; \u0026lt;i:InvokeCommandAction Command=\u0026#34;{Binding ShowMessageCommand}\u0026#34; /\u0026gt; \u0026lt;/i:EventTrigger\u0026gt; \u0026lt;/i:Interaction.Triggers\u0026gt; \u0026lt;/Button\u0026gt; ViewModel ä¸­å®šä¹‰å‘½ä»¤ï¼š 1 2 3 4 5 6 7 public ICommand ShowMessageCommand { get; } public MyViewModel() { ShowMessageCommand = new RelayCommand(() =\u0026gt; MessageBox.Show(\u0026#34;ä½ å¥½ï¼Œä¸–ç•Œï¼\u0026#34;)); } ç¤ºä¾‹ 2ï¼šæ–‡æœ¬æ¡†å†…å®¹å˜åŒ–æ—¶æ›´æ–°ç»‘å®šå€¼ï¼ˆå®æ—¶éªŒè¯ï¼‰ åœºæ™¯è¯´æ˜ï¼š ç”¨æˆ·åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥å†…å®¹æ—¶ï¼Œè‡ªåŠ¨è§¦å‘éªŒè¯é€»è¾‘ã€‚\nå®ç°æ–¹å¼ï¼š 1 2 3 4 5 6 7 \u0026lt;TextBox Text=\u0026#34;{Binding Name}\u0026#34;\u0026gt; \u0026lt;i:Interaction.Triggers\u0026gt; \u0026lt;i:EventTrigger EventName=\u0026#34;TextChanged\u0026#34;\u0026gt; \u0026lt;i:InvokeCommandAction Command=\u0026#34;{Binding ValidateNameCommand}\u0026#34; /\u0026gt; \u0026lt;/i:EventTrigger\u0026gt; \u0026lt;/i:Interaction.Triggers\u0026gt; \u0026lt;/TextBox\u0026gt; ç¤ºä¾‹ 3ï¼šé¼ æ ‡æ‚¬åœæ—¶é«˜äº®å…ƒç´  åœºæ™¯è¯´æ˜ï¼š å½“é¼ æ ‡æ‚¬åœåœ¨ä¸€ä¸ªæŒ‰é’®ä¸Šæ—¶ï¼Œæ”¹å˜å…¶èƒŒæ™¯é¢œè‰²ã€‚\nå®ç°æ–¹å¼ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;Button Content=\u0026#34;æ‚¬åœè¯•è¯•çœ‹\u0026#34;\u0026gt; \u0026lt;i:Interaction.Triggers\u0026gt; \u0026lt;i:EventTrigger EventName=\u0026#34;MouseEnter\u0026#34;\u0026gt; \u0026lt;i:ChangePropertyAction TargetObject=\u0026#34;{Binding ElementName=MyButton}\u0026#34; PropertyName=\u0026#34;Background\u0026#34; Value=\u0026#34;LightBlue\u0026#34;/\u0026gt; \u0026lt;/i:EventTrigger\u0026gt; \u0026lt;i:EventTrigger EventName=\u0026#34;MouseLeave\u0026#34;\u0026gt; \u0026lt;i:ChangePropertyAction TargetObject=\u0026#34;{Binding ElementName=MyButton}\u0026#34; PropertyName=\u0026#34;Background\u0026#34; Value=\u0026#34;White\u0026#34;/\u0026gt; \u0026lt;/i:EventTrigger\u0026gt; \u0026lt;/i:Interaction.Triggers\u0026gt; \u0026lt;/Button\u0026gt; ç¤ºä¾‹ 4ï¼šè‡ªå®šä¹‰è¡Œä¸º â€”â€” å³é”®èœå• åœºæ™¯è¯´æ˜ï¼š ä¸ºä»»æ„æ§ä»¶æ·»åŠ å³é”®èœå•åŠŸèƒ½ã€‚\nè‡ªå®šä¹‰è¡Œä¸ºç±»ï¼ˆC#ï¼‰ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 public class RightClickMenuBehavior : Behavior\u0026lt;FrameworkElement\u0026gt; { public static readonly DependencyProperty ContextMenuProperty = DependencyProperty.Register(\u0026#34;ContextMenu\u0026#34;, typeof(ContextMenu), typeof(RightClickMenuBehavior)); public ContextMenu ContextMenu { get { return (ContextMenu)GetValue(ContextMenuProperty); } set { SetValue(ContextMenuProperty, value); } } protected override void OnAttached() { AssociatedObject.MouseRightButtonDown += OnMouseRightButtonDown; } protected override void OnDetaching() { AssociatedObject.MouseRightButtonDown -= OnMouseRightButtonDown; } private void OnMouseRightButtonDown(object sender, MouseButtonEventArgs e) { if (ContextMenu != null) { ContextMenu.PlacementTarget = AssociatedObject; ContextMenu.IsOpen = true; } } } XAML ä½¿ç”¨æ–¹å¼ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;Button Content=\u0026#34;å³é”®ç‚¹å‡»æˆ‘\u0026#34;\u0026gt; \u0026lt;i:Interaction.Behaviors\u0026gt; \u0026lt;local:RightClickMenuBehavior\u0026gt; \u0026lt;local:RightClickMenuBehavior.ContextMenu\u0026gt; \u0026lt;ContextMenu\u0026gt; \u0026lt;MenuItem Header=\u0026#34;å¤åˆ¶\u0026#34; /\u0026gt; \u0026lt;MenuItem Header=\u0026#34;ç²˜è´´\u0026#34; /\u0026gt; \u0026lt;/ContextMenu\u0026gt; \u0026lt;/local:RightClickMenuBehavior.ContextMenu\u0026gt; \u0026lt;/local:RightClickMenuBehavior\u0026gt; \u0026lt;/i:Interaction.Behaviors\u0026gt; \u0026lt;/Button\u0026gt; ğŸ§© åº”ç”¨åœºæ™¯æ€»ç»“ åœºæ™¯ æè¿° âš™ï¸ äº‹ä»¶ç»‘å®š å°† UI äº‹ä»¶ç»‘å®šåˆ° ViewModel ä¸­çš„å‘½ä»¤ï¼Œå®ç° MVVM è§£è€¦ ğŸ” è¾“å…¥éªŒè¯ å®æ—¶éªŒè¯ç”¨æˆ·è¾“å…¥å†…å®¹ï¼Œæå‡ç”¨æˆ·ä½“éªŒ ğŸ–±ï¸ é¼ æ ‡äº¤äº’ å¤„ç†é¼ æ ‡æ‚¬åœã€å•å‡»ã€æ‹–æ‹½ç­‰äº¤äº’é€»è¾‘ ğŸ”„ åŠ¨æ€æ ·å¼ æ ¹æ®çŠ¶æ€åŠ¨æ€æ›´æ”¹æ§ä»¶å¤–è§‚ ğŸ§ª å•å…ƒæµ‹è¯• å‡å°‘ä»£ç è€¦åˆï¼Œæé«˜å¯æµ‹è¯•æ€§ ğŸ§± è‡ªå®šä¹‰è¡Œä¸º å¿«é€Ÿæ„å»ºå¯å¤ç”¨çš„ UI è¡Œä¸ºæ¨¡å— ğŸ§  æ€»ç»“ Microsoft.Xaml.Behaviors æ˜¯ WPF å¼€å‘ä¸­éå¸¸å¼ºå¤§çš„è¾…åŠ©å·¥å…·ã€‚å®ƒä¸ä»…ç®€åŒ–äº† UI ä¸é€»è¾‘ä¹‹é—´çš„ç»‘å®šï¼Œè¿˜æå‡äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚é€šè¿‡ä½¿ç”¨è¡Œä¸ºå’Œè§¦å‘å™¨ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°æ›´åŠ çµæ´»ã€è§£è€¦çš„ UI è®¾è®¡ï¼Œç‰¹åˆ«é€‚åˆ MVVM æ¶æ„ä¸‹çš„å¼€å‘ã€‚\nå¦‚æœä½ æ­£åœ¨å¯»æ‰¾ä¸€ç§æ›´ä¼˜é›…çš„æ–¹å¼æ¥å¤„ç† UI äº¤äº’é€»è¾‘ï¼Œé‚£ä¹ˆ Microsoft.Xaml.Behaviors ç»å¯¹å€¼å¾—ä¸€è¯•ï¼\nğŸ“š å‚è€ƒèµ„æ–™ GitHub - Microsoft.Xaml.Behaviors NuGet - Microsoft.Xaml.Behaviors.Wpf MSDN - Interactivity Library å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œæ¬¢è¿ç‚¹èµã€æ”¶è—ã€åˆ†äº«ï¼\nä¹Ÿå¯ä»¥å…³æ³¨æˆ‘çš„åšå®¢ï¼Œè·å–æ›´å¤š WPF / .NET æŠ€æœ¯å¹²è´§ ğŸ˜Š\n","date":"2025-07-23T23:01:03+08:00","image":"https://www.notion.so/images/page-cover/met_horace_pippin.jpg","permalink":"https://dumbnessrf.github.io/p/xaml_behaviors/","title":"Xaml Behaviors"},{"content":"åœ¨ WPFã€Xamarin.Forms å’Œ .NET MAUI å¼€å‘ä¸­ï¼Œæ•°æ®ç»‘å®šï¼ˆData Bindingï¼‰ æ˜¯ MVVM æ¶æ„çš„æ ¸å¿ƒæœºåˆ¶ã€‚ä½†æœ‰æ—¶æˆ‘ä»¬å¸Œæœ›å¯¹ç»‘å®šçš„æ•°æ®è¿›è¡Œè½¬æ¢ã€æ ¼å¼åŒ–æˆ–é€»è¾‘å¤„ç†ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨ IValueConverter æ¥å£å®ç°å€¼è½¬æ¢å™¨ã€‚\nValueConverters.NET æ˜¯ä¸€ä¸ªç”± Thomas Galliker ç»´æŠ¤çš„å¼€æºé¡¹ç›®ï¼Œå®ƒæä¾›äº†ä¸€ç»„å¸¸ç”¨çš„ IValueConverter å®ç°ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿæ„å»ºå¼ºå¤§çš„æ•°æ®ç»‘å®šé€»è¾‘ã€‚\nğŸ“¦ å®‰è£…æ–¹æ³• ä½ å¯ä»¥é€šè¿‡ NuGet åŒ…å®‰è£…é€‚ç”¨äºä¸åŒå¹³å°çš„ç‰ˆæœ¬ï¼š\nå¹³å° å‘½ä»¤ WPF / WinForms / UWP / Avalonia ç­‰ Install-Package ValueConverters Xamarin.Forms Install-Package ValueConverters.Forms .NET MAUI Install-Package ValueConverters.MAUI âœ… å¦‚ä½•ä½¿ç”¨ ValueConverters.NETï¼Ÿ æ­¥éª¤ä¸€ï¼šåœ¨ XAML ä¸­å®šä¹‰èµ„æº 1 2 3 4 \u0026lt;Window.Resources\u0026gt; \u0026lt;converters:DateTimeConverter x:Key=\u0026#34;DateTimeConverter\u0026#34; Format=\u0026#34;d\u0026#34; MinValueString=\u0026#34;-\u0026#34;/\u0026gt; \u0026lt;converters:BooleanToVisibilityConverter x:Key=\u0026#34;BooleanToVisibilityConverter\u0026#34;/\u0026gt; \u0026lt;/Window.Resources\u0026gt; æ­¥éª¤äºŒï¼šåœ¨ç»‘å®šä¸­ä½¿ç”¨ Converter 1 2 \u0026lt;TextBlock Text=\u0026#34;{Binding BirthDate, Converter={StaticResource DateTimeConverter}}\u0026#34; /\u0026gt; \u0026lt;TextBox Visibility=\u0026#34;{Binding IsVisible, Converter={StaticResource BooleanToVisibilityConverter}}\u0026#34; /\u0026gt; ğŸ§© æ ¸å¿ƒ Converters åŠå…¶ç¤ºä¾‹ ä¸‹é¢ä»‹ç»å‡ ä¸ªæœ€å¸¸ç”¨ä¸”å®ç”¨çš„è½¬æ¢å™¨åŠå…¶åº”ç”¨åœºæ™¯ã€‚\n1. DateTimeConverterï¼šæ—¥æœŸæ ¼å¼åŒ– ç¤ºä¾‹ä»£ç ï¼š 1 2 // ViewModel public DateTime BirthDate { get; set; } = new DateTime(1990, 5, 20); 1 2 \u0026lt;!-- XAML --\u0026gt; \u0026lt;TextBlock Text=\u0026#34;{Binding BirthDate, Converter={StaticResource DateTimeConverter}, ConverterParameter=\u0026#39;yyyy-MM-dd\u0026#39;}\u0026#34; /\u0026gt; æ”¯æŒå‚æ•°ï¼š Format: æŒ‡å®šæ ¼å¼å­—ç¬¦ä¸²ï¼ˆå¦‚ \u0026quot;yyyy-MM-dd\u0026quot;ï¼‰ MinValueString: å½“å€¼ä¸º DateTime.MinValue æ—¶æ˜¾ç¤ºæ›¿ä»£æ–‡æœ¬ åº”ç”¨åœºæ™¯ï¼š æ˜¾ç¤ºç”Ÿæ—¥ã€åˆ›å»ºæ—¶é—´ç­‰æ—¥æœŸå­—æ®µ å¤„ç†ç©ºæ—¥æœŸæ˜¾ç¤ºä¸º - æˆ– N/A 2. BooleanToVisibilityConverterï¼šå¸ƒå°”å€¼è½¬å¯è§æ€§ ç¤ºä¾‹ä»£ç ï¼š 1 2 // ViewModel public bool IsBusy { get; set; } = true; 1 2 \u0026lt;!-- XAML --\u0026gt; \u0026lt;ProgressBar Visibility=\u0026#34;{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}\u0026#34; /\u0026gt; æ”¯æŒå‚æ•°ï¼š TrueValue: true æ—¶è¿”å›çš„å€¼ï¼ˆé»˜è®¤ Visibility.Visibleï¼‰ FalseValue: false æ—¶è¿”å›çš„å€¼ï¼ˆé»˜è®¤ Visibility.Collapsedï¼‰ åº”ç”¨åœºæ™¯ï¼š æ§åˆ¶æŒ‰é’®ã€è¿›åº¦æ¡ã€åŠ è½½åŠ¨ç”»çš„æ˜¾ç¤ºéšè— åŠ¨æ€åˆ‡æ¢æ§ä»¶çŠ¶æ€ 3. EnumWrapperConverterï¼šæšä¸¾æœ¬åœ°åŒ–å±•ç¤º ç¤ºä¾‹ä»£ç ï¼š 1 2 3 4 5 6 7 8 // æšä¸¾å®šä¹‰ public enum PartyMode { [Display(Name = \u0026#34;PartyMode_Off\u0026#34;, ResourceType = typeof(PartyModeResources))] Off, [Display(Name = \u0026#34;PartyMode_On\u0026#34;, ResourceType = typeof(PartyModeResources))] On } 1 2 // ViewModel public PartyMode Mode { get; set; } = PartyMode.On; 1 2 \u0026lt;!-- XAML --\u0026gt; \u0026lt;Label Content=\u0026#34;{Binding Mode, Converter={StaticResource EnumWrapperConverter}}\u0026#34; /\u0026gt; æ”¯æŒç‰¹æ€§ï¼š ä½¿ç”¨ [Display] æ³¨è§£é…åˆ .resx èµ„æºæ–‡ä»¶å®ç°å¤šè¯­è¨€æ”¯æŒ è‡ªåŠ¨è¯†åˆ«å½“å‰ CurrentUICulture åº”ç”¨åœºæ™¯ï¼š å›½é™…åŒ–åº”ç”¨ä¸­çš„ä¸‹æ‹‰èœå•ã€çŠ¶æ€æ ‡ç­¾ å°†æšä¸¾å€¼ä»¥ç”¨æˆ·å‹å¥½çš„æ–¹å¼å±•ç¤º 4. InvertBooleanConverterï¼šå–åå¸ƒå°”å€¼ ç¤ºä¾‹ä»£ç ï¼š 1 2 // ViewModel public bool IsLoggedIn { get; set; } = false; 1 2 \u0026lt;!-- XAML --\u0026gt; \u0026lt;Button Content=\u0026#34;ç™»å½•\u0026#34; Visibility=\u0026#34;{Binding IsLoggedIn, Converter={StaticResource InvertBooleanConverter}}\u0026#34; /\u0026gt; ç‰¹ç‚¹ï¼š ç›´æ¥å°† true å˜ä¸º falseï¼Œåä¹‹äº¦ç„¶ åº”ç”¨åœºæ™¯ï¼š æ§åˆ¶â€œç™»å½•â€å’Œâ€œç™»å‡ºâ€çš„åˆ‡æ¢æ˜¾ç¤º å¿«é€Ÿåè½¬æ§ä»¶çŠ¶æ€ 5. NullToVisibilityConverterï¼šç©ºå€¼æ§åˆ¶å¯è§æ€§ ç¤ºä¾‹ä»£ç ï¼š 1 2 // ViewModel public string UserName { get; set; } = null; 1 2 3 \u0026lt;!-- XAML --\u0026gt; \u0026lt;TextBlock Text=\u0026#34;{Binding UserName}\u0026#34; Visibility=\u0026#34;{Binding UserName, Converter={StaticResource NullToVisibilityConverter}}\u0026#34; /\u0026gt; æ”¯æŒå‚æ•°ï¼š WhenNull: è®¾ç½®ä¸º Visibility.Collapsed æˆ– Visibility.Hidden WhenNotNull: åŒä¸Š åº”ç”¨åœºæ™¯ï¼š éšè—ç©ºå­—æ®µ æ§åˆ¶éç©ºå†…å®¹çš„æ˜¾ç¤º 6. EnumToBooleanConverterï¼šæšä¸¾åŒ¹é…åˆ¤æ–­å¸ƒå°”å€¼ ç¤ºä¾‹ä»£ç ï¼š 1 2 3 4 5 6 7 8 9 10 // æšä¸¾ public enum UserLevel { Guest, Member, Admin } // ViewModel public UserLevel Level { get; set; } = UserLevel.Admin; 1 2 3 \u0026lt;!-- XAML --\u0026gt; \u0026lt;Button Content=\u0026#34;åˆ é™¤ç”¨æˆ·\u0026#34; Visibility=\u0026#34;{Binding Level, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter=Admin}\u0026#34; /\u0026gt; åº”ç”¨åœºæ™¯ï¼š æ ¹æ®è§’è‰²æƒé™æ˜¾ç¤º/éšè—æŒ‰é’® æšä¸¾åŒ¹é…æ—¶å¯ç”¨æŸäº›æ“ä½œ 7. MultiBindingConvertersï¼šå¤šä¸ªç»‘å®šå€¼ç»„åˆè½¬æ¢ ç¤ºä¾‹ï¼šæ ¹æ®ä¸¤ä¸ªå¸ƒå°”å€¼å†³å®šæ˜¯å¦å¯ç”¨æŒ‰é’® 1 2 3 4 5 6 7 8 \u0026lt;Button Content=\u0026#34;æäº¤\u0026#34;\u0026gt; \u0026lt;Button.Visibility\u0026gt; \u0026lt;MultiBinding Converter=\u0026#34;{StaticResource BooleanAndToVisibilityConverter}\u0026#34;\u0026gt; \u0026lt;Binding Path=\u0026#34;IsFormValid\u0026#34; /\u0026gt; \u0026lt;Binding Path=\u0026#34;IsNetworkAvailable\u0026#34; /\u0026gt; \u0026lt;/MultiBinding\u0026gt; \u0026lt;/Button.Visibility\u0026gt; \u0026lt;/Button\u0026gt; æ”¯æŒçš„ MultiConverterï¼š BooleanAndConverter BooleanOrConverter BooleanXorConverter BooleanAndToVisibilityConverter BooleanOrToVisibilityConverter åº”ç”¨åœºæ™¯ï¼š å¤šæ¡ä»¶åˆ¤æ–­æ§ä»¶çŠ¶æ€ è¡¨å•éªŒè¯è”åŠ¨æ§åˆ¶ 8. ImageSourceConverterï¼šå›¾åƒè·¯å¾„è½¬ ImageSource ç¤ºä¾‹ä»£ç ï¼š 1 2 // ViewModel public string AvatarPath { get; set; } = \u0026#34;Images/avatar.png\u0026#34;; 1 2 \u0026lt;!-- XAML --\u0026gt; \u0026lt;Image Source=\u0026#34;{Binding AvatarPath, Converter={StaticResource ImageSourceConverter}}\u0026#34; /\u0026gt; æ”¯æŒå‚æ•°ï¼š æ”¯æŒç›¸å¯¹è·¯å¾„ã€ç»å¯¹è·¯å¾„ã€Base64 å›¾åƒç­‰ åº”ç”¨åœºæ™¯ï¼š æ•°æ®ç»‘å®šå›¾åƒåœ°å€ åŠ¨æ€åŠ è½½å¤´åƒã€å›¾æ ‡ç­‰ 9. FileSizeToStringConverterï¼šå­—èŠ‚å¤§å°è‡ªåŠ¨è½¬ KB/MB/GB ç¤ºä¾‹ä»£ç ï¼š 1 2 // ViewModel public long FileSize { get; set; } = 1024 * 1024 * 10; // 10 MB 1 2 \u0026lt;!-- XAML --\u0026gt; \u0026lt;TextBlock Text=\u0026#34;{Binding FileSize, Converter={StaticResource FileSizeToStringConverter}}\u0026#34; /\u0026gt; è¾“å‡ºç»“æœï¼š10.00 MB\nåº”ç”¨åœºæ™¯ï¼š æ–‡ä»¶ç®¡ç†å™¨ã€ç£ç›˜æ¸…ç†å·¥å…·ç­‰æ˜¾ç¤ºæ–‡ä»¶å¤§å° æ—¥å¿—ç³»ç»Ÿã€ç›‘æ§ç³»ç»Ÿä¸­æ˜¾ç¤ºå†…å­˜å ç”¨ 10. StringFormatConverterï¼šè‡ªå®šä¹‰å­—ç¬¦ä¸²æ ¼å¼åŒ– ç¤ºä¾‹ä»£ç ï¼š 1 2 // ViewModel public decimal Price { get; set; } = 99.99m; 1 2 \u0026lt;!-- XAML --\u0026gt; \u0026lt;TextBlock Text=\u0026#34;{Binding Price, Converter={StaticResource StringFormatConverter}, ConverterParameter=\u0026#39;{}{0:C}\u0026#39;}\u0026#34; /\u0026gt; è¾“å‡ºç»“æœï¼š$99.99ï¼ˆæ ¹æ®æ–‡åŒ–è®¾ç½®ï¼‰\nåº”ç”¨åœºæ™¯ï¼š è´§å¸ã€ç™¾åˆ†æ¯”ã€æ•°å­—æ ¼å¼åŒ–æ˜¾ç¤º æ”¯æŒåŠ¨æ€æ ¼å¼æ¨¡æ¿ ğŸŒ æ–‡åŒ–æ•æ„Ÿæ”¯æŒï¼ˆCulture Awarenessï¼‰ æ‰€æœ‰è½¬æ¢å™¨éƒ½æ”¯æŒæ–‡åŒ–æ„ŸçŸ¥ï¼š\n1 2 // åœ¨ App.xaml.cs æˆ–åˆå§‹åŒ–æ—¶é…ç½® ValueConvertersConfig.DefaultPreferredCulture = ConverterCulture.CurrentUICulture; ä½ ä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶æ›´æ”¹è¯­è¨€å¹¶åˆ·æ–°ç•Œé¢ï¼š\n1 Thread.CurrentThread.CurrentUICulture = new CultureInfo(\u0026#34;zh-CN\u0026#34;); ğŸ“¦ æ€»ç»“ è½¬æ¢å™¨åç§° åŠŸèƒ½ åº”ç”¨åœºæ™¯ DateTimeConverter æ—¥æœŸæ ¼å¼åŒ– æ—¶é—´æˆ³å±•ç¤º BooleanToVisibilityConverter å¸ƒå°”è½¬å¯è§†æ€§ æ§ä»¶æ˜¾ç¤ºéšè— EnumWrapperConverter æšä¸¾æœ¬åœ°åŒ– ä¸‹æ‹‰æ¡†ã€çŠ¶æ€æ  InvertBooleanConverter å¸ƒå°”å–å æ§ä»¶çŠ¶æ€åè½¬ NullToVisibilityConverter ç©ºå€¼æ§åˆ¶å¯è§†æ€§ éšè—ç©ºå­—æ®µ EnumToBooleanConverter æšä¸¾åŒ¹é…å¸ƒå°” æƒé™æ§åˆ¶ ImageSourceConverter å­—ç¬¦ä¸²è·¯å¾„è½¬å›¾åƒæº å›¾åƒç»‘å®š FileSizeToStringConverter å­—èŠ‚æ•°å¤§å°è½¬æ˜“è¯»æ ¼å¼ æ–‡ä»¶ä¿¡æ¯å±•ç¤º StringFormatConverter å­—ç¬¦ä¸²æ ¼å¼åŒ– è´§å¸ã€ç™¾åˆ†æ¯” BooleanAndConverter, BooleanOrConverter å¤šä¸ªå¸ƒå°”å€¼é€»è¾‘è¿ç®— è¡¨å•éªŒè¯ ğŸ§© ç»“è¯­ï¼šä¸ºä»€ä¹ˆæ¨èä½¿ç”¨ ValueConverters.NETï¼Ÿ âœ… æä¾›äº†å¸¸è§åœºæ™¯ä¸‹çš„é«˜è´¨é‡ IValueConverter å®ç° âœ… æ”¯æŒå¤šè¯­è¨€ã€æ–‡åŒ–æ•æ„Ÿ âœ… æ”¯æŒ WPFã€Xamarin.Formsã€MAUI ç­‰ä¸»æµ UI æ¡†æ¶ âœ… å¯æ‰©å±•æ€§å¼ºï¼Œæ˜“äºå°è£…å¤ç”¨ âœ… å‡å°‘ Code-Behindï¼Œå¢å¼º MVVM è§£è€¦èƒ½åŠ› ğŸ“¦ æ¨èä½¿ç”¨æ–¹å¼ å®‰è£…åŒ…ï¼š 1 PM\u0026gt; Install-Package ValueConverters å…¨å±€æ³¨å†Œï¼ˆApp.xamlï¼‰ï¼š 1 2 3 4 \u0026lt;Application.Resources\u0026gt; \u0026lt;converters:BooleanToVisibilityConverter x:Key=\u0026#34;BoolToVisConverter\u0026#34;/\u0026gt; \u0026lt;converters:DateTimeConverter x:Key=\u0026#34;DateTimeConverter\u0026#34; Format=\u0026#34;yyyy-MM-dd\u0026#34;/\u0026gt; \u0026lt;/Application.Resources\u0026gt; ğŸ“š å‚è€ƒèµ„æ–™ GitHub ä»“åº“ï¼šhttps://github.com/thomasgalliker/ValueConverters.NET NuGet åœ°å€ï¼š WPF / WinForms / UWP Xamarin.Forms .NET MAUI ","date":"2025-06-24T17:39:03+08:00","image":"https://www.notion.so/images/page-cover/webb3.jpg","permalink":"https://dumbnessrf.github.io/p/value_converters/","title":"Value Converters"},{"content":"CalcBinding æ˜¯ä¸€ä¸ª WPF ç¬¬ä¸‰æ–¹ç»‘å®šå¢å¼ºåº“ï¼Œå®ƒå…è®¸ä½ åœ¨ XAML ä¸­ä½¿ç”¨è¡¨è¾¾å¼è¿›è¡Œæ•°æ®ç»‘å®šè®¡ç®—ï¼Œè€Œæ— éœ€åœ¨ ViewModel ä¸­å†™é¢å¤–çš„å±æ€§æˆ–è½¬æ¢å™¨ï¼ˆConverterï¼‰ã€‚\u0026ndash;å®ƒéå¸¸é€‚åˆç”¨äºç®€å•çš„æ•°å­¦è¿ç®—ã€å­—ç¬¦ä¸²æ‹¼æ¥ã€æ¡ä»¶åˆ¤æ–­ç­‰åœºæ™¯ã€‚\nğŸ“¦ ä¸€ã€ç®€ä»‹ GitHub åœ°å€ï¼šhttps://github.com/Alex198711/CalcBinding åŠŸèƒ½ï¼šæ”¯æŒç±»ä¼¼ {calcBinding Path=Width*2+Height} çš„è¡¨è¾¾å¼ç»‘å®š ä¸ä¾èµ– IValueConverter æ”¯æŒå¤šç»‘å®šã€æ¡ä»¶è¯­å¥ã€å‡½æ•°è°ƒç”¨ç­‰ ğŸ§© äºŒã€å®‰è£…æ–¹å¼ ä½ å¯ä»¥é€šè¿‡ NuGet å®‰è£…ï¼š\n1 Install-Package CalcBinding ç„¶ååœ¨ XAML ä¸­æ·»åŠ å‘½åç©ºé—´å¼•ç”¨ï¼š\n1 xmlns:calc=\u0026#34;clr-namespace:CalcBinding;assembly=CalcBinding\u0026#34; ğŸ“˜ ä¸‰ã€å¸¸è§ç”¨æ³•ä¸ç¤ºä¾‹ âœ… ç¤ºä¾‹ 1ï¼šåŸºæœ¬æ•°å­¦è¿ç®— 1 \u0026lt;TextBlock Text=\u0026#34;{calc:Binding Path=Width * 2 + Height}\u0026#34; /\u0026gt; å°† Width ä¹˜ä»¥ 2 å†åŠ ä¸Š Heightï¼Œç»“æœä½œä¸º TextBlock.Text\nâœ… ç¤ºä¾‹ 2ï¼šå­—ç¬¦ä¸²æ‹¼æ¥ 1 \u0026lt;TextBlock Text=\u0026#34;{calc:Binding Path=FirstName + \u0026#39; \u0026#39; + LastName}\u0026#34; /\u0026gt; æŠŠä¸¤ä¸ªå­—æ®µæ‹¼æ¥æˆå®Œæ•´å§“å\nâœ… ç¤ºä¾‹ 3ï¼šå¸ƒå°”å€¼è½¬å¯è§æ€§ï¼ˆVisibilityï¼‰ 1 2 \u0026lt;Button Content=\u0026#34;Submit\u0026#34; Visibility=\u0026#34;{calc:Binding Path=IsEnabled ? Visible : Collapsed}\u0026#34; /\u0026gt; ä½¿ç”¨ä¸‰å…ƒè¿ç®—ç¬¦å®ç° Visibility æ§åˆ¶ï¼Œæ— éœ€ Converter\nâœ… ç¤ºä¾‹ 4ï¼šç»‘å®šå¤šä¸ªå±æ€§å¹¶åšè®¡ç®— 1 \u0026lt;TextBlock Text=\u0026#34;{calc:MultiBinding Path1=Value1, Path2=Value2, Expression=Path1 + Path2}\u0026#34; /\u0026gt; å¤šç»‘å®šæ”¯æŒæœ€å¤š 5 ä¸ªè·¯å¾„ï¼ˆPath1~Path5ï¼‰ï¼Œå¯ä»¥ç»„åˆä»»æ„è¡¨è¾¾å¼\nâœ… ç¤ºä¾‹ 5ï¼šä½¿ç”¨ Math å‡½æ•°ï¼ˆå¦‚ Maxã€Minã€Roundï¼‰ 1 \u0026lt;TextBlock Text=\u0026#34;{calc:Binding Path=Math.Max(Width, Height)}\u0026#34; /\u0026gt; æ˜¾ç¤º Width å’Œ Height ä¸­è¾ƒå¤§çš„é‚£ä¸ª\næ”¯æŒçš„å‡½æ•°åŒ…æ‹¬ï¼š\nMath.Abs Math.Round Math.Min Math.Max Math.Ceiling Math.Floor Math.Pow(x, y) Math.Sqrt(x) âœ… ç¤ºä¾‹ 6ï¼šæ¡ä»¶åˆ¤æ–­ç»“åˆç»‘å®š 1 \u0026lt;TextBlock Text=\u0026#34;{calc:Binding Path=Value \u0026gt; 0 ? Value : 0}\u0026#34; /\u0026gt; å¦‚æœ Value å¤§äº 0ï¼Œåˆ™æ˜¾ç¤º Valueï¼Œå¦åˆ™æ˜¾ç¤º 0\nâœ… ç¤ºä¾‹ 7ï¼šç»‘å®šé›†åˆå…ƒç´  1 \u0026lt;TextBlock Text=\u0026#34;{calc:Binding Path=Items[0].Price * Items[0].Quantity}\u0026#34; /\u0026gt; ç»‘å®šé›†åˆä¸­ç¬¬ä¸€ä¸ªå…ƒç´ çš„å±æ€§å¹¶è¿›è¡Œè®¡ç®—\nâœ… ç¤ºä¾‹ 8ï¼šç»‘å®šèµ„æºä¸­çš„é™æ€å€¼ 1 2 3 4 5 \u0026lt;Window.Resources\u0026gt; \u0026lt;sys:Double x:Key=\u0026#34;ScaleFactor\u0026#34;\u0026gt;1.5\u0026lt;/sys:Double\u0026gt; \u0026lt;/Window.Resources\u0026gt; \u0026lt;TextBlock Text=\u0026#34;{calc:Binding Path=Width * {StaticResource ScaleFactor}}\u0026#34; /\u0026gt; å¯ä»¥åœ¨è¡¨è¾¾å¼ä¸­åµŒå…¥é™æ€èµ„æº\nâœ… ç¤ºä¾‹ 9ï¼šä½¿ç”¨æ–¹æ³•è°ƒç”¨ï¼ˆéœ€è¦æ³¨å†Œï¼‰ ä½ å¯ä»¥åœ¨ä»£ç ä¸­æ³¨å†Œè‡ªå®šä¹‰å‡½æ•°ï¼Œä¾‹å¦‚ï¼š\n1 CalcBindingHelper.RegisterFunction(\u0026#34;Format\u0026#34;, (string format, object arg) =\u0026gt; string.Format(format, arg)); ç„¶ååœ¨ XAML ä¸­ä½¿ç”¨ï¼š\n1 \u0026lt;TextBlock Text=\u0026#34;{calc:Binding Path=Format(\u0026#39;{0:C}\u0026#39;, Price)}\u0026#34; /\u0026gt; ç±»ä¼¼æ ¼å¼åŒ–è´§å¸è¾“å‡ºï¼Œæ›¿ä»£ StringFormat\nâœ… ç¤ºä¾‹ 10ï¼šç»‘å®šä¾èµ–å±æ€§ï¼ˆå¦‚æ§ä»¶å°ºå¯¸ï¼‰ 1 2 3 4 5 \u0026lt;Canvas\u0026gt; \u0026lt;Ellipse Width=\u0026#34;50\u0026#34; Height=\u0026#34;50\u0026#34; Canvas.Left=\u0026#34;{calc:Binding ElementName=canvas, Path=ActualWidth / 2 - 25}\u0026#34; Canvas.Top=\u0026#34;{calc:Binding ElementName=canvas, Path=ActualHeight / 2 - 25}\u0026#34; /\u0026gt; \u0026lt;/Canvas\u0026gt; è®¡ç®—æ§ä»¶å±…ä¸­ä½ç½®ï¼Œä¸éœ€è¦åœ¨åå°ä»£ç ä¸­è®¾ç½®å¸ƒå±€é€»è¾‘\nğŸ§ª å››ã€æ€§èƒ½ä¸æ³¨æ„äº‹é¡¹ æ³¨æ„ç‚¹ è¯´æ˜ è¡¨è¾¾å¼å¤æ‚åº¦ é¿å…è¿‡äºå¤æ‚çš„åµŒå¥—è¡¨è¾¾å¼ï¼Œå½±å“å¯è¯»æ€§å’Œè°ƒè¯• è°ƒè¯•å›°éš¾ è¡¨è¾¾å¼é”™è¯¯ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œåªä¼šæ˜¾ç¤ºä¸ºç©ºæˆ–é»˜è®¤å€¼ æ€§èƒ½ ç›¸æ¯”æ™®é€šç»‘å®šç¨æ…¢ï¼Œä½†å¯¹ UI å½±å“ä¸å¤§ å…¼å®¹æ€§ æ”¯æŒ WPFï¼Œä¸æ”¯æŒ UWP æˆ– .NET MAUI ğŸ¯ äº”ã€é€‚åˆä½¿ç”¨çš„åœºæ™¯ ç®€å•çš„æ•°å­¦è®¡ç®—ç»‘å®š å­—ç¬¦ä¸²æ‹¼æ¥ æ¡ä»¶æ§åˆ¶ï¼ˆVisible/Collapsedï¼‰ å¸ƒå±€è°ƒæ•´ï¼ˆåŸºäºæ§ä»¶å¤§å°ï¼‰ æ›¿ä»£ç®€å• Converter çš„åœºæ™¯ ğŸ§© å…­ã€æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯” æ–¹æ¡ˆ ä¼˜ç‚¹ ç¼ºç‚¹ CalcBinding å¿«é€Ÿç¼–å†™è¡¨è¾¾å¼ï¼Œæ— éœ€ Converter ä¸æ˜“è°ƒè¯•ï¼Œä¸é€‚åˆå¤æ‚é€»è¾‘ IValueConverter æ›´å¼ºç±»å‹å®‰å…¨å’Œé€»è¾‘æ§åˆ¶ éœ€è¦ç¼–å†™é¢å¤–ç±» MultiBinding + IMultiValueConverter æ”¯æŒå¤šå€¼ç»‘å®š å®ç°ç¹ç XAML Binding.StringFormat ç®€å•æ ¼å¼åŒ– ä¸æ”¯æŒè¡¨è¾¾å¼è®¡ç®— ","date":"2025-06-06T14:46:48+08:00","image":"https://www.notion.so/images/page-cover/rijksmuseum_mignons_1660.jpg","permalink":"https://dumbnessrf.github.io/p/calcbinding/","title":"WPFæŠ€å·§-XAMLä¸­ä½¿ç”¨è¡¨è¾¾å¼è¿›è¡Œæ•°æ®ç»‘å®šè®¡ç®—"},{"content":"ReactiveUI åŸºç¡€ç”¨æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 using System; using System.Reactive.Linq; using ReactiveUI; namespace AvaloniaApplication1.ViewModels; public partial class MainWindowViewModel : ViewModelBase { [ObservableProperty] public partial string Text1 { get; set; } [ObservableProperty] public partial string Text2 { get; set; } [ObservableProperty] public partial string Result { get; set; } public MainWindowViewModel() { this.WhenAnyValue(s =\u0026gt; s.Text1, s =\u0026gt; s.Text2) .Where(s =\u0026gt; double.TryParse(s.Item1, out _) \u0026amp;\u0026amp; double.TryParse(s.Item2, out _)) .Subscribe(s =\u0026gt; Calculate()); this.WhenAnyValue(s =\u0026gt; s.Text1, s =\u0026gt; s.Text2) .Where(s =\u0026gt; !double.TryParse(s.Item1, out _) || !double.TryParse(s.Item2, out _)) .Subscribe(s =\u0026gt; Clear()); } void Calculate() { Result = (double.Parse(Text1) + double.Parse(Text2)).ToString(); } void Clear() { Result = string.Empty; } } åªæœ‰å½“Text1å’ŒText2å‘ç”Ÿå˜åŒ–ä¸”ä¸ä¸ºç©ºæ—¶æ‰è®¢é˜…Calculateäº‹ä»¶ï¼Œä¸ºç©ºæ—¶è®¢é˜…Clearäº‹ä»¶\nWhenAnyã€WhenAnyValueã€WhenAnyObservable WhenAnyÂ æ˜¯ä¸€ç»„æ‰©å±•æ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½ä»¥å‰ç¼€Â WhenAnyÂ å¼€å¤´ï¼Œå¯ç”¨äºåœ¨å¯¹è±¡çš„å±æ€§å‘ç”Ÿæ›´æ”¹æ—¶è·å–é€šçŸ¥ã€‚\nåœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼ŒWhenAnyValueÂ åº”è¯¥ä¼˜å…ˆäºÂ WhenAnyï¼Œå¹¶ä¸”æ‚¨ä¸éœ€è¦çŸ¥é“Senderæˆ–Expression\nWhenAnyÂ å˜ä½“æ”¯æŒå¤šç§å±æ€§æ›´æ”¹é€šçŸ¥ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥æ”¯æŒè§†å›¾æ¨¡å‹çš„Â INotifyPropertyChangedÂ ã€åŸºäº Windows çš„ XAML å¹³å°ä¸Šçš„Â DependencyPropertyÂ ä»¥åŠ Apple å¹³å°ä¸Šçš„Â NSObjectÂ å±æ€§æ›´æ”¹é€šçŸ¥ã€‚è¦è·å–å€¼æ›´æ”¹é€šçŸ¥ï¼Œæ‚¨çš„å¯¹è±¡å¿…é¡»å®ç°è¿™äº›å·²çŸ¥çš„å±æ€§æ›´æ”¹é€šçŸ¥æœºåˆ¶ä¹‹ä¸€ã€‚ å¦‚æœå…¶ä¸­ä¸€ä¸ªä¸æ”¯æŒï¼Œæ‚¨å°†åªèƒ½è·å–å±æ€§çš„åˆå§‹å€¼ï¼Œè€Œä¸ä¼šæ”¶åˆ°ä»»ä½•æ›´æ–°é€šçŸ¥ã€‚æ­¤å¤–ï¼Œè¿è¡Œæ—¶è¿˜ä¼šå‘å‡ºè­¦å‘Šï¼ˆè¯·ç¡®ä¿æ‚¨å·²æ³¨å†ŒÂ ILoggerÂ æœåŠ¡ä»¥ä¾¿æŸ¥çœ‹æ­¤è­¦å‘Šï¼‰ã€‚\nWhenAnyValue IObservable\u0026lt;TRet\u0026gt; WhenAnyValue\u0026lt;TSender, TRet\u0026gt;( this TSender? sender, Expression\u0026lt;Func\u0026lt;TSender, TRet\u0026gt;\u0026gt; property1)\nç”±äºè¡¨è¾¾å¼å°šä¸æ”¯æŒæ­¤åŠŸèƒ½ï¼Œå› æ­¤Â WhenAnyValueÂ ä¸èƒ½ç›´æ¥æ‰§è¡Œç©ºä¼ æ’­ã€‚ ä½ å¯ä»¥é€šè¿‡å°†Â WhenAnyValue()Â è°ƒç”¨é“¾æ¥åˆ°æ¯ä¸ªå±æ€§æ¥æ¨¡æ‹Ÿå¯¹ç©ºå€¼ä¼ æ’­çš„æ”¯æŒã€‚ä»¥ä¸‹æ˜¯ç¤ºä¾‹ï¼š\n1 2 this.WhenAnyValue(x =\u0026gt; x.Foo, x =\u0026gt; x.Foo.Bar, x =\u0026gt; x.Foo.Bar.Baz, (foo, bar, baz) =\u0026gt; foo?.Bar?.Baz) .Subscribe(x =\u0026gt; Console.WriteLine(x)); WhenAny WhenAnyÂ å…è®¸æ‚¨è·å–ä¼ é€’åˆ°Â WhenAny ä¸­çš„è¡¨è¾¾å¼å’Œè¡¨è¾¾å¼ã€‚è¿™å¯¹äºä¸€äº›åœºæ™¯æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œæ¯”å¦‚åœ¨è§†å›¾ä¸­ï¼Œä½ éœ€è¦çŸ¥é“è°ƒç”¨å±æ€§æ”¹å˜çš„æ§ä»¶ã€‚\nWhenAnyÂ ä»…å‘ŠçŸ¥æ‚¨è¾“å…¥è¡¨è¾¾å¼çš„æœ€ç»ˆå€¼ä½•æ—¶å‘ç”Ÿå˜åŒ–ã€‚å³ä½¿æœ€ç»ˆçš„å˜åŒ–æ˜¯ç”±äºè¡¨è¾¾å¼é“¾ä¸­çš„ä¸­é—´å€¼å¼•èµ·çš„ï¼Œä¹Ÿæ˜¯å¦‚æ­¤ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªè§£é‡Šæ€§ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 this.WhenAny(x =\u0026gt; x.Foo.Bar.Baz, _ =\u0026gt; \u0026#34;Hello!\u0026#34;) .Subscribe(x =\u0026gt; Console.WriteLine(x)); // Example 1 this.Foo.Bar.Baz = \u0026#34;Something\u0026#34;; \u0026gt;\u0026gt;\u0026gt; Hello! // Example 2: Nothing printed! Because the string value does not change this.Foo.Bar.Baz = \u0026#34;Something\u0026#34;; // Example 3: Still nothingï¼Because the expression is Foo.Bar.Bazï¼Œnot Foo.Bar this.Foo.Bar = new Bar() { Baz = \u0026#34;Something\u0026#34; }; // Example 4: The result changes, so we print this.Foo.Bar = new Bar() { Baz = \u0026#34;Else\u0026#34; }; \u0026gt;\u0026gt;\u0026gt; Hello! WhenAnyÂ ä»…åœ¨è¯»å–ç»™å®šè¡¨è¾¾å¼ä¸ä¼šæŠ›å‡ºÂ NullReferenceExceptionÂ æ—¶æ‰ä¼šå‘é€é€šçŸ¥ã€‚è¯·è€ƒè™‘ä»¥ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 this.WhenAny(x =\u0026gt; x.Foo.Bar.Baz, _ =\u0026gt; \u0026#34;Hello!\u0026#34;) .Subscribe(x =\u0026gt; Console.WriteLine(x)); // Example 1 this.Foo.Bar.Baz = null; \u0026gt;\u0026gt;\u0026gt; Hello! // Example 2: Nothing printed! this.Foo.Bar = null; // Example 3 this.Foo.Bar = new Bar() { Baz = \u0026#34;Something\u0026#34; }; \u0026gt;\u0026gt;\u0026gt; Hello! WhenAnyObservable WhenAnyObservableÂ ä¼šè§‚å¯Ÿä¸€ä¸ªæˆ–å¤šä¸ªå¯è§‚å¯Ÿå¯¹è±¡å¹¶æä¾›æœ€æ–°çš„å¯è§‚å¯Ÿå€¼ï¼Œå¤„ç†æ–°å¯è§‚å¯Ÿå¯¹è±¡çš„è‡ªåŠ¨è®¢é˜…ä»¥åŠÂ WhenAnyObservableÂ å¯è§‚å¯Ÿå¯¹è±¡çš„å¤„ç†ã€‚WhenAnyObservable é»˜è®¤ä¸ºæƒ°æ€§è®¢é˜…ï¼Œè¿™æ„å‘³ç€åœ¨è®¢é˜…ä¹‹å‰ä¸ä¼šè·å¾—ä»»ä½•å€¼(å…¶ä»–çš„Whenåœ¨Ctorå®Œæˆæ—¶å°±ä¼šé€šçŸ¥ï¼Œè¿™ä¸ªåªæœ‰åœ¨æ›´æ”¹æ—¶æ‰ä¼šé€šçŸ¥)ã€‚\næ¯å½“æ–‡æ¡£ä¿å­˜æ—¶ï¼Œå®ƒéƒ½ä¼šæ‰“å°æ¥è‡ªÂ IsSavedÂ å¯è§‚å¯Ÿå˜é‡çš„å€¼ã€‚å½“Â DocumentÂ å±æ€§å‘ç”Ÿæ›´æ”¹æ—¶ï¼Œå®ƒå°†è‡ªåŠ¨å–æ¶ˆè®¢é˜…å¹¶é‡æ–°è®¢é˜…ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public class MyViewModel { [Reactive] public Document Document { get; set; } public MyViewModel() { this.WhenAnyObservable(x =\u0026gt; x.Document.IsSaved).Subscribe(x =\u0026gt; Console.WriteLine($\u0026#34;Document Saved: {x}\u0026#34;)); } } public class Document { public IObservable\u0026lt;bool\u0026gt; IsSaved { get; } } Where ä»…ä» Observable ä¸­å‘å‡ºé‚£äº›é€šè¿‡è°“è¯æµ‹è¯•çš„é¡¹ IObservable\u0026lt;TSource\u0026gt; Where\u0026lt;TSource\u0026gt;(this IObservable\u0026lt;TSource\u0026gt; source, Func\u0026lt;TSource, bool\u0026gt; predicate)\nSubscribe æ ¹æ®äº‹ä»¶æºçš„å‘å‡ºçš„äº‹ä»¶æˆ–é€šçŸ¥è¿›è¡Œæ“ä½œ\næ³¨æ„ï¼šè¯¥æ“ä½œç¬¦ä¹‹åå°†è¿”å›IDisposableï¼Œè€Œä¸æ˜¯IObservable\nIDisposable Subscribe\u0026lt;T\u0026gt;(this IObservable\u0026lt;T\u0026gt; source, Action\u0026lt;T\u0026gt; onNext)\nSubscribeOn æŒ‡å®šäº‹ä»¶æºåœ¨è®¢é˜…æ—¶åº”ä½¿ç”¨çš„è°ƒåº¦å™¨\nSubscribeOnÂ è¿ç®—ç¬¦æŒ‡å®š Observable å°†å¼€å§‹åœ¨å“ªä¸ªçº¿ç¨‹ä¸Šè¿è¡Œï¼Œè€Œä¸ç®¡è¯¥è¿ç®—ç¬¦åœ¨è¿ç®—ç¬¦é“¾ä¸­çš„å“ªä¸ªç‚¹è¢«è°ƒç”¨ã€‚å¦ä¸€æ–¹é¢ï¼ŒObserveOnÂ ä¼šå½±å“ Observable å°†ä½¿ç”¨çš„çº¿ç¨‹ï¼ŒÂ è¯¥çº¿ç¨‹ä½äºè¯¥è¿ç®—ç¬¦å‡ºç°çš„ä½ç½®ä¸‹æ–¹ã€‚ å› æ­¤ï¼Œæ‚¨å¯ä»¥è°ƒç”¨ åœ¨ Observable é“¾ä¸­çš„ä¸åŒç‚¹å¤šæ¬¡è¿›è¡Œ ObserveOnÂ è¿ç®—ç¬¦ï¼Œä»¥ä¾¿æ›´æ”¹æŸäº›è¿ç®—ç¬¦åœ¨å“ªäº›çº¿ç¨‹ä¸Šè¿›è¡Œä½œã€‚\nIObservable\u0026lt;TSource\u0026gt; SubscribeOn\u0026lt;TSource\u0026gt;(this IObservable\u0026lt;TSource\u0026gt; source, IScheduler scheduler)\nğŸ“¢ 1 2 3 4 this.WhenAnyValue(s =\u0026gt; s.Text1, s =\u0026gt; s.Text2) .SubscribeOn(RxApp.MainThreadScheduler) .SubscribeOn(RxApp.TaskpoolScheduler) .SubscribeOn(SynchronizationContext.Current) ğŸ“¢ RxApp.MainThreadScheduler\nè·å–æˆ–è®¾ç½®ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œè¯¥è°ƒåº¦å™¨ç”¨äºå¯¹é‚£äº›åº”åœ¨ â€œç”¨æˆ·ç•Œé¢ (UI) çº¿ç¨‹ä¸Šâ€ è¿è¡Œçš„å·¥ä½œé¡¹è¿›è¡Œè°ƒåº¦ã€‚åœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œè¿™å°†æ˜¯Â DispatcherSchedulerï¼ˆåˆ†å‘å™¨è°ƒåº¦å™¨ï¼‰ï¼Œè€Œåœ¨å•å…ƒæµ‹è¯•æ¨¡å¼ä¸‹ï¼Œè¿™å°†æ˜¯Â Immediateï¼ˆå³æ—¶è°ƒåº¦å™¨ï¼‰ï¼Œä»¥ä¾¿ç®€åŒ–å¸¸è§å•å…ƒæµ‹è¯•çš„ç¼–å†™å·¥ä½œã€‚\nRxApp.TaskpoolScheduler\nè·å–æˆ–è®¾ç½®ç”¨äºè°ƒåº¦å·¥ä½œé¡¹ä»¥åœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œçš„è°ƒåº¦å™¨ã€‚åœ¨ä¸¤ç§æ¨¡å¼ä¸‹ï¼Œè¿™äº›å·¥ä½œé¡¹éƒ½å°†åœ¨ TPLï¼ˆä»»åŠ¡å¹¶è¡Œåº“ï¼‰ä»»åŠ¡æ± ä¸­è¿è¡Œã€‚\nSynchronizationContext.Current Thread.CurrentThread._synchronizationContext\nThrottle æ­¤æ“ä½œç¬¦ä¼šå¯¹æºåºåˆ—è¿›è¡Œé™æµï¼Œå…·ä½“åšæ³•æ˜¯å¯¹æ¯ä¸ªå…ƒç´ ä¿ç•™Â dueTimeï¼ˆæŒ‡å®šæ—¶é•¿ï¼‰ã€‚è‹¥åœ¨è¿™ä¸ªæ—¶é—´çª—å£å†…åˆäº§ç”Ÿäº†å¦ä¸€ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆå‰ä¸€ä¸ªå…ƒç´ ä¼šè¢«ä¸¢å¼ƒï¼Œå¹¶ä¸”ä¼šä¸ºå½“å‰å…ƒç´ å¯åŠ¨ä¸€ä¸ªæ–°çš„è®¡æ—¶å™¨ï¼Œå¦‚æ­¤å¾ªç¯å¾€å¤ã€‚å¯¹äºå…ƒç´ é—´é—´éš”ä»ä¸å¤§äºæˆ–ç­‰äºÂ dueTimeÂ çš„æµï¼Œç»è¿‡å¤„ç†åçš„æµå°†ä¸ä¼šäº§ç”Ÿä»»ä½•å…ƒç´ ã€‚è‹¥è¦åœ¨ä¿è¯å…ƒç´ å‘¨æœŸæ€§äº§ç”Ÿçš„åŒæ—¶å‡å°‘æµçš„æ•°æ®é‡ï¼Œå¯è€ƒè™‘ä½¿ç”¨Â Observable.SampleÂ ç³»åˆ—æ“ä½œç¬¦ã€‚\n1 2 3 this.WhenAnyValue(s =\u0026gt; s.Text1) .Throttle(TimeSpan.FromSeconds(1)) .Subscribe(s =\u0026gt; Calculate()); Sampleã€Interval 1 2 3 4 5 6 var sub = Observable .Interval(TimeSpan.FromSeconds(0.01)) .Sample(TimeSpan.FromMilliseconds(500)) .Subscribe(s =\u0026gt; Result=s.ToString()); await Task.Delay(TimeSpan.FromSeconds(2)); sub.Dispose(); æ¯ 10 æ¯«ç§’å‘å‡ºä¸€ä¸ªå€¼çš„å¯è§‚å¯Ÿåºåˆ—ï¼Œæ¯ 500 æ¯«ç§’å¯¹è¿™ä¸ªåºåˆ—è¿›è¡Œä¸€æ¬¡é‡‡æ ·ï¼Œå°†é‡‡æ ·å¾—åˆ°çš„å€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶èµ‹å€¼ç»™Â ResultÂ å˜é‡ï¼ŒæŒç»­æ‰§è¡Œ 2 ç§’åå–æ¶ˆè®¢é˜…å¹¶é‡Šæ”¾èµ„æºï¼›å°½ç®¡2så†…é€šè¿‡Intervaläº§ç”Ÿäº†200ä¸ªï¼Œä½†æ˜¯ç”±äºSampleï¼Œæˆ‘åªé‡‡æ ·åˆ°äº†4ä¸ª\nTimerã€Amb 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 using System.Reactive.Linq; var observable1 = Observable.Timer(TimeSpan.FromMilliseconds(200)) .Select(_ =\u0026gt; \u0026#34;Observable 1\u0026#34;); // åˆ›å»ºç¬¬äºŒä¸ªå¯è§‚æµ‹åºåˆ—ï¼Œå»¶è¿Ÿ 100 æ¯«ç§’åå‘å°„å…ƒç´  var observable2 = Observable.Timer(TimeSpan.FromMilliseconds(100)) .Select(_ =\u0026gt; \u0026#34;Observable 2\u0026#34;); // ä½¿ç”¨ Amb æ“ä½œç¬¦é€‰æ‹©ç¬¬ä¸€ä¸ªäº§ç”Ÿå…ƒç´ çš„åºåˆ— var result = observable1.Amb(observable2); // è®¢é˜…ç»“æœåºåˆ— result.Subscribe( value =\u0026gt; Console.WriteLine($\u0026#34;Received: {value}\u0026#34;), error =\u0026gt; Console.WriteLine($\u0026#34;Error: {error}\u0026#34;), () =\u0026gt; Console.WriteLine(\u0026#34;Completed\u0026#34;) ); å€ŸåŠ©Â Observable.TimerÂ æ¥åˆ›å»ºä¸¤ä¸ªå¯è§‚æµ‹åºåˆ—Â observable1Â å’ŒÂ observable2ï¼Œå®ƒä»¬ä¼šåœ¨ç‰¹å®šå»¶è¿Ÿåå‘å°„å…ƒç´ ã€‚\nåœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œç”±äºÂ observable2Â å»¶è¿Ÿ 100 æ¯«ç§’ï¼Œæ¯”Â observable1Â çš„ 200 æ¯«ç§’å»¶è¿Ÿè¦çŸ­ï¼Œæ‰€ä»¥Â observable2Â ä¼šç‡å…ˆäº§ç”Ÿå…ƒç´ ï¼ŒAmbÂ æ“ä½œç¬¦ä¼šé€‰æ‹©Â observable2Â å¹¶å¿½ç•¥Â observable1ã€‚\nReceived: Observable 2\nCompleted\nRetryã€Catch Retryå…è®¸åœ¨å‘ç”Ÿé”™è¯¯æ—¶æˆ–æŠ›å‡ºé”™è¯¯æ—¶é‡æ–°è®¢é˜…æºåºåˆ—ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç åˆ›å»ºä¸€ä¸ªä¼šæŠ›å‡ºå¼‚å¸¸çš„åºåˆ—ï¼Œå¹¶é€šè¿‡Retry(2)æœ€å¤šé‡è¯•2æ¬¡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 using System; using System.Reactive.Disposables; using System.Reactive.Linq; var source = Observable.Create\u0026lt;int\u0026gt;(observer =\u0026gt; { Console.WriteLine(\u0026#34;Doing work...\u0026#34;); // throw new Exception(\u0026#34;Initial failure\u0026#34;); observer.OnError(new Exception(\u0026#34;Initial failure\u0026#34;)); return Disposable.Empty; }); source .Retry(2) // å‘ç”Ÿé”™è¯¯æ—¶é‡æ–°è®¢é˜…æºåºåˆ—ï¼Œæœ€å¤šå°è¯•2æ¬¡ .Subscribe( x =\u0026gt; Console.WriteLine(\u0026#34;OnNext: \u0026#34; + x), ex =\u0026gt; Console.WriteLine(\u0026#34;OnError: \u0026#34; + ex.Message), () =\u0026gt; Console.WriteLine(\u0026#34;OnCompleted\u0026#34;) ); è¾“å‡º\nDoing work\u0026hellip;\nDoing work\u0026hellip;\nOnError: Initial failure\n**Catch**ç”¨äºæ•è·å¼‚å¸¸å¹¶æ›¿æ¢ä¸ºæ–°çš„åºåˆ—ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç åœ¨å‘ç”Ÿé”™è¯¯åè¿”å›ä¸€ä¸ªå¤‡ç”¨å€¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 using System; using System.Reactive.Disposables; using System.Reactive.Linq; var source = Observable.Create\u0026lt;int\u0026gt;(observer =\u0026gt; { observer.OnError(new Exception(\u0026#34;Primary error\u0026#34;)); return Disposable.Empty; }); source .Catch(Observable.Return(42)) // æ•è·å¼‚å¸¸å¹¶æ›¿æ¢ä¸ºå€¼42 .Subscribe( x =\u0026gt; Console.WriteLine(\u0026#34;OnNext: \u0026#34; + x), ex =\u0026gt; Console.WriteLine(\u0026#34;OnError: \u0026#34; + ex.Message), () =\u0026gt; Console.WriteLine(\u0026#34;OnCompleted\u0026#34;) ); OnNext: 42\nOnCompleted\nScanã€Buffer Scan ç”¨äºå¯¹åºåˆ—ä¸­çš„æ¯ä¸ªå…ƒç´ è¿ç»­åº”ç”¨ç´¯ç§¯å‡½æ•°ï¼Œå¹¶è¾“å‡ºä¸­é—´ç»“æœã€‚ç±»ä¼¼äºLINQçš„ Aggregateï¼Œä½†ä¼šå‘å°„æ‰€æœ‰ä¸­é—´å€¼\n1 2 3 4 5 6 7 using System.Reactive.Linq; var source = Observable.Range(1, 5); // ç”Ÿæˆ1åˆ°5çš„åºåˆ— source .Scan(0, (acc, val) =\u0026gt; acc + val) // åˆå§‹å€¼0ï¼Œç´¯åŠ å½“å‰å€¼ .Subscribe(x =\u0026gt; Console.WriteLine(\u0026#34;Scan Result: \u0026#34; + x)); Scan Result: 1\nScan Result: 3\nScan Result: 6\nScan Result: 10\nScan Result: 15\nBuffer å°†äº‹ä»¶æµæŒ‰æ—¶é—´æˆ–æ•°é‡åˆ†ç»„ï¼Œè¾“å‡ºæ‰¹é‡æ•°æ®ã€‚å¸¸è§ç”¨æ³•åŒ…æ‹¬æŒ‰æ—¶é—´çª—å£æˆ–å…ƒç´ æ•°é‡ç¼“å†²ã€‚\n1 2 3 4 5 6 7 8 9 using System.Reactive.Linq; var source = Observable.Interval(TimeSpan.FromSeconds(1)) // æ¯ç§’å‘å°„é€’å¢æ•° .Take(10); // é™åˆ¶æ€»å‘å°„æ¬¡æ•° // æŒ‰æ—¶é—´çª—å£ï¼ˆ5ç§’ï¼‰å’Œæœ€å¤§æ•°é‡ï¼ˆ3ä¸ªå…ƒç´ ï¼‰ç¼“å†² source .Buffer(TimeSpan.FromSeconds(5), 3) .Subscribe(buffer =\u0026gt; Console.WriteLine($\u0026#34;Buffered Count: {buffer.Count}\u0026#34;)); Buffered Count: 3 // ç¬¬1-3ç§’çš„æ•°æ®\nBuffered Count: 3 // ç¬¬4-5ç§’çš„æ•°æ®ï¼ˆå¯èƒ½è§¦å‘æ—¶é—´çª—å£ï¼‰\nBuffered Count: 3 // ä¸‹ä¸€ä¸ªçª—å£\nBuffered Count: 1 // å‰©ä½™1ä¸ªå…ƒç´ \nğŸ“¢ Buffer æ”¯æŒå¤šç§åˆ†ç»„ç­–ç•¥ï¼Œå¦‚çº¯æ—¶é—´çª—å£ï¼ˆBuffer(TimeSpan)ï¼‰ã€çº¯æ•°é‡ï¼ˆBuffer(count)ï¼‰æˆ–ä¸¤è€…ç»“åˆ\nDistinctã€DistinctUntilChanged Distinctï¼šè¿‡æ»¤åºåˆ—ä¸­æ‰€æœ‰é‡å¤çš„å…ƒç´ ï¼Œä»…ä¿ç•™é¦–æ¬¡å‡ºç°çš„å…ƒç´ ã€‚\n1 2 3 4 var source = new[] { 1, 2, 2, 3, 3, 3 }; source.ToObservable() .Distinct() .Subscribe(x =\u0026gt; Console.WriteLine(x)); è¾“å‡º ï¼š1, 2, 3\nDistinctUntilChangedï¼šä»…è¿‡æ»¤è¿ç»­é‡å¤ çš„å…ƒç´ ï¼Œä¿ç•™ç¬¬ä¸€ä¸ªï¼Œåç»­è¿ç»­ç›¸åŒçš„å…ƒç´ è¢«ä¸¢å¼ƒã€‚\n1 2 3 4 var source = new[] { 1, 2, 2, 3, 2, 2 }; source.ToObservable() .DistinctUntilChanged() .Subscribe(x =\u0026gt; Console.WriteLine(x)); è¾“å‡º ï¼š1, 2, 3, 2\nZip Zip ç”¨äºåˆå¹¶ä¸¤ä¸ªåºåˆ—ï¼Œé€ä¸ªé…å¯¹å…ƒç´ å¹¶ç”Ÿæˆç»“æœã€‚åœ¨ Rx ä¸­ï¼Œå®ƒå¸¸ç”¨äºç»„åˆå¤šä¸ªå¼‚æ­¥æ•°æ®æµã€‚\n1 2 3 4 5 6 7 using System.Reactive.Linq; var numbers = Observable.Range(1, 3); // 1, 2, 3 var letters = Observable.Return(\u0026#34;A\u0026#34;).Concat(Observable.Return(\u0026#34;B\u0026#34;)); // A, B numbers.Zip(letters, (n, l) =\u0026gt; $\u0026#34;{n}{l}\u0026#34;) .Subscribe(result =\u0026gt; Console.WriteLine(result)); 1A\n2B\nDelayã€Doã€TimeInterval 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 using System; using System.Reactive.Linq; using System.Reactive.Concurrency; class Program { static void Main() { var source = Observable.Interval(TimeSpan.FromSeconds(1)) // æ¯ç§’å‘å°„é€’å¢æ•° .Take(5); // é™åˆ¶å‘å°„æ¬¡æ•°ä¸º5æ¬¡ source .Delay(TimeSpan.FromSeconds(0.5)) // å»¶è¿Ÿ0.5ç§’åå‘å°„å…ƒç´  [[4]] .Do(x =\u0026gt; Console.WriteLine($\u0026#34;Do: è¢«å»¶è¿Ÿçš„å€¼ = {x}\u0026#34;)) // è®°å½•ä¸­é—´çŠ¶æ€ [[6]] .TimeInterval() // æµ‹é‡è¿ç»­äº‹ä»¶çš„æ—¶é—´é—´éš” [[1]] .Subscribe( interval =\u0026gt; Console.WriteLine($\u0026#34;TimeInterval: å€¼={interval.Value}, é—´éš”={interval.Interval.TotalSeconds}ç§’\u0026#34;), ex =\u0026gt; Console.WriteLine($\u0026#34;OnError: {ex.Message}\u0026#34;), () =\u0026gt; Console.WriteLine(\u0026#34;OnCompleted\u0026#34;) // åºåˆ—ç»“æŸ [[10]] ); // ç¡®ä¿ä¸»çº¿ç¨‹ç­‰å¾…è¶³å¤Ÿæ—¶é—´ä»¥è§‚å¯Ÿè¾“å‡º Console.ReadLine(); } } æµç¨‹ ï¼š æ¯ç§’ç”Ÿæˆä¸€ä¸ªæ•°å­—ï¼ˆIntervalï¼‰ã€‚ å»¶è¿Ÿ0.5ç§’åå‘å°„ï¼ˆDelayï¼‰ã€‚ è®°å½•å»¶è¿Ÿåçš„å€¼ï¼ˆDoï¼‰ã€‚ è®¡ç®—ç›¸é‚»å€¼çš„å‘å°„æ—¶é—´é—´éš”ï¼ˆTimeIntervalï¼‰ã€‚ åºåˆ—ç»“æŸæ—¶è‡ªåŠ¨è§¦å‘ OnCompletedã€‚ Do: è¢«å»¶è¿Ÿçš„å€¼ = 0\nTimeInterval: å€¼=0, é—´éš”=1.5369618ç§’\nDo: è¢«å»¶è¿Ÿçš„å€¼ = 1\nTimeInterval: å€¼=1, é—´éš”=0.9820277ç§’\nDo: è¢«å»¶è¿Ÿçš„å€¼ = 2\nTimeInterval: å€¼=2, é—´éš”=0.9995484ç§’\nDo: è¢«å»¶è¿Ÿçš„å€¼ = 3\nTimeInterval: å€¼=3, é—´éš”=1.0001499ç§’\nDo: è¢«å»¶è¿Ÿçš„å€¼ = 4\nTimeInterval: å€¼=4, é—´éš”=1.0005686ç§’\nOnCompleted\nAverageã€Concatã€Countã€Maxã€Minã€Aggregateã€Sum 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 using System; using System.Reactive.Linq; class Program { static void Main() { // åˆ›å»ºç¬¬ä¸€ä¸ªåºåˆ— var source1 = Observable.Range(1, 3); // å‘å°„ 1, 2, 3 // åˆ›å»ºç¬¬äºŒä¸ªåºåˆ— var source2 = Observable.Range(4, 2); // å‘å°„ 4, 5 // ä½¿ç”¨ Concat åˆå¹¶ä¸¤ä¸ªåºåˆ— [[3]] var concatenated = source1.Concat(source2); // åº”ç”¨èšåˆæ“ä½œç¬¦ concatenated .Count() // è®¡ç®—æ€»é¡¹æ•° [[1]] .Subscribe(count =\u0026gt; Console.WriteLine($\u0026#34;Total Count: {count}\u0026#34;)); concatenated .Sum() // è®¡ç®—æ€»å’Œ [[9]] .Subscribe(sum =\u0026gt; Console.WriteLine($\u0026#34;Total Sum: {sum}\u0026#34;)); concatenated .Average() // è®¡ç®—å¹³å‡å€¼ [[9]] .Subscribe(avg =\u0026gt; Console.WriteLine($\u0026#34;Average: {avg}\u0026#34;)); concatenated .Min() // æŸ¥æ‰¾æœ€å°å€¼ .Subscribe(min =\u0026gt; Console.WriteLine($\u0026#34;Min: {min}\u0026#34;)); concatenated .Max() // æŸ¥æ‰¾æœ€å¤§å€¼ .Subscribe(max =\u0026gt; Console.WriteLine($\u0026#34;Max: {max}\u0026#34;)); // ä½¿ç”¨ Aggregate è‡ªå®šä¹‰èšåˆé€»è¾‘ï¼ˆç±»ä¼¼ Sumï¼‰ concatenated .Aggregate((acc, val) =\u0026gt; acc + val) // ç´¯ç§¯æ±‚å’Œ [[9]] .Subscribe(total =\u0026gt; Console.WriteLine($\u0026#34;Reduce (Custom Sum): {total}\u0026#34;)); Console.ReadLine(); // é˜²æ­¢æ§åˆ¶å°é€€å‡º } } Total Count: 5\nTotal Sum: 15\nAverage: 3\nMin: 1\nMax: 5\nReduce (Custom Sum): 15\nAllã€Containsã€TakeUntilã€StartWith ã€Join 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 using System; using System.Reactive.Linq; class Program { static void Main() { // ç¤ºä¾‹åºåˆ—1ï¼šæ•°å­—åºåˆ— [1, 2, 3, 4, 5] var numbers = Observable.Range(1, 5); // ç¤ºä¾‹åºåˆ—2ï¼šå­—ç¬¦ä¸²åºåˆ— [\u0026#34;A\u0026#34;, \u0026#34;B\u0026#34;, \u0026#34;C\u0026#34;] var letters = Observable.Range(0, 3).Select(x =\u0026gt; ((char)(\u0026#39;A\u0026#39; + x)).ToString()); // StartWith: åœ¨åºåˆ—å¼€å§‹å‰æ·»åŠ å…ƒç´  [0, 1, 2, 3, 4, 5] var startWithExample = numbers.StartWith(0); startWithExample.Subscribe(x =\u0026gt; Console.WriteLine($\u0026#34;StartWith: {x}\u0026#34;)); // All: æ£€æŸ¥æ‰€æœ‰å…ƒç´ æ˜¯å¦å¤§äº0 numbers.All(x =\u0026gt; x \u0026gt; 0) .Subscribe(result =\u0026gt; Console.WriteLine($\u0026#34;All \u0026gt; 0: {result}\u0026#34;)); // è¾“å‡º true // Contains: åˆ¤æ–­åºåˆ—æ˜¯å¦åŒ…å«å…ƒç´  3 numbers.Contains(3) .Subscribe(result =\u0026gt; Console.WriteLine($\u0026#34;Contains 3: {result}\u0026#34;)); // è¾“å‡º true // TakeUntil: å½“å¦ä¸€ä¸ªåºåˆ—ï¼ˆå¦‚å®šæ—¶å™¨ï¼‰è§¦å‘æ—¶åœæ­¢ var takeUntilExample = numbers.TakeUntil(Observable.Timer(TimeSpan.FromSeconds(2))); takeUntilExample.Subscribe( x =\u0026gt; Console.WriteLine($\u0026#34;TakeUntil: {x}\u0026#34;), () =\u0026gt; Console.WriteLine(\u0026#34;TakeUntil Completed\u0026#34;)); // Join: åˆå¹¶ä¸¤ä¸ªåºåˆ—ï¼ˆåŸºäºæ—¶é—´çª—å£ï¼‰ var now = DateTime.Now; var source1 = Observable.Interval(TimeSpan.FromSeconds(1)).Take(3).Select(x =\u0026gt; $\u0026#34;N{x}\u0026#34;); var source2 = Observable.Interval(TimeSpan.FromSeconds(1.5)).Take(3).Select(x =\u0026gt; $\u0026#34;L{x}\u0026#34;); source1.Join( source2, _ =\u0026gt; Observable.Timer(TimeSpan.FromSeconds(2)), // å·¦ä¾§å…ƒç´ å­˜æ´»æ—¶é—´ _ =\u0026gt; Observable.Timer(TimeSpan.FromSeconds(2)), // å³ä¾§å…ƒç´ å­˜æ´»æ—¶é—´ (n, l) =\u0026gt; $\u0026#34;{n}+{l}\u0026#34; ).Subscribe(result =\u0026gt; Console.WriteLine($\u0026#34;Join Result: {result}\u0026#34;)); Console.ReadLine(); // é˜²æ­¢æ§åˆ¶å°é€€å‡º } } åº”ç”¨StartWithæ·»åŠ åˆå§‹å…ƒç´ ã€‚ ä½¿ç”¨Allæ£€æŸ¥æ¡ä»¶ã€‚ ä½¿ç”¨Containsåˆ¤æ–­æ˜¯å¦å­˜åœ¨å…ƒç´ ã€‚ ä½¿ç”¨TakeUntilåœ¨å¦ä¸€ä¸ªåºåˆ—è§¦å‘ååœæ­¢ã€‚ ä½¿ç”¨Joinåˆå¹¶ä¸¤ä¸ªåºåˆ—ã€‚ æ¯ä¸ªæ“ä½œç¬¦åè®¢é˜…ç»“æœå¹¶è¾“å‡ºã€‚ æ·»åŠ å¿…è¦çš„å¼•ç”¨æ ‡æ³¨ã€‚ StartWith: 0\nStartWith: 1\nStartWith: 2\nStartWith: 3\nStartWith: 4\nStartWith: 5\nAll \u0026gt; 0: True\nContains 3: True\nTakeUntil: 1\nTakeUntil: 2\nTakeUntil: 3\nTakeUntil: 4\nTakeUntil: 5\nTakeUntil Completed\nJoin Result: N0+L0\nJoin Result: N1+L0\nJoin Result: N0+L1\nJoin Result: N1+L1\nJoin Result: N2+L0\nJoin Result: N2+L1\nJoin Result: N2+L2\n","date":"2025-06-06T11:04:44+08:00","image":"https://www.notion.so/images/page-cover/woodcuts_6.jpg","permalink":"https://dumbnessrf.github.io/p/reactive_programing/","title":"ReactiveUI ä¸ Rx å¸¸ç”¨æ–¹æ³•æ€»ç»“"},{"content":"ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰ ğŸ“Œ æ¦‚å¿µ ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼Œç®€ç§° DIï¼‰æ˜¯ä¸€ç§å¸¸è§çš„è½¯ä»¶è®¾è®¡æ¨¡å¼ï¼Œä¸»è¦ç”¨äºè§£è€¦ç»„ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚\nåœ¨ C# å¼€å‘ä¸­ï¼Œå¦‚æœä¸ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œç±» A å¯èƒ½ä¼šåœ¨å†…éƒ¨ç›´æ¥å®ä¾‹åŒ–ç±» Bï¼Œå¯¼è‡´ä¸¤ä¸ªç±»ä¹‹é—´å½¢æˆå¼ºè€¦åˆã€‚è€Œé€šè¿‡ä¾èµ–æ³¨å…¥çš„æ–¹å¼ï¼Œå¯ä»¥å°†ç±» B çš„å®ä¾‹ä»å¤–éƒ¨ä¼ é€’ç»™ç±» Aï¼ˆé€šå¸¸é€šè¿‡æ„é€ å‡½æ•°ã€å±æ€§æˆ–æ–¹æ³•å‚æ•°ï¼‰ï¼Œä»è€Œå®ç°æ¾è€¦åˆçš„è®¾è®¡ã€‚\nâœ… ä¸»è¦ä½œç”¨ æå‡å¯ç»´æŠ¤æ€§\nå½“ç³»ç»Ÿè§„æ¨¡å˜å¤§æ—¶ï¼Œå¦‚æœå„ä¸ªç»„ä»¶ä¹‹é—´ç´§å¯†è€¦åˆï¼Œä¿®æ”¹ä¸€ä¸ªç»„ä»¶å¯èƒ½ä¼šå¼•å‘è¿é”ååº”ã€‚é€šè¿‡ä¾èµ–æ³¨å…¥ï¼Œå¯ä»¥ä½¿ä¾èµ–å…³ç³»æ›´åŠ æ¸…æ™°æ˜äº†ï¼Œä¾¿äºåæœŸç»´æŠ¤ã€‚\nç®€åŒ–å•å…ƒæµ‹è¯•\nåœ¨ç¼–å†™å•å…ƒæµ‹è¯•æ—¶ï¼Œå¯ä»¥è½»æ¾åœ°æ¨¡æ‹Ÿï¼ˆMockï¼‰ä¾èµ–å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¾èµ–çœŸå®çš„å¤æ‚å¯¹è±¡ï¼Œä½¿æµ‹è¯•æ›´ç®€å•ã€æ›´ç²¾å‡†ã€‚\nğŸ›  å¸¸ç”¨ä¾èµ–æ³¨å…¥æ¡†æ¶åŠç¤ºä¾‹ 1. Microsoft.Extensions.DependencyInjection 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 using Microsoft.Extensions.DependencyInjection; class MyClassA { private readonly MyClassB _dependency; public MyClassA(MyClassB dependency) =\u0026gt; _dependency = dependency; public void DoSomething() =\u0026gt; _dependency.SomeMethod(); } class MyClassB { public void SomeMethod() =\u0026gt; Console.WriteLine(\u0026#34;MyClassB\u0026#39;s method is called.\u0026#34;); } class Program { static void Main() { var serviceCollection = new ServiceCollection(); serviceCollection.AddTransient\u0026lt;MyClassB\u0026gt;(); serviceCollection.AddTransient\u0026lt;MyClassA\u0026gt;(); var serviceProvider = serviceCollection.BuildServiceProvider(); var a = serviceProvider.GetService\u0026lt;MyClassA\u0026gt;(); a.DoSomething(); } } 2. Autofac 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 using Autofac; class MyClassA { private readonly MyClassB _dependency; public MyClassA(MyClassB dependency) =\u0026gt; _dependency = dependency; public void DoSomething() =\u0026gt; _dependency.SomeMethod(); } class MyClassB { public void SomeMethod() =\u0026gt; Console.WriteLine(\u0026#34;MyClassB\u0026#39;s method is called.\u0026#34;); } class Program { static void Main() { var builder = new ContainerBuilder(); builder.RegisterType\u0026lt;MyClassB\u0026gt;().AsSelf(); builder.RegisterType\u0026lt;MyClassA\u0026gt;().AsSelf(); var container = builder.Build(); var a = container.Resolve\u0026lt;MyClassA\u0026gt;(); a.DoSomething(); } } ä»€ä¹ˆæ˜¯åŠ¨æ€åŠ è½½ç¨‹åºé›†ï¼ˆDynamic Assembly Loadingï¼‰ ğŸ“Œ å®šä¹‰ åœ¨ C# ä¸­ï¼ŒåŠ¨æ€åŠ è½½ç¨‹åºé›†å…è®¸ç¨‹åºåœ¨è¿è¡Œæ—¶åŠ è½½å¹¶ä½¿ç”¨ DLL æ–‡ä»¶ï¼Œè€Œä¸æ˜¯åœ¨ç¼–è¯‘æ—¶é™æ€å¼•ç”¨å®ƒä»¬ã€‚è¿™ç§æ–¹å¼æä¾›äº†æ›´é«˜çš„çµæ´»æ€§ï¼Œä¾‹å¦‚ï¼š\næ ¹æ®ä¸åŒçš„æ¡ä»¶æˆ–ç”¨æˆ·éœ€æ±‚åŠ è½½ä¸åŒçš„åŠŸèƒ½æ¨¡å—ã€‚ åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æ›´æ–°æŸäº›åŠŸèƒ½æ¨¡å—ï¼Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘æ•´ä¸ªé¡¹ç›®ã€‚ ğŸ§ª ç¤ºä¾‹ï¼šåŠ¨æ€åŠ è½½ DLL 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 using System.Reflection; class Program { static void Main() { // åŠ è½½ç¨‹åºé›† Assembly assembly = Assembly.Load(\u0026#34;xxx.dll\u0026#34;); // è·å–ç±»å‹ Type type = assembly.GetType(\u0026#34;MyNamespace.MyClass\u0026#34;); // åˆ›å»ºå®ä¾‹ object instance = Activator.CreateInstance(type); // è°ƒç”¨æ–¹æ³• MethodInfo method = type.GetMethod(\u0026#34;DoSomething\u0026#34;); method.Invoke(instance, null); } } âš ï¸ æ³¨æ„ï¼šä½¿ç”¨ Assembly.Load(\u0026quot;xxx.dll\u0026quot;) åŠ è½½çš„ç¨‹åºé›†ä¼šä¸€ç›´å ç”¨è¯¥ DLL æ–‡ä»¶ã€‚è‹¥éœ€è¦å¸è½½æˆ–æ›´æ–° DLLï¼Œå»ºè®®ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ï¼š\n1 2 byte[] rawAssembly = File.ReadAllBytes(dllPath); Assembly assembly = Assembly.Load(rawAssembly); ğŸ”„ å°†åŠ¨æ€åŠ è½½çš„ DLL æ³¨å…¥åˆ°ä¾èµ–å®¹å™¨ä¸­ï¼ˆä»¥ Autofac ä¸ºä¾‹ï¼‰ æˆ‘ä»¬ä»¥ Autofac ä½œä¸ºä¾èµ–æ³¨å…¥å®¹å™¨ï¼Œæ¼”ç¤ºå¦‚ä½•å¯¹åŠ¨æ€åŠ è½½çš„ DLL è¿›è¡ŒæœåŠ¡æ³¨å†Œä¸è§£æã€‚\næ­¥éª¤ 1ï¼šåŠ è½½ç¨‹åºé›† 1 2 byte[] rawAssembly = File.ReadAllBytes(dllPath); Assembly assembly = Assembly.Load(rawAssembly); æ­¥éª¤ 2ï¼šå®šä¹‰æ³¨å…¥ç‰¹æ€§ï¼ˆAttributeï¼‰ ä¸ºäº†ç­›é€‰éœ€è¦æ³¨å†Œçš„æœåŠ¡ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ª [Inject] ç‰¹æ€§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 [AttributeUsage(AttributeTargets.Class, AllowMultiple = false)] public class InjectAttribute(string name, string category) : Attribute { public string Name { get; } = name; public string Category { get; } = category; } public interface ITool { void DoWork(); void ShowDialog(); } // ç¤ºä¾‹ç±» [Inject(\u0026#34;å·¥å…·2\u0026#34;, \u0026#34;ç±»åˆ«1\u0026#34;)] public class MainFrame : ITool { public void DoWork() { /* å®ç°é€»è¾‘ */ } public void ShowDialog() { /* å®ç°é€»è¾‘ */ } } æ­¥éª¤ 3ï¼šæ³¨å†ŒæœåŠ¡åˆ° Autofac å®¹å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 var builder = new ContainerBuilder(); var types = assembly.DefinedTypes.ToList().Where(IsToolType).ToList(); foreach (var type in types) { var attr = type.CustomAttributes.First(a =\u0026gt; a.AttributeType == typeof(InjectAttribute)); var name = attr.ConstructorArguments[0].Value?.ToString(); var category = attr.ConstructorArguments[1].Value?.ToString(); string key = $\u0026#34;{category}_{name}\u0026#34;; builder.RegisterType(type).Named\u0026lt;ITool\u0026gt;(key); } æ­¥éª¤ 4ï¼šæ„å»ºå®¹å™¨å¹¶è§£ææœåŠ¡ 1 2 3 4 5 6 7 8 9 10 var container = builder.Build(); var tool1 = container.ResolveNamed\u0026lt;ITool\u0026gt;(\u0026#34;ç±»åˆ«1_å·¥å…·1\u0026#34;); tool1.DoWork(); var tool2 = container.ResolveNamed\u0026lt;ITool\u0026gt;(\u0026#34;ç±»åˆ«1_å·¥å…·2\u0026#34;); tool2.ShowDialog(); var tool3 = container.ResolveNamed\u0026lt;ITool\u0026gt;(\u0026#34;ç±»åˆ«2_å·¥å…·1\u0026#34;); tool3.ShowDialog(); ğŸ§© ä¾èµ–è‡ªåŠ¨è§£æèƒ½åŠ› å½“è¢«æ³¨å…¥çš„ç±»å‹å­˜åœ¨å…¶ä»–ä¾èµ–é¡¹æ—¶ï¼Œå¦‚æ—¥å¿— (ILogger) æˆ–æ•°æ®åº“ (IDatabase) æ¥å£ï¼Œä¾èµ–æ³¨å…¥å®¹å™¨ä¼šè‡ªåŠ¨å®Œæˆè¿™äº›ä¾èµ–çš„è§£æã€‚\n1 2 3 4 5 6 7 8 9 10 public interface ILogger { void Log(string message); } public interface IDatabase { List\u0026lt;string\u0026gt; Select(); void Insert\u0026lt;T\u0026gt;(T entity); } ç¤ºä¾‹ï¼šå•ä¾‹æ³¨å…¥ 1 2 builder.RegisterType\u0026lt;ConsoleLogger\u0026gt;().SingleInstance().As\u0026lt;ILogger\u0026gt;(); builder.RegisterType\u0026lt;MysqlMocker\u0026gt;().SingleInstance().As\u0026lt;IDatabase\u0026gt;(); ä½¿ç”¨ç¤ºä¾‹ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 [Inject(\u0026#34;å·¥å…·1\u0026#34;, \u0026#34;ç±»åˆ«1\u0026#34;)] public class Tool1 : ITool { private readonly ILogger _logger; private readonly IDatabase _database; public Tool1(ILogger logger, IDatabase database) { _logger = logger; _database = database; } public void DoWork() { _logger.Log(\u0026#34;This is a log message from Tool1\u0026#34;); _logger.Log(\u0026#34;Doing work in MainFrame\u0026#34;); var data = _database.Select(); var str = JsonConvert.SerializeObject(data); _logger.Log($\u0026#34;Data from database: {str}\u0026#34;); } public void ShowDialog() { } } âœ… æ€»ç»“ åŠŸèƒ½ æè¿° ä¾èµ–æ³¨å…¥ è§£è€¦ç»„ä»¶ï¼Œæå‡å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ åŠ¨æ€åŠ è½½ çµæ´»åŠ è½½ DLLï¼Œæ”¯æŒçƒ­æ’æ‹”å’Œè¿è¡Œæ—¶æ‰©å±• ç»“åˆä½¿ç”¨ å¯ä»¥å°†åŠ¨æ€åŠ è½½çš„ DLL ç±»å‹æ³¨å†Œä¸ºæœåŠ¡ï¼Œå¹¶ç”± DI å®¹å™¨ç®¡ç†å…¶ç”Ÿå‘½å‘¨æœŸå’Œä¾èµ–å…³ç³» é€šè¿‡ä¸Šè¿°æ–¹å¼ï¼Œä½ å¯ä»¥å®ç°ä¸€ä¸ªé«˜åº¦æ¨¡å—åŒ–ã€æ˜“äºæ‰©å±•å’Œç»´æŠ¤çš„ C# åº”ç”¨æ¶æ„ï¼Œé€‚ç”¨äºæ’ä»¶å¼ç³»ç»Ÿã€å¾®æœåŠ¡æ¶æ„ç­‰åœºæ™¯ã€‚\n","date":"2025-06-04T14:04:44+08:00","image":"https://www.notion.so/images/page-cover/met_william_morris_1877_willow.jpg","permalink":"https://dumbnessrf.github.io/p/dependency_injection_with_dynamic_loaded_dll.md/","title":"C#å¯¹åŠ¨æ€åŠ è½½çš„DLLä¾èµ–æ³¨å…¥"},{"content":"ğŸ§© Avalonia æ¡†æ¶æ¦‚è§ˆ ğŸ” ç®€ä»‹ Avalonia æ˜¯ä¸€ä¸ª è·¨å¹³å°çš„ .NET ç”¨æˆ·ç•Œé¢æ¡†æ¶ï¼Œæ”¯æŒä½¿ç”¨ C# å’Œ XAML æ„å»ºæ¡Œé¢ã€ç§»åŠ¨å’Œ Web åº”ç”¨ç¨‹åºã€‚å…¶è®¾è®¡çµæ„Ÿæ¥æºäº WPF å’Œ UWPï¼Œä½†å…·æœ‰æ›´å¼ºçš„è·¨å¹³å°å…¼å®¹æ€§ã€‚\nâœ… ä¸»è¦ç‰¹ç‚¹ï¼š ä½¿ç”¨ç†Ÿæ‚‰çš„ XAML è¯­æ³• æ”¯æŒå¤šç§ UI æ§ä»¶å’Œæ ·å¼ å¯è¿è¡Œäºå¤šä¸ªæ“ä½œç³»ç»Ÿ æ”¯æŒ MVVM æ¨¡å¼åŠä¾èµ–æ³¨å…¥ ğŸŒ å¹³å°æ”¯æŒ Avalonia æ”¯æŒä»¥ä¸‹å¹³å°ï¼š\nå¹³å° æ”¯æŒæƒ…å†µ Windows å®Œå…¨æ”¯æŒ Linux å®Œå…¨æ”¯æŒ macOS å®Œå…¨æ”¯æŒ Android/iOS å®éªŒæ€§æ”¯æŒï¼ˆéœ€é¢å¤–é€‚é…ï¼‰ WebAssembly æ”¯æŒï¼ˆé€šè¿‡ WASM æ¸²æŸ“å™¨ï¼‰ ğŸ’¡ Avalonia æä¾›äº†çœŸæ­£çš„è·¨å¹³å°å¼€å‘èƒ½åŠ›ï¼Œé€‚ç”¨äºéœ€è¦ç»Ÿä¸€å¤šç«¯ä½“éªŒçš„åº”ç”¨åœºæ™¯ã€‚\nâš™ï¸ æ€§èƒ½è¡¨ç° Avalonia çš„æ¸²æŸ“å¼•æ“ç»è¿‡ä¼˜åŒ–ï¼Œå…·å¤‡é«˜æ•ˆçš„ç»˜åˆ¶èƒ½åŠ›å’Œè‰¯å¥½çš„ç¡¬ä»¶åŠ é€Ÿæ”¯æŒï¼Œå°¤å…¶åœ¨å¤„ç†å¤æ‚å›¾å½¢ä¸æ•°æ®å¯è§†åŒ–æ—¶è¡¨ç°å‡ºè‰²ã€‚\né«˜æ•ˆçš„æ¸²æŸ“ç®¡é“ æ”¯æŒ GPU åŠ é€Ÿ ä½å»¶è¿Ÿå“åº”ç”¨æˆ·äº¤äº’ ä¾‹å¦‚ï¼šå½“åº”ç”¨ä¸­å­˜åœ¨å¤§é‡åŠ¨æ€å›¾è¡¨æˆ–åŠ¨ç”»å…ƒç´ æ—¶ï¼ŒAvalonia èƒ½ä¿æŒæµç•…çš„å¸§ç‡ï¼Œé¿å…å¡é¡¿ç°è±¡ã€‚\nğŸ”„ Microsoft.Extensions.DependencyInjection è¯¦è§£ ğŸ“¦ æ¦‚è¿° Microsoft.Extensions.DependencyInjection æ˜¯ .NET ä¸­çš„ä¸€ä¸ª è½»é‡çº§ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰å®¹å™¨ï¼Œå®ƒæä¾›äº†ä¸€ç§çµæ´»çš„æ–¹å¼æ¥ç®¡ç†åº”ç”¨ç¨‹åºä¸­çš„å¯¹è±¡åŠå…¶ä¾èµ–å…³ç³»ã€‚\nğŸ’¡ ä¸ºä»€ä¹ˆä½¿ç”¨ DIï¼Ÿ è§£è€¦ä¸šåŠ¡é€»è¾‘ä¸å…·ä½“å®ç° æé«˜ä»£ç å¯æµ‹è¯•æ€§å’Œå¯ç»´æŠ¤æ€§ æ”¯æŒæ¨¡å—åŒ–å¼€å‘ ğŸ•’ æœåŠ¡ç”Ÿå‘½å‘¨æœŸï¼ˆService Lifecycleï¼‰ ç”Ÿå‘½å‘¨æœŸç±»å‹ æè¿° Transientï¼ˆç¬æ€ï¼‰ æ¯æ¬¡è¯·æ±‚éƒ½ä¼šåˆ›å»ºæ–°å®ä¾‹ï¼Œé€‚åˆæ— çŠ¶æ€æœåŠ¡ Scopedï¼ˆä½œç”¨åŸŸï¼‰ åŒä¸€ä½œç”¨åŸŸå†…å…±äº«åŒä¸€ä¸ªå®ä¾‹ï¼Œå¸¸ç”¨äº Web è¯·æ±‚ä¸Šä¸‹æ–‡ Singletonï¼ˆå•ä¾‹ï¼‰ æ•´ä¸ªåº”ç”¨ç¨‹åºå‘¨æœŸå†…å…±äº«å”¯ä¸€å®ä¾‹ï¼Œé€‚åˆå…¨å±€èµ„æºç®¡ç† ç¤ºä¾‹è¯´æ˜ï¼š Transientï¼šæ¯æ¬¡è°ƒç”¨ IDataProcessor éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚ Scopedï¼šåœ¨ä¸€æ¬¡ HTTP è¯·æ±‚ä¸­ï¼Œæ‰€æœ‰å¯¹ IDatabaseContext çš„è¯·æ±‚éƒ½è¿”å›åŒä¸€ä¸ªå®ä¾‹ã€‚ Singletonï¼šå¦‚ IAppSettingsï¼Œåœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­å§‹ç»ˆä¸ºåŒä¸€å®ä¾‹ã€‚ ğŸ§ª ç¤ºä¾‹ï¼šåœ¨ Avalonia ä¸­é›†æˆä¾èµ–æ³¨å…¥ ğŸ“ä»¥ä¸‹ç¤ºä¾‹å°†æ·»åŠ Rediså’Œç¬¬ä¸‰æ–¹Avaloniaæ ·å¼åº“SukiUIä½œä¸ºå‚è€ƒ\n1ï¸âƒ£ å®‰è£…ä¾èµ–æ³¨å…¥åŒ… 1 install-package Microsoft.Extensions.DependencyInjection 2ï¸âƒ£ åˆå§‹åŒ–æœåŠ¡å®¹å™¨ åœ¨ App.xaml.cs ä¸­é‡å†™ OnFrameworkInitializationCompleted() æ–¹æ³•ä»¥æ³¨å†Œå¹¶æ„å»ºæœåŠ¡å®¹å™¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 public override void OnFrameworkInitializationCompleted() { var collection = new ServiceCollection(); collection.AddCommonServices(); collection.AddDistributedCache(); _services = collection.BuildServiceProvider(); var vm = _services.GetRequiredService\u0026lt;MainWindowViewModel\u0026gt;(); var toastService = _services.GetRequiredService\u0026lt;ISukiToastManager\u0026gt;(); var dialogService = _services.GetRequiredService\u0026lt;ISukiDialogManager\u0026gt;(); if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop) { desktop.MainWindow = _services.GetRequiredService\u0026lt;MainWindow\u0026gt;(); } else if (ApplicationLifetime is ISingleViewApplicationLifetime singleViewPlatform) { singleViewPlatform.MainView = new MainWindow(toastService, dialogService) { DataContext = vm, }; } base.OnFrameworkInitializationCompleted(); } 3ï¸âƒ£ æ³¨å†ŒæœåŠ¡ è‡ªå®šä¹‰æ‰©å±•æ–¹æ³•æ³¨å†Œå¸¸ç”¨æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 public static void AddCommonServices(this IServiceCollection collection) { collection.AddSingleton\u0026lt;MainWindowViewModel\u0026gt;(); collection.AddSingleton\u0026lt;MainWindow\u0026gt;(s =\u0026gt; new MainWindow( s.GetRequiredService\u0026lt;ISukiToastManager\u0026gt;(), s.GetRequiredService\u0026lt;ISukiDialogManager\u0026gt;() ) { DataContext = s.GetRequiredService\u0026lt;MainWindowViewModel\u0026gt;(), }); collection.AddSingleton\u0026lt;ISukiToastManager\u0026gt;(s =\u0026gt; DialogExManager.GetToastManager()); collection.AddSingleton\u0026lt;ISukiDialogManager\u0026gt;(s =\u0026gt; DialogExManager.GetDialogManager()); } æ³¨å†Œ Redis ç¼“å­˜æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 public static void AddDistributedCache(this IServiceCollection collection) { var connection = ConnectionMultiplexer.Connect(\u0026#34;127.0.0.1:6379\u0026#34;); var redis = connection.GetDatabase(); collection.AddSingleton(redis); collection.AddSingleton(connection); collection.AddSingleton\u0026lt;IDistributedCache, RedisCache\u0026gt;(s =\u0026gt; { return new RedisCache(s.GetRequiredService\u0026lt;IDatabase\u0026gt;()); }); } 4ï¸âƒ£ è¾…åŠ©ç±»ï¼šå¯¹è¯æ¡†ä¸ Toast ç®¡ç†å™¨ 1 2 3 4 5 6 7 8 public static class DialogExManager { private static readonly ISukiToastManager ToastManager = new SukiToastManager(); private static readonly ISukiDialogManager DialogManager = new SukiDialogManager(); public static ISukiToastManager GetToastManager() =\u0026gt; ToastManager; public static ISukiDialogManager GetDialogManager() =\u0026gt; DialogManager; } 5ï¸âƒ£ è§†å›¾å®šä½å™¨ï¼ˆViewLocatorï¼‰ å¦‚æœå¯ç”¨äº† ViewLocatorï¼Œåˆ™ ViewModel ä¸ View å°†è‡ªåŠ¨ç»‘å®šã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public class ViewLocator : IDataTemplate { public Control? Build(object? param) { if (param is null) return null; var name = param.GetType().FullName!.Replace(\u0026#34;ViewModel\u0026#34;, \u0026#34;View\u0026#34;, StringComparison.Ordinal); var type = Type.GetType(name); return type != null ? (Control)Activator.CreateInstance(type)! : new TextBlock { Text = \u0026#34;Not Found: \u0026#34; + name }; } public bool Match(object? data) { return data is ViewModelBase; } } ğŸ“ å¦‚æœæœªå¯ç”¨ ViewLocatorï¼Œåˆ™éœ€è¦æ‰‹åŠ¨è®¾ç½® DataContextã€‚\nâœ… æ€»ç»“ Avalonia æ˜¯ä¸€ä¸ªå¼ºå¤§çš„è·¨å¹³å° UI æ¡†æ¶ï¼Œç»“åˆ Microsoft.Extensions.DependencyInjection å¯å®ç°é«˜åº¦è§£è€¦å’Œæ¨¡å—åŒ–çš„åº”ç”¨ç¨‹åºæ¶æ„ã€‚é€šè¿‡åˆç†é…ç½®æœåŠ¡ç”Ÿå‘½å‘¨æœŸå’Œä½¿ç”¨è§†å›¾å®šä½å™¨ç­‰æœºåˆ¶ï¼Œå¯ä»¥æ˜¾è‘—æå‡å¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡ã€‚\n","date":"2025-06-04T11:04:44+08:00","image":"https://images.unsplash.com/photo-1649972904349-6e44c42644a7?ixlib=rb-4.0.3\u0026q=85\u0026fm=jpg\u0026crop=entropy\u0026cs=srgb\u0026w=3600","permalink":"https://dumbnessrf.github.io/p/dependency_injection/","title":"Avaloniaä¸­ä½¿ç”¨ä¾èµ–æ³¨å…¥é‡æ„ä»£ç "},{"content":"Converter ç±»å‹è¯¦è§£ä¸ä½¿ç”¨ç¤ºä¾‹ ç›®å½• Normal Converter IMultiValueConverter FuncValueConverter ä¸ºäº†æé«˜ Converter çš„åˆ©ç”¨ç‡ï¼Œå¯ä»¥å°†å…¶å®ä¾‹å®šä¹‰ä¸ºé™æ€èµ„æºï¼Œé¿å…é‡å¤åˆ›å»ºå®ä¾‹ã€‚ä¾‹å¦‚ï¼š\n1 2 3 4 /// \u0026lt;summary\u0026gt; /// è·å– MathAddConverter çš„é™æ€å®ä¾‹ /// \u0026lt;/summary\u0026gt; public static MathAddConverter AddConverter { get; } = new MathAddConverter(); åœ¨ XAML ä¸­è°ƒç”¨è¯¥é™æ€èµ„æºçš„æ–¹å¼å¦‚ä¸‹ï¼š\n1 2 \u0026lt;NumericUpDown Grid.Row=\u0026#34;1\u0026#34; Grid.Column=\u0026#34;1\u0026#34; Value=\u0026#34;{Binding Number1, Converter={x:Static MathAddConverter.AddConverter}, ConverterParameter={StaticResource MyConverterParameter}}\u0026#34; /\u0026gt; Normal Converter æ™®é€šå€¼è½¬æ¢å™¨ï¼ˆIValueConverterï¼‰ï¼šç”¨äºå•ä¸ªç»‘å®šå€¼çš„è½¬æ¢ï¼Œä½† ConverterParameter ä¸æ”¯æŒåŠ¨æ€ç»‘å®šã€‚\nç¤ºä¾‹ï¼šAddConverter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public class AddConverter : IValueConverter { public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture) { if (value is decimal d1 \u0026amp;\u0026amp; parameter is decimal d2) { return d1 + d2; } return null; } public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture) { if (value is decimal d1 \u0026amp;\u0026amp; parameter is decimal d2) { return d1 - d2; } return null; } } XAML èµ„æºå®šä¹‰ 1 2 3 4 \u0026lt;Window.Resources\u0026gt; \u0026lt;conv:AddConverter x:Key=\u0026#34;AddConverter\u0026#34; /\u0026gt; \u0026lt;x:Decimal x:Key=\u0026#34;inputAddValue\u0026#34;\u0026gt;2\u0026lt;/x:Decimal\u0026gt; \u0026lt;/Window.Resources\u0026gt; ä½¿ç”¨ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 \u0026lt;StackPanel Orientation=\u0026#34;Horizontal\u0026#34;\u0026gt; \u0026lt;TextBlock Classes=\u0026#34;Header\u0026#34; Text=\u0026#34;NormalConverter\u0026#34; /\u0026gt; \u0026lt;TextBlock Text=\u0026#34;Input a number to sum\u0026#34; /\u0026gt; \u0026lt;NumericUpDown Increment=\u0026#34;0.1\u0026#34; Value=\u0026#34;{Binding Number}\u0026#34; /\u0026gt; \u0026lt;TextBlock Text=\u0026#34;Sum\u0026#34; /\u0026gt; \u0026lt;NumericUpDown Value=\u0026#34;{Binding Number, Converter={StaticResource AddConverter}, ConverterParameter={StaticResource inputAddValue}}\u0026#34; /\u0026gt; \u0026lt;/StackPanel\u0026gt; IMultiValueConverter å¤šå€¼è½¬æ¢å™¨ï¼ˆIMultiValueConverterï¼‰ï¼šæ”¯æŒå¤šä¸ªç»‘å®šå€¼è¾“å…¥ï¼ŒConverterParameter æ”¯æŒç»‘å®šã€‚\nç¤ºä¾‹ï¼šMultiValueAddConverter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 public class MultiValueAddConverter : IMultiValueConverter { public object? Convert(IList\u0026lt;object?\u0026gt; values, Type targetType, object? parameter, CultureInfo culture) { if (values.Any(s =\u0026gt; s is not decimal)) { return new BindingNotification( new InvalidOperationException( \u0026#34;Not all input parameter type is decimal, this converter only support decimal type\u0026#34; ), BindingErrorType.Error ); } return values.Sum(s =\u0026gt; (decimal)s); } } ä½¿ç”¨ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u0026lt;StackPanel Orientation=\u0026#34;Horizontal\u0026#34;\u0026gt; \u0026lt;TextBlock Classes=\u0026#34;Header\u0026#34; Text=\u0026#34;MultiValueConverter\u0026#34; /\u0026gt; \u0026lt;TextBlock Text=\u0026#34;Input numbers to sum\u0026#34; /\u0026gt; \u0026lt;NumericUpDown Increment=\u0026#34;0.1\u0026#34; Value=\u0026#34;{Binding Number1}\u0026#34; /\u0026gt; \u0026lt;NumericUpDown Increment=\u0026#34;0.1\u0026#34; Value=\u0026#34;{Binding Number2}\u0026#34; /\u0026gt; \u0026lt;NumericUpDown Increment=\u0026#34;0.1\u0026#34; Value=\u0026#34;{Binding Number3}\u0026#34; /\u0026gt; \u0026lt;TextBlock Text=\u0026#34;Sum\u0026#34; /\u0026gt; \u0026lt;NumericUpDown IsReadOnly=\u0026#34;True\u0026#34;\u0026gt; \u0026lt;NumericUpDown.Value\u0026gt; \u0026lt;MultiBinding Converter=\u0026#34;{StaticResource MultiValueAddConverter}\u0026#34; Mode=\u0026#34;OneWay\u0026#34;\u0026gt; \u0026lt;Binding Path=\u0026#34;Number1\u0026#34; /\u0026gt; \u0026lt;Binding Path=\u0026#34;Number2\u0026#34; /\u0026gt; \u0026lt;Binding Path=\u0026#34;Number3\u0026#34; /\u0026gt; \u0026lt;/MultiBinding\u0026gt; \u0026lt;/NumericUpDown.Value\u0026gt; \u0026lt;/NumericUpDown\u0026gt; \u0026lt;/StackPanel\u0026gt; FuncValueConverter å‡½æ•°å¼è½¬æ¢å™¨ï¼ˆFuncValueConverterï¼‰ï¼šé€šè¿‡å§”æ‰˜æ–¹å¼å®šä¹‰è½¬æ¢é€»è¾‘ï¼Œé€‚ç”¨äºç±»å‹æ˜ç¡®ã€é€»è¾‘ç®€å•çš„åœºæ™¯ã€‚\nç¤ºä¾‹ï¼šå­—ç¬¦ä¸²è½¬ç”»åˆ· 1 2 3 4 5 6 7 8 9 10 11 12 13 public class FuncValueConverters { public static FuncValueConverter\u0026lt;string?, Brush?\u0026gt; StringToBrushFuncConverter { get; } = new(s =\u0026gt; { Color color; if (Color.TryParse(s, out color) || Color.TryParse($\u0026#34;#{s}\u0026#34;, out color)) { return new SolidColorBrush(color); } return null; }); } ä½¿ç”¨ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u0026lt;StackPanel Orientation=\u0026#34;Horizontal\u0026#34;\u0026gt; \u0026lt;TextBlock Classes=\u0026#34;Header\u0026#34; Text=\u0026#34;FuncValueConverter\u0026#34; /\u0026gt; \u0026lt;TextBox Text=\u0026#34;red\u0026#34; UseFloatingWatermark=\u0026#34;True\u0026#34; Watermark=\u0026#34;Type the color to parse (e.g.: red, green, blue, #FF112233)\u0026#34;\u0026gt; \u0026lt;TextBox.InnerLeftContent\u0026gt; \u0026lt;Ellipse Fill=\u0026#34;{Binding $parent[TextBox].Text, Converter={x:Static conv:FuncValueConverters.StringToBrushFuncConverter}}\u0026#34; Height=\u0026#34;20\u0026#34; Margin=\u0026#34;5,0,0,0\u0026#34; Stroke=\u0026#34;Gray\u0026#34; StrokeThickness=\u0026#34;1\u0026#34; Width=\u0026#34;20\u0026#34; /\u0026gt; \u0026lt;/TextBox.InnerLeftContent\u0026gt; \u0026lt;/TextBox\u0026gt; \u0026lt;/StackPanel\u0026gt; å¦‚éœ€æ‰©å±•æ›´å¤šè½¬æ¢é€»è¾‘ï¼Œå¯ä»¥ç»§ç»­æ·»åŠ æ–°çš„ Converter æˆ–ä½¿ç”¨ FuncValueConverter å¿«é€Ÿå®ç°è½»é‡çº§è½¬æ¢é€»è¾‘ã€‚\n","date":"2025-06-04T11:04:44+08:00","image":"https://www.notion.so/images/page-cover/rijksmuseum_jansz_1637.jpg","permalink":"https://dumbnessrf.github.io/p/converter-in-avalonia/","title":"Avaloniaä¸­çš„å„ç§Converterä½¿ç”¨"},{"content":"WPF ä¸­çš„ DataTemplateSelectorï¼šé«˜çº§æ•°æ®æ¨¡æ¿é€‰æ‹©æŠ€å·§ä¸åº”ç”¨ åœ¨ WPFï¼ˆWindows Presentation Foundationï¼‰å¼€å‘ä¸­ï¼ŒDataTemplate æ˜¯æˆ‘ä»¬ç”¨æ¥å®šä¹‰å¦‚ä½•æ˜¾ç¤ºç»‘å®šæ•°æ®çš„é‡è¦å·¥å…·ã€‚ç„¶è€Œï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æ ¹æ®ä¸åŒçš„æ•°æ®å¯¹è±¡åŠ¨æ€åœ°é€‰æ‹©ä¸åŒçš„ DataTemplate æ¥å‘ˆç° UIã€‚è¿™æ—¶ï¼ŒDataTemplateSelector å°±æ´¾ä¸Šç”¨åœºäº†ã€‚\næœ¬æ–‡å°†ä»‹ç»ï¼š\nä»€ä¹ˆæ˜¯ DataTemplateSelector å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ª DataTemplateSelector å®é™…åº”ç”¨åœºæ™¯å’Œä»£ç ç¤ºä¾‹ ä½¿ç”¨æŠ€å·§ä¸æœ€ä½³å®è·µ ä¸€ã€ä»€ä¹ˆæ˜¯ DataTemplateSelectorï¼Ÿ DataTemplateSelector æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒå…è®¸ä½ æ ¹æ®ç»‘å®šé¡¹çš„å†…å®¹æ¥å†³å®šä½¿ç”¨å“ªä¸ª DataTemplateã€‚ä½ å¯ä»¥ç»§æ‰¿è¿™ä¸ªç±»å¹¶é‡å†™å®ƒçš„ SelectTemplate æ–¹æ³•ï¼Œä»è€Œå®ç°è‡ªå®šä¹‰çš„æ¨¡æ¿é€‰æ‹©é€»è¾‘ã€‚\näºŒã€å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ª DataTemplateSelectorï¼Ÿ æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚\nç¤ºä¾‹åœºæ™¯ï¼šèŠå¤©æ¶ˆæ¯åˆ—è¡¨ å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªèŠå¤©ç¨‹åºï¼Œæ¯æ¡æ¶ˆæ¯å¯èƒ½æ˜¯ç”¨æˆ·å‘é€çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯ç³»ç»Ÿè‡ªåŠ¨å‘é€çš„ã€‚æˆ‘ä»¬æƒ³å¯¹è¿™ä¸¤ç§æ¶ˆæ¯åº”ç”¨ä¸åŒçš„æ ·å¼ã€‚\n1. å®šä¹‰æ•°æ®æ¨¡å‹ 1 2 3 4 5 6 7 8 9 10 11 public class Message { public string Content { get; set; } public MessageType Type { get; set; } } public enum MessageType { User, System } 2. åˆ›å»ºä¸¤ä¸ªä¸åŒçš„ DataTemplate åœ¨ XAML ä¸­å®šä¹‰ä¸¤ç§ä¸åŒé£æ ¼çš„æ¶ˆæ¯æ¨¡æ¿ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026lt;Window.Resources\u0026gt; \u0026lt;!-- ç”¨æˆ·æ¶ˆæ¯æ¨¡æ¿ --\u0026gt; \u0026lt;DataTemplate x:Key=\u0026#34;UserMessageTemplate\u0026#34;\u0026gt; \u0026lt;Border Background=\u0026#34;LightBlue\u0026#34; Padding=\u0026#34;10\u0026#34; Margin=\u0026#34;5\u0026#34;\u0026gt; \u0026lt;TextBlock Text=\u0026#34;{Binding Content}\u0026#34; /\u0026gt; \u0026lt;/Border\u0026gt; \u0026lt;/DataTemplate\u0026gt; \u0026lt;!-- ç³»ç»Ÿæ¶ˆæ¯æ¨¡æ¿ --\u0026gt; \u0026lt;DataTemplate x:Key=\u0026#34;SystemMessageTemplate\u0026#34;\u0026gt; \u0026lt;Border Background=\u0026#34;LightGray\u0026#34; Padding=\u0026#34;10\u0026#34; Margin=\u0026#34;5\u0026#34;\u0026gt; \u0026lt;TextBlock Text=\u0026#34;{Binding Content}\u0026#34; FontStyle=\u0026#34;Italic\u0026#34;/\u0026gt; \u0026lt;/Border\u0026gt; \u0026lt;/DataTemplate\u0026gt; \u0026lt;/Window.Resources\u0026gt; 3. è‡ªå®šä¹‰ DataTemplateSelector 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public class MessageTemplateSelector : DataTemplateSelector { public DataTemplate UserMessageTemplate { get; set; } public DataTemplate SystemMessageTemplate { get; set; } public override DataTemplate SelectTemplate(object item, DependencyObject container) { if (item is Message message) { switch (message.Type) { case MessageType.User: return UserMessageTemplate; case MessageType.System: return SystemMessageTemplate; } } return base.SelectTemplate(item, container); } } 4. åœ¨ XAML ä¸­æ³¨å†Œå¹¶ä½¿ç”¨ TemplateSelector 1 2 3 4 5 6 7 8 \u0026lt;Window.Resources\u0026gt; \u0026lt;local:MessageTemplateSelector x:Key=\u0026#34;messageTemplateSelector\u0026#34; UserMessageTemplate=\u0026#34;{StaticResource UserMessageTemplate}\u0026#34; SystemMessageTemplate=\u0026#34;{StaticResource SystemMessageTemplate}\u0026#34; /\u0026gt; \u0026lt;/Window.Resources\u0026gt; \u0026lt;ListBox ItemsSource=\u0026#34;{Binding Messages}\u0026#34; ItemTemplateSelector=\u0026#34;{StaticResource messageTemplateSelector}\u0026#34; /\u0026gt; æ³¨æ„ï¼šlocal éœ€è¦å¼•ç”¨ä½ çš„å‘½åç©ºé—´ï¼Œä¾‹å¦‚ï¼š\n1 2 \u0026lt;Window xmlns:local=\u0026#34;clr-namespace:YourNamespace\u0026#34; ... ä¸‰ã€åº”ç”¨åœºæ™¯ä¸¾ä¾‹ åœºæ™¯ 1ï¼šå¤šç±»å‹åˆ—è¡¨å±•ç¤ºï¼ˆå¦‚æ–°é—»ã€é€šçŸ¥ã€è®¢å•ç­‰æ··åˆå±•ç¤ºï¼‰ ä½ å¯ä»¥ä¸ºä¸åŒç±»å‹çš„æ•°æ®é¡¹é€‰æ‹©ä¸åŒçš„æ¨¡æ¿ï¼Œä½¿å¾—åŒä¸€ä¸ªåˆ—è¡¨ä¸­èƒ½å±•ç¤ºå¤šç§ç»“æ„ä¸åŒçš„ä¿¡æ¯ã€‚\nåœºæ™¯ 2ï¼šUI ä¸»é¢˜æˆ–çŠ¶æ€å˜åŒ– æ ¹æ®å¯¹è±¡çš„çŠ¶æ€ï¼ˆå¦‚â€œå·²è¯»â€ã€â€œæœªè¯»â€ã€â€œé”™è¯¯â€ç­‰ï¼‰åˆ‡æ¢ä¸åŒçš„ UI æ ·å¼ã€‚\nåœºæ™¯ 3ï¼šä¸ªæ€§åŒ–å†…å®¹å±•ç¤º æ¯”å¦‚åœ¨ä¸€ä¸ªè®ºå›åº”ç”¨ä¸­ï¼Œå¸–å­ä½œè€…ã€ç®¡ç†å‘˜ã€æ™®é€šç”¨æˆ·çš„å‘è¨€éœ€è¦ä¸åŒé¢œè‰²æˆ–å›¾æ ‡æ ‡è¯†ã€‚\nå››ã€ä½¿ç”¨æŠ€å·§ä¸æœ€ä½³å®è·µ âœ… æŠ€å·§ 1ï¼šä¿æŒ TemplateSelector çš„å¯å¤ç”¨æ€§ ç›®æ ‡ï¼š è®¾è®¡ä¸€ä¸ªé€šç”¨çš„ DataTemplateSelectorï¼Œå¯ä»¥é€šè¿‡ä¾èµ–å±æ€§ä¼ å…¥æ¨¡æ¿ï¼Œæé«˜ç»„ä»¶å¤ç”¨æ€§ã€‚\nå®ç°ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public class ReusableTemplateSelector : DataTemplateSelector { public DataTemplate DefaultTemplate { get; set; } public DataTemplate AlternateTemplate { get; set; } public override DataTemplate SelectTemplate(object item, DependencyObject container) { if (item is ICustomType customItem \u0026amp;\u0026amp; customItem.IsSpecial) { return AlternateTemplate; } return DefaultTemplate ?? base.SelectTemplate(item, container); } } // æ¥å£ç”¨äºåˆ¤æ–­æ˜¯å¦æ˜¯â€œç‰¹æ®Šç±»å‹â€ public interface ICustomType { bool IsSpecial { get; } } ä½¿ç”¨ XAMLï¼š 1 2 3 \u0026lt;local:ReusableTemplateSelector x:Key=\u0026#34;reusableSelector\u0026#34; DefaultTemplate=\u0026#34;{StaticResource NormalTemplate}\u0026#34; AlternateTemplate=\u0026#34;{StaticResource SpecialTemplate}\u0026#34; /\u0026gt; åº”ç”¨åœºæ™¯ï¼š å¤šä¸ªé¡µé¢ä¸­é‡å¤ä½¿ç”¨åŒä¸€ä¸ªé€‰æ‹©å™¨ã€‚ ä¸åŒä¸šåŠ¡é€»è¾‘ä¸‹åªéœ€æ›´æ¢ç»‘å®šçš„ DataTemplateã€‚ âœ… æŠ€å·§ 2ï¼šç»“åˆ MVVM æ¨¡å¼ä½¿ç”¨ ç›®æ ‡ï¼š åœ¨ MVVM æ¶æ„ä¸­ä½¿ç”¨ DataTemplateSelectorï¼Œå°† UI å±•ç¤ºä¸æ•°æ®åˆ†ç¦»ã€‚\nå®ç°ï¼š ViewModel ç¤ºä¾‹ï¼š 1 2 3 4 5 6 7 8 9 10 11 public class MessageViewModel : INotifyPropertyChanged { public string Content { get; set; } public MessageType Type { get; set; } // User / System } public enum MessageType { User, System } è‡ªå®šä¹‰ Selectorï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 public class MessageTypeSelector : DataTemplateSelector { public DataTemplate UserTemplate { get; set; } public DataTemplate SystemTemplate { get; set; } public override DataTemplate SelectTemplate(object item, DependencyObject container) { if (item is MessageViewModel msg) { return msg.Type == MessageType.User ? UserTemplate : SystemTemplate; } return base.SelectTemplate(item, container); } } XAML ä¸­ç»‘å®šï¼š 1 2 \u0026lt;ListBox ItemsSource=\u0026#34;{Binding Messages}\u0026#34; ItemTemplateSelector=\u0026#34;{StaticResource messageTypeSelector}\u0026#34; /\u0026gt; ä¼˜åŠ¿ï¼š å®Œå…¨è§£è€¦ View å’Œ ViewModelã€‚ æ˜“äºç»´æŠ¤å’Œæµ‹è¯•ã€‚ âœ… æŠ€å·§ 3ï¼šé¿å…è¿‡åº¦å¤æ‚çš„é€»è¾‘ ç›®æ ‡ï¼š ç¡®ä¿ SelectTemplate æ–¹æ³•é€»è¾‘ç®€æ´ï¼Œä¸åµŒå¥—å¤æ‚åˆ¤æ–­ã€‚\nåé¢ä¾‹å­ï¼ˆä¸æ¨èï¼‰ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public override DataTemplate SelectTemplate(...) { if (item is Order o) { if (o.Status == \u0026#34;Pending\u0026#34;) { if (o.CustomerLevel == \u0026#34;VIP\u0026#34;) return VipPendingTemplate; else return PendingTemplate; } else if (o.Status == \u0026#34;Completed\u0026#34;) { ... } } } æ”¹è¿›æ–¹å¼ï¼š ä½¿ç”¨ç­–ç•¥æ¨¡å¼æˆ–çŠ¶æ€æšä¸¾æ˜ å°„ 1 2 3 4 5 6 7 8 9 10 11 12 13 public class OrderTemplateSelector : DataTemplateSelector { public Dictionary\u0026lt;OrderState, DataTemplate\u0026gt; Templates { get; } = new(); public override DataTemplate SelectTemplate(object item, DependencyObject container) { if (item is Order order) { return Templates.GetValueOrDefault(order.State); } return base.SelectTemplate(item, container); } } XAML é…ç½®ï¼š 1 2 3 4 5 6 \u0026lt;local:OrderTemplateSelector x:Key=\u0026#34;orderSelector\u0026#34;\u0026gt; \u0026lt;local:OrderTemplateSelector.Templates\u0026gt; \u0026lt;Component:TemplateMapEntry Key=\u0026#34;Pending\u0026#34; Value=\u0026#34;{StaticResource PendingTemplate}\u0026#34; /\u0026gt; \u0026lt;Component:TemplateMapEntry Key=\u0026#34;Completed\u0026#34; Value=\u0026#34;{StaticResource CompletedTemplate}\u0026#34; /\u0026gt; \u0026lt;/local:OrderTemplateSelector.Templates\u0026gt; \u0026lt;/local:OrderTemplateSelector\u0026gt; ğŸ’¡ æ³¨ï¼šä½ å¯ä»¥è‡ªå®šä¹‰ TemplateMapEntry ç±»å‹æ¥æ”¯æŒè¿™ç§å­—å…¸ç»“æ„ã€‚\nâœ… æŠ€å·§ 4ï¼šè°ƒè¯•æ—¶æ³¨æ„ Binding ä¸Šä¸‹æ–‡é—®é¢˜ å¸¸è§é”™è¯¯ï¼š åœ¨ SelectTemplate ä¸­è·å–ä¸åˆ°æ­£ç¡®å¯¹è±¡ã€‚ ç»‘å®šè·¯å¾„é”™è¯¯å¯¼è‡´æ— æ³•è¯†åˆ«ç±»å‹ã€‚ è§£å†³æ–¹æ³•ï¼š ç¡®ä¿ç»‘å®šä¸Šä¸‹æ–‡æ­£ç¡® 1 2 \u0026lt;ListBox ItemsSource=\u0026#34;{Binding MyItems}\u0026#34; ItemTemplateSelector=\u0026#34;{StaticResource mySelector}\u0026#34; /\u0026gt; ç¡®ä¿ MyItems æ˜¯ IEnumerable\u0026lt;T\u0026gt;ï¼Œä¸”æ¯ä¸€é¡¹ç±»å‹éƒ½èƒ½è¢«è¯†åˆ«ã€‚\næ·»åŠ æ—¥å¿—è¾…åŠ©è°ƒè¯•ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public override DataTemplate SelectTemplate(object item, DependencyObject container) { if (item == null) { Debug.WriteLine(\u0026#34;Item is null\u0026#34;); return base.SelectTemplate(item, container); } Debug.WriteLine($\u0026#34;Item type: {item.GetType().Name}\u0026#34;); if (item is CustomType ct) { return ct.IsSpecial ? SpecialTemplate : NormalTemplate; } return base.SelectTemplate(item, container); } äº”ã€æ€»ç»“ DataTemplateSelector æ˜¯ WPF ä¸­éå¸¸å¼ºå¤§ä¸”çµæ´»çš„åŠŸèƒ½ï¼Œå®ƒå¸®åŠ©æˆ‘ä»¬å®ç°äº†æ•°æ®é©±åŠ¨çš„ UI æ¨¡æ¿é€‰æ‹©ã€‚æ— è®ºæ˜¯æ„å»ºå¤æ‚çš„ UI åˆ—è¡¨è¿˜æ˜¯å®ç°é«˜åº¦å®šåˆ¶åŒ–çš„å±•ç¤ºé€»è¾‘ï¼ŒDataTemplateSelector éƒ½æ˜¯ä¸€ä¸ªå€¼å¾—æŒæ¡çš„æŠ€èƒ½ã€‚\n","date":"2025-05-30T14:46:48+08:00","image":"https://www.notion.so/images/page-cover/nasa_new_york_city_grid.jpg","permalink":"https://dumbnessrf.github.io/p/data-template-selector-tips/","title":"WPFæŠ€å·§-æ•°æ®æ¨¡æ¿åŠ¨æ€é€‰æ‹©"},{"content":"è§£é”.NET æ–°å§¿åŠ¿ï¼šåŸºäºæ–‡ä»¶çš„ç¨‹åºç‰¹æ€§æ·±åº¦è§£æä¸å®æˆ˜ åœ¨.NET çš„ä¸–ç•Œé‡Œï¼Œæ–°é¡¹ç›®çš„åˆ›å»ºå’Œè¿è¡Œå¾€å¾€ç¦»ä¸å¼€.csprojé¡¹ç›®æ–‡ä»¶ï¼Œä»ç¼–å†™ä»£ç åˆ°è°ƒè¯•è¿è¡Œï¼Œéœ€è¦ä¸€ç³»åˆ—ç¹ççš„æ­¥éª¤ã€‚ä½†éšç€.NET æŠ€æœ¯çš„ä¸æ–­æ¼”è¿›ï¼ŒåŸºäºæ–‡ä»¶çš„ç¨‹åºï¼ˆFile-based programsï¼‰ è¿™ä¸€æ–°ç‰¹æ€§çš„å‡ºç°ï¼Œæ‰“ç ´äº†è¿™ä¸€ä¼ ç»Ÿæ¨¡å¼ï¼Œä¸ºå¼€å‘è€…å¸¦æ¥äº†æ›´åŠ ä¾¿æ·ã€é«˜æ•ˆçš„å¼€å‘ä½“éªŒã€‚\nåŸºäºæ–‡ä»¶çš„ç¨‹åºç‰¹æ€§æ¦‚è¿° åŸºäºæ–‡ä»¶çš„ç¨‹åºï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯å°†éƒ¨åˆ† MSBuild é¡¹ç›®åŠŸèƒ½åµŒå…¥åˆ° C# ä»£ç ä¸­ï¼Œå…è®¸å¼€å‘è€…ç›´æ¥è¿è¡Œå•ä¸ª C# æ–‡ä»¶ï¼Œå°±åƒè¿è¡Œä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®ä¸€æ ·ã€‚åœ¨ä»¥å¾€ï¼Œè¿è¡Œ C# ä»£ç é€šå¸¸éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œç¼–å†™ .csproj æ–‡ä»¶æ¥é…ç½®é¡¹ç›®çš„å„ç§å±æ€§ï¼Œå¦‚å¼•ç”¨çš„åŒ…ã€ç›®æ ‡æ¡†æ¶ç­‰ã€‚è€ŒåŸºäºæ–‡ä»¶çš„ç¨‹åºåˆ™æ— éœ€è¿™äº›å¤æ‚çš„æ“ä½œï¼Œå®ƒé€šè¿‡åœ¨ C# æºæ–‡ä»¶ä¸­æ·»åŠ ç‰¹æ®Šçš„ #: æŒ‡ä»¤ï¼Œåœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ª â€œè™šæ‹Ÿé¡¹ç›®â€ï¼Œç„¶åå°†è¿™ä¸ª â€œè™šæ‹Ÿé¡¹ç›®â€ ä¼ é€’ç»™ MSBuild è¿›è¡Œæ„å»ºå’Œè¿è¡Œã€‚\nå…¶èƒŒåçš„è¿è¡Œæœºåˆ¶æ˜¯ï¼šå½“ä½¿ç”¨ dotnet run å‘½ä»¤è¿è¡Œä¸€ä¸ª C# æ–‡ä»¶æ—¶ï¼Œå‘½ä»¤è¡Œä¼šè§£ææºæ–‡ä»¶ä¸­çš„ #: æŒ‡ä»¤ï¼Œæ ¹æ®è¿™äº›æŒ‡ä»¤åœ¨å†…å­˜ä¸­æ„å»ºä¸€ä¸ª C# é¡¹ç›® XML æ–‡æ¡£ï¼Œè¿™ä¸ªæ–‡æ¡£å°±ç›¸å½“äºä¸€ä¸ªå¸¸è§„é¡¹ç›®çš„ .csproj æ–‡ä»¶ã€‚éšåï¼ŒMSBuild ä¼šåŸºäºè¿™ä¸ªå†…å­˜ä¸­çš„é¡¹ç›®æ–‡æ¡£è¿›è¡Œç¼–è¯‘å’Œè¿è¡Œï¼Œä½¿å¾—å•ä¸ªæ–‡ä»¶èƒ½å¤Ÿåƒå®Œæ•´é¡¹ç›®ä¸€æ ·æ‰§è¡Œ ã€‚\nåº”ç”¨ç¤ºä¾‹è¯¦è§£ ç¤ºä¾‹ 1ï¼šç»å…¸ Hello World 1 2 3 // HelloWorld.cs #:r \u0026#34;System.Net.Http\u0026#34; Console.WriteLine(\u0026#34;Hello, World!\u0026#34;); åœ¨è¿™ä¸ªç®€å•ç¤ºä¾‹ä¸­ï¼Œ#:r \u0026quot;System.Net.Http\u0026quot; æ˜¯ä¸€ä¸ª #: æŒ‡ä»¤ï¼Œå®ƒç”¨äºå¼•ç”¨ System.Net.Http ç¨‹åºé›†ã€‚è™½ç„¶ä»£ç ä¸­æ²¡æœ‰ä¼ ç»Ÿçš„é¡¹ç›®æ–‡ä»¶é…ç½®ï¼Œä½†é€šè¿‡è¿™æ¡æŒ‡ä»¤ï¼Œæˆ‘ä»¬ä¸ºç¨‹åºæ·»åŠ äº†æ‰€éœ€çš„å¼•ç”¨ã€‚åœ¨å‘½ä»¤è¡Œä¸­è¿›å…¥è¯¥æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œæ‰§è¡Œ dotnet run HelloWorld.csï¼Œå°±èƒ½çœ‹åˆ°ç†Ÿæ‚‰çš„ â€œHello, World!â€ è¾“å‡ºã€‚è¿™å±•ç¤ºäº†åŸºäºæ–‡ä»¶çš„ç¨‹åºæœ€åŸºç¡€çš„è¿è¡Œæ–¹å¼ï¼Œä»…éœ€ä¸€ä¸ª C# æ–‡ä»¶å’Œç®€å•æŒ‡ä»¤ï¼Œå³å¯å¿«é€Ÿè¿è¡Œä»£ç ã€‚\nç¤ºä¾‹ 2ï¼šå¼•ç”¨å¤–éƒ¨ NuGet åŒ… 1 2 3 4 5 6 7 8 9 10 11 12 13 // NewtonsoftJsonExample.cs #:package Newtonsoft.Json 13.0.1 using Newtonsoft.Json; class Program { static void Main() { var person = new { Name = \u0026#34;Alice\u0026#34;, Age = 30 }; var json = JsonConvert.SerializeObject(person); Console.WriteLine(json); } } åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ#:package Newtonsoft.Json 13.0.1 æŒ‡ä»¤ç”¨äºå¼•å…¥ Newtonsoft.Json åŒ…åŠå…¶æŒ‡å®šç‰ˆæœ¬ã€‚å¼•å…¥åï¼Œä»£ç ä¸­å°±èƒ½ä½¿ç”¨ Newtonsoft.Json æä¾›çš„åŠŸèƒ½ï¼Œå¦‚å°†å¯¹è±¡åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²ã€‚è¿è¡Œæ—¶ï¼Œdotnet run å‘½ä»¤ä¼šæ ¹æ®è¯¥æŒ‡ä»¤è‡ªåŠ¨ä¸‹è½½å¹¶å¼•ç”¨æ‰€éœ€çš„ NuGet åŒ…ï¼Œæ— éœ€æ‰‹åŠ¨åœ¨é¡¹ç›®æ–‡ä»¶ä¸­æ·»åŠ åŒ…å¼•ç”¨ï¼Œæå¤§åœ°ç®€åŒ–äº†ä½¿ç”¨å¤–éƒ¨åŒ…çš„æµç¨‹ ã€‚\nç¤ºä¾‹ 3ï¼šå¤šæ–‡ä»¶åä½œ å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„æ•°å­¦è®¡ç®—é¡¹ç›®ï¼ŒåŒ…å«ä¸¤ä¸ªæ–‡ä»¶ï¼šCalculator.cs å’Œ Program.csã€‚\nCalculator.cs æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 // Calculator.cs namespace MathUtils { public static class Calculator { public static int Add(int a, int b) { return a + b; } } } Program.cs æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 // Program.cs #:r \u0026#34;System.Net.Http\u0026#34; using MathUtils; class Program { static void Main() { int result = Calculator.Add(5, 3); Console.WriteLine($\u0026#34;The result of addition is: {result}\u0026#34;); } } åœ¨åŸºäºæ–‡ä»¶çš„ç¨‹åºä¸­ï¼Œæ— éœ€æ‰‹åŠ¨åœ¨é¡¹ç›®æ–‡ä»¶ä¸­é…ç½®æ–‡ä»¶å¼•ç”¨å…³ç³»ã€‚å½“ä½¿ç”¨ dotnet run Program.cs å‘½ä»¤è¿è¡Œæ—¶ï¼ŒSDK CLI ä¼šè‡ªåŠ¨è§£æ Program.cs æ‰€åœ¨ç›®å½•æ ‘ä¸­çš„æ‰€æœ‰ .cs æ–‡ä»¶ï¼Œå°† Calculator.cs åŒ…å«åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œä½¿å¾—ä¸åŒæ–‡ä»¶ä¹‹é—´èƒ½å¤Ÿé¡ºåˆ©åä½œï¼Œå®ç°å¤æ‚çš„åŠŸèƒ½ ã€‚\nä¸ä¼ ç»Ÿé¡¹ç›®æ¨¡å¼çš„å¯¹æ¯”ä¼˜åŠ¿ é™ä½å…¥é—¨é—¨æ§›\nå¯¹äºåˆå­¦è€…æ¥è¯´ï¼Œä¼ ç»Ÿçš„ .csproj é¡¹ç›®æ–‡ä»¶é…ç½®å¤æ‚ï¼ŒåŒ…å«ä¼—å¤šå±æ€§å’ŒèŠ‚ç‚¹ï¼Œå®¹æ˜“è®©æ–°æ‰‹æ„Ÿåˆ°å›°æƒ‘ã€‚è€ŒåŸºäºæ–‡ä»¶çš„ç¨‹åºæ¨¡å¼ï¼Œåªéœ€å…³æ³¨ä»£ç æœ¬èº«å’Œç®€å•çš„ #: æŒ‡ä»¤ï¼Œæ— éœ€æ·±å…¥äº†è§£é¡¹ç›®æ–‡ä»¶é…ç½®ï¼Œèƒ½å¤Ÿæ›´å¿«åœ°ç¼–å†™å’Œè¿è¡Œä»£ç ï¼Œé™ä½äº†å­¦ä¹ æˆæœ¬ã€‚\nå¿«é€ŸåŸå‹å¼€å‘\nåœ¨å¼€å‘åˆæœŸè¿›è¡ŒåŸå‹è®¾è®¡æ—¶ï¼Œå¾€å¾€éœ€è¦å¿«é€ŸéªŒè¯æƒ³æ³•å’ŒåŠŸèƒ½ã€‚åŸºäºæ–‡ä»¶çš„ç¨‹åºæ— éœ€åˆ›å»ºå®Œæ•´é¡¹ç›®ç»“æ„ï¼Œç›´æ¥ç¼–å†™å•ä¸ªæ–‡ä»¶å¹¶è¿è¡Œï¼Œèƒ½å¤Ÿå¤§å¤§æé«˜å¼€å‘æ•ˆç‡ï¼Œå¿«é€Ÿè¿­ä»£åŸå‹ã€‚\nç®€åŒ–å°å‹å·¥å…·å¼€å‘\nå¯¹äºä¸€äº›ç®€å•çš„å°å‹å·¥å…·æˆ–è„šæœ¬ï¼Œä½¿ç”¨ä¼ ç»Ÿé¡¹ç›®æ¨¡å¼æ˜¾å¾—è¿‡äºç¹çã€‚åŸºäºæ–‡ä»¶çš„ç¨‹åºå¯ä»¥ç”¨æœ€å°‘çš„é…ç½®å’Œæ­¥éª¤å®ç°åŠŸèƒ½ï¼Œä½¿ä»£ç æ›´åŠ ç®€æ´ã€è½»ä¾¿ï¼Œä¾¿äºç»´æŠ¤å’Œç®¡ç†ã€‚\nä½¿ç”¨æ³¨æ„äº‹é¡¹ è™½ç„¶åŸºäºæ–‡ä»¶çš„ç¨‹åºå¸¦æ¥äº†è¯¸å¤šä¾¿åˆ©ï¼Œä½†åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¹Ÿæœ‰ä¸€äº›éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š\nç›®å‰åŸºäºæ–‡ä»¶çš„ç¨‹åºåœ¨åŠŸèƒ½ä¸Šè¿˜å­˜åœ¨ä¸€å®šé™åˆ¶ï¼Œä¾‹å¦‚å¯¹æŸäº›å¤æ‚çš„é¡¹ç›®é…ç½®å’Œæ„å»ºè‡ªå®šä¹‰æ”¯æŒä¸å¤Ÿå®Œå–„ã€‚ ç”±äºå…¶ä¾èµ–äº #: æŒ‡ä»¤æ¥é…ç½®é¡¹ç›®å±æ€§ï¼ŒæŒ‡ä»¤çš„è¯­æ³•å’Œä½¿ç”¨è§„åˆ™éœ€è¦å¼€å‘è€…ç†Ÿç»ƒæŒæ¡ï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°å¼•ç”¨é”™è¯¯æˆ–æ„å»ºå¤±è´¥ç­‰é—®é¢˜ã€‚ åœ¨å›¢é˜Ÿåä½œå¼€å‘ä¸­ï¼ŒåŸºäºæ–‡ä»¶çš„ç¨‹åºå¯èƒ½ä¼šå› ä¸ºæˆå‘˜ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ .NET SDK è€Œå¯¼è‡´è¿è¡Œç»“æœä¸ä¸€è‡´ï¼Œéœ€è¦ç»Ÿä¸€å¼€å‘ç¯å¢ƒã€‚ ä»¥ä¸Šå°±æ˜¯å¯¹ .NET åŸºäºæ–‡ä»¶çš„ç¨‹åºç‰¹æ€§çš„è¯¦ç»†ä»‹ç»å’Œåº”ç”¨ç¤ºä¾‹ã€‚è¿™ä¸€ç‰¹æ€§ä¸ºå¼€å‘è€…æä¾›äº†æ›´çµæ´»é«˜æ•ˆçš„å¼€å‘æ–¹å¼ï¼Œæ— è®ºæ˜¯åˆå­¦è€…å¿«é€Ÿä¸Šæ‰‹ï¼Œè¿˜æ˜¯ç»éªŒä¸°å¯Œçš„å¼€å‘è€…è¿›è¡Œå¿«é€Ÿå¼€å‘ï¼Œéƒ½èƒ½å‘æŒ¥é‡è¦ä½œç”¨ã€‚ä¸å¦¨äº²è‡ªå°è¯•ï¼Œæ„Ÿå—å®ƒå¸¦æ¥çš„ä¾¿æ·ï¼å¦‚æœä½ åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æœ‰æ–°çš„å‘ç°æˆ–é‡åˆ°é—®é¢˜ï¼Œæ¬¢è¿ä¸€èµ·äº¤æµæ¢è®¨ã€‚\n","date":"2025-05-29T11:04:44+08:00","image":"https://www.notion.so/images/page-cover/rijksmuseum_mignons_1660.jpg","permalink":"https://dumbnessrf.github.io/p/single-file-run/","title":"å•æ–‡ä»¶è¿è¡ŒC#ä»£ç "}]